---
title: 15. Proxy
---
## ç”¨Proxyè¿›è¡Œé¢„å¤„ç†
ä»€ä¹ˆæ˜¯é’©å­å‡½æ•°ï¼Ÿå½“æˆ‘ä»¬åœ¨æ“ä½œä¸€ä¸ªå¯¹è±¡æˆ–è€…æ–¹æ³•æ—¶ä¼šæœ‰å‡ ç§åŠ¨ä½œï¼Œæ¯”å¦‚ï¼šåœ¨è¿è¡Œå‡½æ•°å‰åˆå§‹åŒ–ä¸€äº›æ•°æ®ï¼Œåœ¨æ”¹å˜å¯¹è±¡å€¼ååšä¸€äº›å–„åå¤„ç†ã€‚è¿™äº›éƒ½ç®—é’©å­å‡½æ•°ï¼ŒProxyçš„å­˜åœ¨å°±å¯ä»¥è®©æˆ‘ä»¬ç»™å‡½æ•°åŠ ä¸Šè¿™æ ·çš„é’©å­å‡½æ•°ï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£ä¸ºåœ¨æ‰§è¡Œæ–¹æ³•å‰é¢„å¤„ç†ä¸€äº›ä»£ç ã€‚ä½ å¯ä»¥ç®€å•çš„ç†è§£ä¸ºä»–æ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚

## æ¦‚è¿°
Proxy ç”¨äºä¿®æ”¹æŸäº›æ“ä½œçš„é»˜è®¤è¡Œä¸ºï¼Œç­‰åŒäºåœ¨è¯­è¨€å±‚é¢åšå‡ºä¿®æ”¹ï¼Œæ‰€ä»¥å±äºä¸€ç§`å…ƒç¼–ç¨‹`ï¼ˆmeta programmingï¼‰ï¼Œå³å¯¹ç¼–ç¨‹è¯­è¨€è¿›è¡Œç¼–ç¨‹ã€‚

Proxyå¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚æ‹¦æˆªï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚Proxy è¿™ä¸ªè¯çš„åŸæ„æ˜¯ä»£ç†ï¼Œç”¨åœ¨è¿™é‡Œè¡¨ç¤ºç”±å®ƒæ¥â€œä»£ç†â€æŸäº›æ“ä½œï¼Œå¯ä»¥è¯‘ä¸º`ä»£ç†å™¨`ã€‚

ES6åŸç”Ÿæä¾›Proxyæ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”ŸæˆProxyå®ä¾‹ã€‚
```js
const proxy = new Proxy(target, handler);
```
Proxyå¯¹è±¡çš„æ‰€æœ‰ç”¨æ³•ï¼Œéƒ½æ˜¯ä¸Šé¢è¿™ç§å½¢å¼ï¼Œä¸åŒçš„åªæ˜¯`handler`å‚æ•°çš„å†™æ³•ã€‚å…¶ä¸­ï¼Œnew Proxy()è¡¨ç¤ºç”Ÿæˆä¸€ä¸ªProxyå®ä¾‹ï¼Œ**targetå‚æ•°è¡¨ç¤ºæ‰€è¦æ‹¦æˆªçš„ç›®æ ‡å¯¹è±¡**ï¼Œhandlerå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥å®šåˆ¶æ‹¦æˆªè¡Œä¸ºã€‚

## Proxyæ‹¦æˆªæ“ä½œ
### get(target, propKey, receiver(å¯é€‰å‚æ•°))
getæ–¹æ³•ç”¨äºï¼šæ‹¦æˆªå¯¹è±¡æŸä¸ªå±æ€§çš„è¯»å–æ“ä½œï¼Œå¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œä¾æ¬¡ä¸ºç›®æ ‡å¯¹è±¡ã€å±æ€§åå’Œproxyå®ä¾‹æœ¬èº«ï¼ˆä¸¥æ ¼åœ°è¯´ï¼Œæ˜¯æ“ä½œè¡Œä¸ºæ‰€é’ˆå¯¹çš„å¯¹è±¡ï¼‰ï¼Œå…¶ä¸­æœ€åä¸€ä¸ªå‚æ•°å¯é€‰ã€‚

```js
const handler = {
    // å¯¹è®¾ç½®å±æ€§è¿›è¡Œæ‹¦æˆª
    set: function(target, key, value, receiver) {
        if (key === 'name') {
            target[key] = receiver;
        } else {
            target[key] = value;
        }
    }
}

const proxy = new Proxy({}, handler);
const obj = {};
Object.setPrototypeOf(obj, proxy);

obj.name = 'lisi';
obj.age = 12;
console.log(obj.name === obj); // true
console.log(obj.age); // 12
```
### set(target, propKey, value, receiver)
```js
const handler = {
    // å¯¹è®¾ç½®å±æ€§è¿›è¡Œæ‹¦æˆª
    set: function(target, key, value, receiver) {
        if (key === 'name') {
            target[key] = receiver;
        } else {
            target[key] = value;
        }
    }
}

const proxy = new Proxy({}, handler);
const obj = {};
Object.setPrototypeOf(obj, proxy);

obj.name = 'lisi';
obj.age = 12;
console.log(obj.name === obj); // true
console.log(obj.age); // 12
```
### apply
applyæ–¹æ³•æ‹¦æˆªå‡½æ•°çš„è°ƒç”¨ã€callå’Œapplyæ“ä½œã€‚

applyæ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€ç›®æ ‡å¯¹è±¡çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆthisï¼‰å’Œç›®æ ‡å¯¹è±¡çš„å‚æ•°æ•°ç»„ã€‚
```js
const handler = {
    apply(target, ctx, args) {
        console.log(target);
        console.log(ctx);
        console.log(args); // [1, 2]
        return Reflect.apply(...arguments) * 3;
    }
};

function sum(left, right) {
    return left + right;
}

let proxy = new Proxy(sum, handler);
// æ‰§è¡Œproxyå‡½æ•°ï¼ˆç›´æ¥è°ƒç”¨æˆ–callå’Œapplyè°ƒç”¨ï¼‰ï¼Œå°±ä¼šè¢«applyæ–¹æ³•æ‹¦æˆª
console.log(proxy(1, 2)); // 9
console.log(proxy.call(null, 2, 3)); // 15
console.log(proxy.apply(null, [3, 4])); // 21
```
### has
hasæ–¹æ³•ç”¨æ¥æ‹¦æˆªHasPropertyæ“ä½œï¼Œå³åˆ¤æ–­å¯¹è±¡æ˜¯å¦å…·æœ‰æŸä¸ªå±æ€§æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç”Ÿæ•ˆã€‚å…¸å‹çš„æ“ä½œå°±æ˜¯inè¿ç®—ç¬¦ã€‚

hasæ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€éœ€æŸ¥è¯¢çš„å±æ€§åã€‚
```js
const handler = {
    has(target, key) {
        // éšè—ç§æœ‰å±æ€§
        if (key[0] === '_') {
            return false;
        }
        return key in target;
    }
};
const proxy = new Proxy({name: 'lisi', _age: 18}, handler);
console.log('_age' in proxy); // false
console.log('name' in proxy); // true
```
### construct
constructæ–¹æ³•ç”¨äºæ‹¦æˆªnewå‘½ä»¤ï¼Œä¸‹é¢æ˜¯æ‹¦æˆªå¯¹è±¡çš„å†™æ³•ã€‚
```js

```
### isExtensible
Object.isExtensible() æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯å¯æ‰©å±•çš„ï¼ˆæ˜¯å¦å¯ä»¥åœ¨å®ƒä¸Šé¢æ·»åŠ æ–°çš„å±æ€§ï¼‰ã€‚
```js
const obj = {name: 'lisi'};

console.log(Object.isExtensible(obj)); // true
// è®¾ç½®objä¸å¯æ‰©å±•
Object.preventExtensions(obj);
console.log(Object.isExtensible(obj)); // false
```
## Proxyåº”ç”¨
### demo1
```js
let obj = {
    a: 1,
    b: 2
};

const p = new Proxy(obj, {
    // targetå³obj
    get(target, key, value) {
        if(key in target) {
            return target[key]
        }
        else {
            return 'è‡ªå®šä¹‰ç»“æœ'
        }
    }
});

console.log(obj.a); // 1
console.log(obj.c); // undefined
console.log(p.a); // 1
console.log(p.c); // è‡ªå®šä¹‰ç»“æœ
```
```js
const person = {
    name: 'lisi',
    age: 12
}

const personProxy = new Proxy(person, {
    // getæ¥æ”¶ä¸¤ä¸ªå‚æ•°
    get(target, key) {
        return target[key].toUpperCase();
    },
    // setæ¥æ”¶ä¸‰ä¸ªå‚æ•°
    set(target, key, value) {
        if (typeof value === 'string') {
            target[key] = value.trim();
        }
    }
});

console.log(personProxy.name); // LISI
personProxy.hobbies = '    ğŸ€     ';
console.log(personProxy.hobbies);
```
### demo2
```js
const phoneNumber = new Proxy({}, {
    set(target, key, value) {
        target[key] = value.match(/[0-9]/g).join('');
    },
    get(target, key) {
        return target[key].replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
});
phoneNumber.home = '131 1122 9876'; // 3 4 4å½¢å¼
phoneNumber.company = '134 342 96876'; // 3 3 5å½¢å¼

// { home: '13111229876', company: '13434296876' }
// console.log(phoneNumber);
console.log(phoneNumber.home);
console.log(phoneNumber.company);
```
### demo3
```js
const safetyProxy = new Proxy({id: 2}, {
    set(target, key, value) {
        const likeKey = Object.keys(target).find(k => k.toLowerCase() === key.toLowerCase());
        // å¦‚æœtargetä¸­ä¸å­˜åœ¨keyå’Œä¸keyç›¸ä¼¼çš„key
        if (!(key in target) && likeKey) {
            throw new Error('å·²ç»å­˜åœ¨ç›¸ä¼¼çš„key');
        }
        target[key] = value;
    }
});

// safetyProxy.Id = 3;
safetyProxy.name = 'lisi';
```
## å‚è€ƒæ–‡æ¡£
1. [Proxy](http://es6.ruanyifeng.com/#docs/proxy)
2. [ES6 ç³»åˆ—ä¹‹ defineProperty ä¸ proxy](https://github.com/mqyqingfeng/Blog/issues/107)