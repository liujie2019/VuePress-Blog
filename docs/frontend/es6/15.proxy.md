---
title: 15. Proxy
---
[TOC]
## ç”¨Proxyè¿›è¡Œé¢„å¤„ç†
ä»€ä¹ˆæ˜¯é’©å­å‡½æ•°ï¼Ÿå½“æˆ‘ä»¬åœ¨æ“ä½œä¸€ä¸ªå¯¹è±¡æˆ–è€…æ–¹æ³•æ—¶ä¼šæœ‰å‡ ç§åŠ¨ä½œï¼Œæ¯”å¦‚ï¼šåœ¨è¿è¡Œå‡½æ•°å‰åˆå§‹åŒ–ä¸€äº›æ•°æ®ï¼Œåœ¨æ”¹å˜å¯¹è±¡å€¼ååšä¸€äº›å–„åå¤„ç†ã€‚è¿™äº›éƒ½ç®—é’©å­å‡½æ•°ï¼ŒProxyçš„å­˜åœ¨å°±å¯ä»¥è®©æˆ‘ä»¬ç»™å‡½æ•°åŠ ä¸Šè¿™æ ·çš„é’©å­å‡½æ•°ï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£ä¸ºåœ¨æ‰§è¡Œæ–¹æ³•å‰é¢„å¤„ç†ä¸€äº›ä»£ç ã€‚ä½ å¯ä»¥ç®€å•çš„ç†è§£ä¸ºä»–æ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚

## æ¦‚è¿°
Proxyç”¨äºä¿®æ”¹æŸäº›æ“ä½œçš„é»˜è®¤è¡Œä¸ºï¼Œç­‰åŒäºåœ¨è¯­è¨€å±‚é¢åšå‡ºä¿®æ”¹ï¼Œæ‰€ä»¥å±äºä¸€ç§`å…ƒç¼–ç¨‹`ï¼ˆmeta programmingï¼‰ï¼Œå³å¯¹ç¼–ç¨‹è¯­è¨€è¿›è¡Œç¼–ç¨‹ã€‚

Proxyå¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚æ‹¦æˆªï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚Proxyè¿™ä¸ªè¯çš„åŸæ„æ˜¯ä»£ç†ï¼Œç”¨åœ¨è¿™é‡Œè¡¨ç¤ºç”±å®ƒæ¥â€œä»£ç†â€æŸäº›æ“ä½œï¼Œå¯ä»¥è¯‘ä¸º`ä»£ç†å™¨`ã€‚

ES6åŸç”Ÿæä¾›Proxyæ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”ŸæˆProxyå®ä¾‹ã€‚
```js
const proxy = new Proxy(target, handler);
```
Proxyå¯¹è±¡çš„æ‰€æœ‰ç”¨æ³•ï¼Œéƒ½æ˜¯ä¸Šé¢è¿™ç§å½¢å¼ï¼Œä¸åŒçš„åªæ˜¯`handler`å‚æ•°çš„å†™æ³•ã€‚å…¶ä¸­ï¼Œnew Proxy()è¡¨ç¤ºç”Ÿæˆä¸€ä¸ªProxyå®ä¾‹ï¼Œ**targetå‚æ•°è¡¨ç¤ºæ‰€è¦æ‹¦æˆªçš„ç›®æ ‡å¯¹è±¡**ï¼Œhandlerå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥å®šåˆ¶æ‹¦æˆªè¡Œä¸ºã€‚

## Proxyæ‹¦æˆªæ“ä½œ(å…±æœ‰13ç§)
### 1. get(target, propKey, receiver(å¯é€‰å‚æ•°))
getæ–¹æ³•ç”¨äºï¼š**æ‹¦æˆªå¯¹è±¡æŸä¸ªå±æ€§çš„è¯»å–æ“ä½œ**ï¼Œå¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œä¾æ¬¡ä¸ºç›®æ ‡å¯¹è±¡ã€å±æ€§åå’Œproxyå®ä¾‹æœ¬èº«ï¼ˆä¸¥æ ¼åœ°è¯´ï¼Œæ˜¯æ“ä½œè¡Œä¸ºæ‰€é’ˆå¯¹çš„å¯¹è±¡ï¼‰ï¼Œå…¶ä¸­æœ€åä¸€ä¸ªå‚æ•°å¯é€‰ã€‚

```js
const obj = {
    name: 'lisi'
}

const p = new Proxy(obj, {
    get: function(target, key, receiver) {
        if (key in target) {
            return target[key];
        } else {
            throw new ReferenceError("Property \"" + key + "\" does not exist.");
        }
    }
});

console.log(p.name); // lisi
console.log(p.age); // ReferenceError: Property "age" does not exist.
```
### 2. set(target, propKey, value, receiver)
æ‹¦æˆªå¯¹è±¡å±æ€§çš„è®¾ç½®ï¼Œæœ€åè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
```js
const handler = {
    // å¯¹è®¾ç½®å±æ€§è¿›è¡Œæ‹¦æˆª
    set: function(target, key, value, receiver) {
        if (key === 'name') {
            target[key] = receiver; // å°†nameå±æ€§å€¼è®¾ç½®ä¸ºå½“å‰æ“ä½œè¡Œä¸ºæ‰€é’ˆå¯¹çš„å¯¹è±¡
        } else {
            target[key] = value;
        }
    }
}

const proxy = new Proxy({}, handler);
const obj = {};
// è®¾ç½®objçš„åŸå‹æ˜¯proxy
Object.setPrototypeOf(obj, proxy);

obj.name = 'lisi';
obj.age = 12;
console.log(obj.name === obj); // true
console.log(obj.age); // 12
```
### 3. apply(target, object, args)
applyæ–¹æ³•æ‹¦æˆªå‡½æ•°çš„è°ƒç”¨ã€callå’Œapplyæ“ä½œã€‚

applyæ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€ç›®æ ‡å¯¹è±¡çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆthisï¼‰å’Œç›®æ ‡å¯¹è±¡çš„å‚æ•°æ•°ç»„ã€‚
```js
const handler = {
    apply(target, ctx, args) {
        console.log(target);
        console.log(ctx);
        console.log(args); // [1, 2]
        return Reflect.apply(...arguments) * 3;
    }
};

function sum(left, right) {
    return left + right;
}

const proxy = new Proxy(sum, handler);
// æ‰§è¡Œproxyå‡½æ•°ï¼ˆç›´æ¥è°ƒç”¨æˆ–callå’Œapplyè°ƒç”¨ï¼‰ï¼Œå°±ä¼šè¢«applyæ–¹æ³•æ‹¦æˆª
console.log(proxy(1, 2)); // 9
console.log(proxy.call(null, 2, 3)); // 15
console.log(proxy.apply(null, [3, 4])); // 21
```
### 4. has(target, prop)
æ‹¦æˆªä¾‹å¦‚`prop in proxy`çš„æ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

hasæ–¹æ³•ç”¨æ¥æ‹¦æˆªHasPropertyæ“ä½œï¼Œå³**åˆ¤æ–­å¯¹è±¡æ˜¯å¦å…·æœ‰æŸä¸ªå±æ€§**æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç”Ÿæ•ˆã€‚å…¸å‹çš„æ“ä½œå°±æ˜¯inè¿ç®—ç¬¦ã€‚

hasæ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€éœ€æŸ¥è¯¢çš„å±æ€§åã€‚
```js
const handler = {
    has(target, key) {
        // éšè—ç§æœ‰å±æ€§
        if (key.startsWith('_')) {
            return false;
        }
        return key in target;
    }
};
const proxy = new Proxy({name: 'lisi', _age: 18}, handler);
console.log('_age' in proxy); // false
console.log('name' in proxy); // true
```
### 5. construct(target, args)
constructæ–¹æ³•ç”¨äºæ‹¦æˆªnewå‘½ä»¤ï¼Œä¸‹é¢æ˜¯æ‹¦æˆªå¯¹è±¡çš„å†™æ³•ã€‚
```js

```
### 6. isExtensible(target)
æ‹¦æˆª`Object.isExtensible(proxy)`ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼
Object.isExtensible()æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯å¯æ‰©å±•çš„ï¼ˆæ˜¯å¦å¯ä»¥åœ¨å®ƒä¸Šé¢æ·»åŠ æ–°çš„å±æ€§ï¼‰ã€‚
```js
const obj = {name: 'lisi'};

console.log(Object.isExtensible(obj)); // true
// è®¾ç½®objä¸å¯æ‰©å±•
Object.preventExtensions(obj);
console.log(Object.isExtensible(obj)); // false
```
### 7. deleteProperty(target, prop)
æ‹¦æˆªä¾‹å¦‚`delete proxy[prop]`çš„æ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
### 8. ownKeys(target)
æ‹¦æˆªObject.getOwnPropertyNames(proxy)ã€Object.keys(proxy)ã€for inå¾ªç¯ç­‰æ“ä½œï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ã€‚
### 9. getOwnPropertyDescriptor(target, prop)
æ‹¦æˆª Object.getOwnPropertyDescriptor(proxy, propKey)ï¼Œè¿”å›å±æ€§çš„æè¿°å¯¹è±¡ã€‚
### 10. defineProperty(target, propKey, propDesc)
æ‹¦æˆª Object.defineProperty(proxy, propKey, propDescï¼‰ã€Object.defineProperties(proxy, propDescs)ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
### 11. preventExtensions(target)
æ‹¦æˆª Object.preventExtensions(proxy)ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
### 12 .getPrototypeOf(target)
æ‹¦æˆª Object.getPrototypeOf(proxy)ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚
### 13. setPrototypeOf(target, proto)
æ‹¦æˆªObject.setPrototypeOf(proxy, proto)ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸¤ç§é¢å¤–æ“ä½œå¯ä»¥æ‹¦æˆªã€‚
## Proxy vs Object.defineProperty
åœ¨Proxyå‡ºç°ä¹‹å‰ï¼Œjsé€šè¿‡Object.definePropertyï¼Œå…è®¸å¯¹å¯¹è±¡çš„getter/setterè¿›è¡Œæ‹¦æˆªï¼Œé‚£ä¹ˆä¸¤è€…çš„åŒºåˆ«åœ¨å“ªé‡Œå‘¢ï¼Ÿ
åŒºåˆ«å¦‚ä¸‹ï¼š
1. Object.definePropertyä¸èƒ½ä¸€æ¬¡æ€§ç›‘å¬æ‰€æœ‰å±æ€§
2. Object.definePropertyæ— æ³•ç›‘å¬æ–°å¢åŠ çš„å±æ€§
3. Object.definePropertyæ— æ³•å“åº”æ•°ç»„æ“ä½œ
4. Proxyæ‹¦æˆªæ–¹å¼æ›´å¤š
5. Object.definePropertyå…¼å®¹æ€§æ›´å¥½
### Object.definePropertyä¸èƒ½ç›‘å¬æ‰€æœ‰å±æ€§
Object.defineProperty æ— æ³•ä¸€æ¬¡æ€§ç›‘å¬å¯¹è±¡æ‰€æœ‰å±æ€§ï¼Œå¿…é¡»éå†æˆ–è€…é€’å½’æ¥å®ç°ã€‚
```js
let girl = {
    name: "marry",
    age: 22
}
// Proxyç›‘å¬æ•´ä¸ªå¯¹è±¡
girl = new Proxy(girl, {
    get() {}
    set() {}
})
// Object.defineProperty
Object.keys(girl).forEach(key => {
    Object.defineProperty(girl, key, {
        set() {},
        get() {}
    })
})
```
### Object.definePropertyæ— æ³•ç›‘å¬æ–°å¢åŠ çš„å±æ€§
Proxy å¯ä»¥ç›‘å¬åˆ°æ–°å¢åŠ çš„å±æ€§ï¼Œè€Œ Object.defineProperty ä¸å¯ä»¥ï¼Œéœ€è¦ä½ æ‰‹åŠ¨å†å»åšä¸€æ¬¡ç›‘å¬ã€‚å› æ­¤ï¼Œåœ¨ Vue ä¸­æƒ³åŠ¨æ€ç›‘å¬å±æ€§ï¼Œä¸€èˆ¬ç”¨ Vue.set(girl, "hobby", "game") è¿™ç§å½¢å¼æ¥æ·»åŠ ã€‚
```js
let girl = {
    name: "marry",
    age: 22
}
// Proxyç›‘å¬æ•´ä¸ªå¯¹è±¡
girl = new Proxy(girl, {
    get() {}
    set() {}
})
// Object.defineProperty
Object.keys(girl).forEach(key => {
    Object.defineProperty(girl, key, {
    set() {},
    get() {}
    })
});
// Proxyç”Ÿæ•ˆï¼ŒObject.definePropertyä¸ç”Ÿæ•ˆ
girl.hobby = "game";
```
### Proxyæ‹¦æˆªæ–¹å¼æ›´å¤š
Proxy æä¾›äº†13ç§æ‹¦æˆªæ–¹æ³•ï¼ŒåŒ…æ‹¬æ‹¦æˆª constructorã€applyã€deleteProperty ç­‰ç­‰ï¼Œè€Œ Object.defineProperty åªæœ‰ get å’Œ setã€‚
### Object.definePropertyå…¼å®¹æ€§æ›´å¥½
Proxy æ˜¯æ–°å‡ºçš„ APIï¼Œå…¼å®¹æ€§è¿˜ä¸å¤Ÿå¥½ï¼Œä¸æ”¯æŒ IE å…¨ç³»åˆ—ã€‚

## Proxyåº”ç”¨
### demo1
```js
let obj = {
    a: 1,
    b: 2
};

const p = new Proxy(obj, {
    // targetå³obj
    get(target, key, value) {
        if(key in target) {
            return target[key]
        }
        else {
            return 'è‡ªå®šä¹‰ç»“æœ'
        }
    }
});

console.log(obj.a); // 1
console.log(obj.c); // undefined
console.log(p.a); // 1
console.log(p.c); // è‡ªå®šä¹‰ç»“æœ
```
```js
const person = {
    name: 'lisi',
    age: 12
}

const personProxy = new Proxy(person, {
    // getæ¥æ”¶ä¸¤ä¸ªå‚æ•°
    get(target, key) {
        return target[key].toUpperCase();
    },
    // setæ¥æ”¶ä¸‰ä¸ªå‚æ•°
    set(target, key, value) {
        if (typeof value === 'string') {
            target[key] = value.trim();
        }
    }
});

console.log(personProxy.name); // LISI
personProxy.hobbies = '    ğŸ€     ';
console.log(personProxy.hobbies);
```
### demo2
```js
const phoneNumber = new Proxy({}, {
    set(target, key, value) {
        target[key] = value.match(/[0-9]/g).join('');
    },
    get(target, key) {
        return target[key].replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
});
phoneNumber.home = '131 1122 9876'; // 3 4 4å½¢å¼
phoneNumber.company = '134 342 96876'; // 3 3 5å½¢å¼

// { home: '13111229876', company: '13434296876' }
// console.log(phoneNumber);
console.log(phoneNumber.home);
console.log(phoneNumber.company);
```
### demo3
```js
const safetyProxy = new Proxy({id: 2}, {
    set(target, key, value) {
        const likeKey = Object.keys(target).find(k => k.toLowerCase() === key.toLowerCase());
        // å¦‚æœtargetä¸­ä¸å­˜åœ¨keyå’Œä¸keyç›¸ä¼¼çš„key
        if (!(key in target) && likeKey) {
            throw new Error('å·²ç»å­˜åœ¨ç›¸ä¼¼çš„key');
        }
        target[key] = value;
    }
});

// safetyProxy.Id = 3;
safetyProxy.name = 'lisi';
```
## å‚è€ƒæ–‡æ¡£
1. [Proxy](http://es6.ruanyifeng.com/#docs/proxy)
2. [ES6 ç³»åˆ—ä¹‹ defineProperty ä¸ proxy](https://github.com/mqyqingfeng/Blog/issues/107)
3. [ã€ä½ ä¸çŸ¥é“çš„ Proxyã€‘ï¼šç”¨ ES6 Proxy èƒ½åšå“ªäº›æœ‰æ„æ€çš„äº‹æƒ…ï¼Ÿ](https://juejin.im/post/5e78d908f265da57340267f7)