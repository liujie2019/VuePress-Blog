---
title: 8. Generator(ç”Ÿæˆå™¨)
---
## ä»€ä¹ˆæ˜¯Generatorå‡½æ•°
1. ES6æä¾›çš„å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚
2. Generatorå‡½æ•°æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œå†…éƒ¨å°è£…äº†ä¸åŒçŠ¶æ€çš„æ•°æ®ã€‚
3. ç”¨æ¥ç”Ÿæˆéå†å™¨å¯¹è±¡(iteratoræ¥å£)ï¼Œè°ƒç”¨Generatorå‡½æ•°å¹¶ä¸ä¼šæ‰§è¡Œå…¶å†…éƒ¨çš„ä»£ç ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚
4. å¯æš‚åœå‡½æ•°(æƒ°æ€§æ±‚å€¼)ï¼Œyieldå¯æš‚åœï¼Œnextæ–¹æ³•å¯ç»§ç»­æ‰§è¡Œï¼Œæ¯æ¬¡è¿”å›çš„æ˜¯yieldåçš„è¡¨è¾¾å¼ç»“æœã€‚

## Generatorå‡½æ•°ç‰¹ç‚¹
1. functionå…³é”®å­—ä¸å‡½æ•°åä¹‹é—´æœ‰ä¸€ä¸ª`*`æ˜Ÿå·ã€‚
2. å†…éƒ¨ç”¨yieldè¡¨è¾¾å¼æ¥å®šä¹‰ä¸åŒçš„çŠ¶æ€ã€‚
3. è°ƒç”¨generatorå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œè€Œä¸ä¼šæ‰§è¡Œå‡½æ•°å†…éƒ¨é€»è¾‘ã€‚
4. è°ƒç”¨nextæ–¹æ³•ï¼Œå‡½æ•°å†…éƒ¨é€»è¾‘å¼€å§‹æ‰§è¡Œï¼Œé‡åˆ°yieldè¡¨è¾¾å¼åœæ­¢ï¼Œè¿”å›{value: yieldåçš„è¡¨è¾¾å¼ç»“æœ/undefined, done: false/true}ã€‚
5. å†æ¬¡è°ƒç”¨nextæ–¹æ³•ä¼šä»ä¸Šä¸€æ¬¡åœæ­¢æ—¶çš„yieldå¤„å¼€å§‹ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªyieldè¡¨è¾¾å¼åœæ­¢æˆ–è€…æœ€åã€‚
6. yieldè¯­å¥è¿”å›ç»“æœé€šå¸¸ä¸ºundefinedï¼Œå½“è°ƒç”¨nextæ–¹æ³•æ—¶ä¼ å‚å†…å®¹ä¼šä½œä¸ºå¯åŠ¨æ—¶yieldè¯­å¥çš„è¿”å›å€¼ã€‚

```js
function* generatorExample() {
    let result = yield 'hello'; // çŠ¶æ€å€¼(value)ä¸ºhello
    yield 'world'; // çŠ¶æ€å€¼(value)ä¸ºworld
}
```
```js
function* generatorTest() {
    console.log('å‡½æ•°å¼€å§‹æ‰§è¡Œ');
    let res = yield 'hello'; // yieldè¯­å¥è¿”å›ç»“æœé»˜è®¤æ˜¯ä¸ºundefined
    console.log(res); // 'æˆ‘æ˜¯nextä¼ å…¥çš„å€¼'
    console.log('å‡½æ•°ç»§ç»­æ‰§è¡Œ');
    yield 'world';
}

const gen = generatorTest();
console.log(gen.next());
// å½“è°ƒç”¨nextæ–¹æ³•æ—¶ä¼ å‚å†…å®¹ä¼šä½œä¸ºå¯åŠ¨æ—¶yieldè¯­å¥çš„è¿”å›å€¼
console.log(gen.next('æˆ‘æ˜¯nextä¼ å…¥çš„å€¼'));
console.log(gen.next());
```
## åŸºæœ¬è¯­æ³•
Generatorå‡½æ•°è¯­æ³•è¡Œä¸ºä¸ä¼ ç»Ÿå‡½æ•°å®Œå…¨ä¸åŒã€‚
```js
function* testGenerator() {
    yield 'hello';
    yield 'world';
    return 'end';
}
// è°ƒç”¨Generatorå‡½æ•°åï¼Œè¯¥å‡½æ•°å¹¶ä¸æ‰§è¡Œï¼Œè¿”å›çš„ä¹Ÿä¸æ˜¯å‡½æ•°è¿è¡Œç»“æœï¼Œè€Œæ˜¯ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€çš„æŒ‡é’ˆå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€ç« ä»‹ç»çš„éå†å™¨å¯¹è±¡
const gen = testGenerator();
```
å½¢å¼ä¸Šï¼Œ`Generator`å‡½æ•°æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªç‰¹å¾ï¼š

1. functionå…³é”®å­—ä¸å‡½æ•°åä¹‹é—´æœ‰ä¸€ä¸ªæ˜Ÿå·ï¼›
2. å‡½æ•°ä½“å†…éƒ¨ä½¿ç”¨yield(ç¿»è¯‘ä¸ºäº§å‡º)è¡¨è¾¾å¼ï¼Œå®šä¹‰ä¸åŒçš„å†…éƒ¨çŠ¶æ€ï¼›

ä¸Šé¢ä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ª`Generator`å‡½æ•°testGeneratorï¼Œå®ƒå†…éƒ¨æœ‰ä¸¤ä¸ªyieldè¡¨è¾¾å¼ï¼ˆhelloå’Œworldï¼‰ï¼Œå³è¯¥å‡½æ•°æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼šhelloï¼Œworld å’Œ return è¯­å¥ï¼ˆç»“æŸæ‰§è¡Œï¼‰ã€‚

ç„¶åï¼Œ`Generator`å‡½æ•°çš„è°ƒç”¨æ–¹æ³•ä¸æ™®é€šå‡½æ•°ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨å‡½æ•°ååé¢åŠ ä¸Šä¸€å¯¹åœ†æ‹¬å·ã€‚ä¸åŒçš„æ˜¯ï¼Œè°ƒç”¨Generatorå‡½æ•°åï¼Œè¯¥å‡½æ•°å¹¶ä¸æ‰§è¡Œï¼Œè¿”å›çš„ä¹Ÿä¸æ˜¯å‡½æ•°è¿è¡Œç»“æœï¼Œè€Œæ˜¯ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€çš„æŒ‡é’ˆå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€ç« ä»‹ç»çš„éå†å™¨å¯¹è±¡ï¼ˆIterator Objectï¼‰ã€‚

ä¸‹ä¸€æ­¥ï¼Œå¿…é¡»è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œä½¿å¾—æŒ‡é’ˆç§»å‘ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œå†…éƒ¨æŒ‡é’ˆå°±ä»å‡½æ•°å¤´éƒ¨æˆ–ä¸Šä¸€æ¬¡åœä¸‹æ¥çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªyieldè¡¨è¾¾å¼ï¼ˆæˆ–returnè¯­å¥ï¼‰ä¸ºæ­¢ã€‚æ¢è¨€ä¹‹ï¼Œ**Generatorå‡½æ•°æ˜¯åˆ†æ®µæ‰§è¡Œçš„**ï¼Œyieldè¡¨è¾¾å¼æ˜¯æš‚åœæ‰§è¡Œçš„æ ‡è®°ï¼Œè€Œnextæ–¹æ³•å¯ä»¥æ¢å¤æ‰§è¡Œã€‚
```js
gen.next();
// valueå€¼æ˜¯yieldåçš„è¡¨è¾¾å¼ç»“æœ
// { value: 'hello', done: false }
gen.next();
// { value: 'world', done: false }
gen.next();
// { value: 'ending', done: true }
gen.next();
// { value: undefined, done: true }
```
ä¸Šé¢ä»£ç ä¸€å…±è°ƒç”¨äº†å››æ¬¡nextæ–¹æ³•ã€‚
ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ŒGenerator å‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªyieldè¡¨è¾¾å¼ä¸ºæ­¢ã€‚nextæ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„valueå±æ€§å°±æ˜¯å½“å‰yieldè¡¨è¾¾å¼çš„å€¼helloï¼Œdoneå±æ€§çš„å€¼falseï¼Œè¡¨ç¤ºéå†è¿˜æ²¡æœ‰ç»“æŸã€‚

ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ŒGenerator å‡½æ•°ä»ä¸Šæ¬¡yieldè¡¨è¾¾å¼åœä¸‹çš„åœ°æ–¹ï¼Œä¸€ç›´æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªyieldè¡¨è¾¾å¼ã€‚nextæ–¹æ³•è¿”å›çš„å¯¹è±¡çš„valueå±æ€§å°±æ˜¯å½“å‰yieldè¡¨è¾¾å¼çš„å€¼worldï¼Œdoneå±æ€§çš„å€¼falseï¼Œè¡¨ç¤ºéå†è¿˜æ²¡æœ‰ç»“æŸã€‚

ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼ŒGenerator å‡½æ•°ä»ä¸Šæ¬¡yieldè¡¨è¾¾å¼åœä¸‹çš„åœ°æ–¹ï¼Œä¸€ç›´æ‰§è¡Œåˆ°returnè¯­å¥ï¼ˆå¦‚æœæ²¡æœ‰returnè¯­å¥ï¼Œå°±æ‰§è¡Œåˆ°å‡½æ•°ç»“æŸï¼‰ã€‚nextæ–¹æ³•è¿”å›çš„å¯¹è±¡çš„valueå±æ€§ï¼Œå°±æ˜¯ç´§è·Ÿåœ¨returnè¯­å¥åé¢çš„è¡¨è¾¾å¼çš„å€¼ï¼ˆå¦‚æœæ²¡æœ‰returnè¯­å¥ï¼Œåˆ™valueå±æ€§çš„å€¼ä¸ºundefinedï¼‰ï¼Œdoneå±æ€§çš„å€¼trueï¼Œè¡¨ç¤ºéå†å·²ç»ç»“æŸã€‚

ç¬¬å››æ¬¡è°ƒç”¨ï¼Œæ­¤æ—¶ Generator å‡½æ•°å·²ç»è¿è¡Œå®Œæ¯•ï¼Œnextæ–¹æ³•è¿”å›å¯¹è±¡çš„valueå±æ€§ä¸ºundefinedï¼Œdoneå±æ€§ä¸ºtrueã€‚ä»¥åå†è°ƒç”¨nextæ–¹æ³•ï¼Œè¿”å›çš„éƒ½æ˜¯è¿™ä¸ªå€¼ã€‚

::: tip
æ€»ç»“ä¸€ä¸‹ï¼šè°ƒç”¨Generatorå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œä»£è¡¨ Generator å‡½æ•°çš„å†…éƒ¨æŒ‡é’ˆã€‚ä»¥åï¼Œæ¯æ¬¡è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªæœ‰ç€valueå’Œdoneä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ã€‚valueå±æ€§è¡¨ç¤ºå½“å‰çš„å†…éƒ¨çŠ¶æ€çš„å€¼ï¼Œæ˜¯yieldè¡¨è¾¾å¼åé¢é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼›doneå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éå†ç»“æŸã€‚
:::
## ç»™å¯¹è±¡æ·»åŠ iteratoræ¥å£
```js
const objIterable = {};
objIterable[Symbol.iterator] = function* () {
    yield 'hello';
    yield 'world';
    yield 'end';
}

for (const i of objIterable) {
    console.log(i);
}

const obj = [...objIterable];
console.log(obj); // [ 'hello', 'world', 'end' ]
```
è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
```js
hello
world
end
[ 'hello', 'world', 'end' ]
```
## Generatorå‡½æ•°å®ä¾‹åº”ç”¨
1. å‘é€ajaxè¯·æ±‚è·å–æ–°é—»å†…å®¹ã€‚
2. æ–°é—»å†…å®¹è·å–æˆåŠŸåå†æ¬¡å‘é€è¯·æ±‚ï¼Œè·å–å¯¹åº”çš„æ–°é—»è¯„è®ºã€‚
3. æ–°é—»å†…å®¹è·å–å¤±è´¥åˆ™ä¸éœ€è¦å†æ¬¡å‘é€è¯·æ±‚ã€‚

```js
function* sendRequest() {
    const url = yield getData('http://www.example.com/news?newsID=123');
    yield getData(url);
}

function getData(url) {
    $.get(url, data => {
        console.log(data);
        const commentsUrl = data.commentsUrl;
        const resUrl = `http://www.example.com/${commentsUrl}`;
        // å½“è·å–æ–°é—»å†…å®¹æˆåŠŸï¼Œå‘é€è¯·æ±‚è·å–å¯¹åº”çš„è¯„è®ºå†…å®¹
        // è°ƒç”¨nextä¼ å‚ä¼šä½œä¸ºä¸Šæ¬¡æš‚åœæ˜¯yieldçš„è¿”å›å€¼
        gen.next(resUrl);
    });
}

const gen = sendRequest();
gen.next(); // å‘é€è·å–æ–°é—»å†…å®¹è¯·æ±‚
```
## Generatorå‡½æ•°çš„å¼‚æ­¥åº”ç”¨
### Thunk
```js

```
### coæ¨¡å—
coæ¨¡å—çš„ä¸»è¦ä½œç”¨æ˜¯ï¼šç”¨äºGeneratorå‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œã€‚
æ¥çœ‹ä¸ªğŸŒ°ï¼š
```js
const {fs} = require('mz');
const co = require('co');
function* gen() {
    // ä¾æ¬¡è¯»å–ä¸¤ä¸ªæ–‡ä»¶
    const name = yield fs.readFile('./name.txt', 'utf8');
    const age = yield fs.readFile('./age.txt', 'utf8');
    console.log(name.toString());
    console.log(age.toString());
}

co(gen);
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°åªè¦ä¼ å…¥coå‡½æ•°ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
```js
lisi
18
```
coå‡½æ•°è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥ç”¨thenæ–¹æ³•æ·»åŠ å›è°ƒå‡½æ•°ã€‚
```js
co(gen).then(() => {
    console.log('genå‡½æ•°æ‰§è¡Œå®Œæ¯•');
});
```
ä¸Šé¢ä»£ç ä¸­ï¼Œç­‰åˆ°Generatorå‡½æ•°æ‰§è¡Œç»“æŸï¼Œå°±ä¼šè¾“å‡ºä¸€è¡Œæç¤ºã€‚

```js
// mzæ¨¡å—æŠŠnodeä¸­çš„ä¸€äº›å¸¸ç”¨æ¨¡å—promiseåŒ–äº†
const {fs} = require('mz');
function* read() {
    let filename = yield fs.readFile('./name.txt', 'utf8');
    let age = yield fs.readFile(filename, 'utf8');
    let b = yield [1, 2, 3];
    return age + b;
}
// const co = require('co');
// å®ç°co
function co(it) {// express koa
    // è¿”å›çš„æ˜¯Promise
    return new Promise((resolve, reject) => {
        function next(r) { //å¦‚æœç¢°åˆ°å¼‚æ­¥è¿­ä»£ éœ€è¦å€ŸåŠ©ä¸€ä¸ªè‡ªæ‰§è¡Œå‡½æ•°æ¥å®ç°ï¼Œä¿è¯ç¬¬ä¸€æ¬¡æ‰§è¡Œåè°ƒç”¨ä¸‹ä¸€æ¬¡æ‰§è¡Œ
            const {value, done} = it.next(r);
            if(!done) { // babel
                // ä¸ç®¡valueæ˜¯ä»€ä¹ˆç±»å‹ï¼Œéƒ½åŒ…è£…æˆpromise
                Promise.resolve(value).then(r => {
                    next(r);
                }, err => {
                    reject(err);
                });
            } else { // å®Œæˆäº†èµ°æˆåŠŸ
                resolve(value);
            }
        }
        next();
    });
}
// coæ¥æ”¶generatorå‚æ•°ï¼Œè¿”å›çš„æ˜¯Promise
co(read()).then(data=>{
    console.log(data);
});
```
## å‚è€ƒæ–‡æ¡£
1. [Generator å‡½æ•°çš„è¯­æ³•](http://es6.ruanyifeng.com/#docs/generator)