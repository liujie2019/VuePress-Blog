---
title: 7. å‰ç«¯å¸¸è§è·¨åŸŸæ–¹æ¡ˆ(9ç§)
---
[TOC]
## ä»€ä¹ˆæ˜¯åŒæºç­–ç•¥ï¼Ÿ
åŒæºç­–ç•¥-SOP(Same origin policy)æ˜¯ä¸€ç§çº¦å®šï¼Œç”±Netscapeå…¬å¸1995å¹´å¼•å…¥æµè§ˆå™¨ï¼Œå®ƒæ˜¯æµè§ˆå™¨æœ€æ ¸å¿ƒä¹Ÿæœ€åŸºæœ¬çš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚æœç¼ºå°‘äº†åŒæºç­–ç•¥ï¼Œæµè§ˆå™¨å¾ˆå®¹æ˜“å—åˆ°XSSã€CSRFç­‰æ”»å‡»ã€‚**æ‰€è°“åŒæºæ˜¯æŒ‡"åè®®+åŸŸå+ç«¯å£"ä¸‰è€…éƒ½ç›¸åŒ(æœ‰ä¸€ä¸ªä¸åŒå°±æ˜¯è·¨åŸŸ)**ï¼Œå³ä¾¿ä¸¤ä¸ªä¸åŒçš„åŸŸåæŒ‡å‘åŒä¸€ä¸ªipåœ°å€ï¼Œä¹ŸéåŒæºçš„ã€‚

åŒæºç­–ç•¥é™åˆ¶ä»¥ä¸‹å‡ ç§è¡Œä¸ºï¼š
1. Cookieã€localStorageå’ŒIndexDBæ— æ³•è¯»å–ï¼›
2. DOMå’Œjså¯¹è±¡æ— æ³•è·å¾—ï¼›
3. AJAXè¯·æ±‚ä¸èƒ½å‘é€ã€‚
### ä¸»åŸŸåå’Œå­åŸŸåçš„è¯´æ˜
ä¸»åŸŸåï¼šç”±ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å­—æ¯æ„æˆï¼Œä¸­é—´ç”±ç‚¹å·éš”å¼€ï¼Œæ•´ä¸ªåŸŸååªæœ‰1ä¸ªç‚¹å·ï¼Œæ¯”å¦‚ï¼šcsdn.netã€‚

å­åŸŸåï¼šæ˜¯åœ¨ä¸»åŸŸåä¹‹ä¸‹çš„åŸŸåï¼ŒåŸŸåå†…å®¹ä¼šæœ‰å¤šä¸ªç‚¹å·ï¼Œæ¯”å¦‚ï¼šblog.csdn.netã€‚
### é€šè¿‡ä¿®æ”¹hostæ–‡ä»¶æ¥æ¨¡æ‹Ÿå®ç°åŒæºç­–ç•¥
* xampp

å¯¹æœ¬åœ°çš„hostæ–‡ä»¶åšå¦‚ä¸‹ä¿®æ”¹ï¼š
```js
127.0.0.1:8088 http://api.test.com
```
è¿™æ ·æœ¬åœ°æœåŠ¡`127.0.0.1:8088/index.html`å°±å¯ä»¥è®¿é—®`http://api.test.com/getData`æ¥å£çš„æ•°æ®äº†ã€‚
### æœåŠ¡å™¨æ‹†åˆ†
* webæœåŠ¡å™¨ï¼šé™æ€èµ„æº kbs.sports.qq.com
* dataæœåŠ¡å™¨ï¼šä¸šåŠ¡é€»è¾‘å’Œæ•°æ®åˆ†æ api.sports.qq.com
* å›¾ç‰‡æœåŠ¡å™¨

æ¯”å¦‚è¯´æˆ‘ä»¬åœ¨æœ¬åœ°è¿›è¡Œé¡¹ç›®å¼€å‘ï¼š
* webæœåŠ¡å™¨åœ°å€ä¸ºï¼š127.0.0.1:8088/index.html
* æ•°æ®æ¥å£åœ°å€ä¸ºï¼š127.0.0.1:8090/list

ä»webæœåŠ¡å™¨è¯·æ±‚æ•°æ®æ¥å£æ˜¯è·¨åŸŸçš„ã€‚
## 1. jsonp
* script
* img
* link
* iframe

ä¸Šè¿°å››ç§æ ‡ç­¾çš„å…±åŒç‰¹ç‚¹æ˜¯ï¼šä¸å­˜åœ¨è·¨åŸŸè¯·æ±‚çš„é™åˆ¶ã€‚æ¯”å¦‚è¯´å¯ä»¥åœ¨é¡µé¢ä¸­é€šè¿‡`script`æ ‡ç­¾çš„å½¢å¼ä»cdnä¸Šå¼•å…¥jqueryã€‚

é€šå¸¸ä¸ºäº†å‡è½»webæœåŠ¡å™¨çš„è´Ÿè½½ï¼Œæˆ‘ä»¬æŠŠjsã€cssï¼Œimgç­‰é™æ€èµ„æºåˆ†ç¦»åˆ°å¦ä¸€å°ç‹¬ç«‹åŸŸåçš„æœåŠ¡å™¨ä¸Šï¼Œåœ¨htmlé¡µé¢ä¸­å†é€šè¿‡ç›¸åº”çš„æ ‡ç­¾ä»ä¸åŒåŸŸåä¸‹åŠ è½½é™æ€èµ„æºï¼Œè€Œè¢«æµè§ˆå™¨å…è®¸ã€‚åŸºäºæ­¤åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ¨æ€åˆ›å»ºscriptæ ‡ç­¾ï¼Œå†è¯·æ±‚ä¸€ä¸ªå¸¦å‚ç½‘å€å®ç°è·¨åŸŸé€šä¿¡ã€‚
### åŸç”Ÿjså®ç°
éœ€è¦æ³¨æ„çš„ç‚¹ï¼š
* åŠ¨æ€åˆ›å»ºscriptæ ‡ç­¾
* å›è°ƒå‡½æ•°éœ€è¦æ˜¯ä¸€ä¸ªå…¨å±€å‡½æ•°
* jsonpå®ç°éœ€è¦æœåŠ¡ç«¯æ”¯æŒï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„å­—ç¬¦ä¸²
* jsonpå‘é€çš„è¯·æ±‚å¹¶ä¸æ˜¯ajaxè¯·æ±‚ï¼Œtypeç±»å‹æ˜¯scriptç±»å‹
```html
<script>
    // showå‡½æ•°éœ€è¦æ˜¯å…¨å±€å‡½æ•°
    function show(data) {
        console.log(data); // {user: "æˆ‘æ˜¯æœåŠ¡ç«¯"}
    }
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'http://localhost:3000/login?user=admin&callback=show';
    document.head.appendChild(script);
</script>
```
server.js
```js

const express = require('express');
const app = express();

app.get('/login', (req, res) => {
    console.log(req.query); // { user: 'admin', callback: 'show' }
    const {callback} = req.query;
    const data = {
        code: 0,
        msg: 'æˆ‘æ˜¯åç«¯æœåŠ¡å™¨'
    };
    res.setHeader('Content-Type', 'text/plain;charset=utf-8'); // æŒ‡å®šå­—ç¬¦ç¼–ç 
    // æœåŠ¡å™¨è¿”å›çš„æ˜¯å­—ç¬¦ä¸²ï¼Œæµè§ˆå™¨æ‹¿åˆ°è¿™ä¸ªå­—ç¬¦ä¸²åä¼šè¿›è¡Œè§£ææ‰§è¡Œ(ä¹‹æ‰€ä»¥ä¼šæ‰§è¡Œæ˜¯åŸºäºæµè§ˆå™¨çš„æœºåˆ¶)
    res.end(`${callback}(${JSON.stringify(data)})`);
});
app.listen(3000, () => {
    console.log('server run at port 3000');
});
```
### jQueryå®ç°jsonp
```js
$.ajax({
    url: 'http://localhost:3000/login',
    type: 'get',
    dataType: 'jsonp', // è¯·æ±‚æ–¹å¼ä¸ºjsonp
    // è¿™é‡Œå¦‚æœä¸æŒ‡å®šçš„è¯jqueryä¼šé»˜è®¤ç”Ÿæˆä¸€ä¸ªå…¨å±€çš„å›è°ƒå‡½æ•°
    jsonpCallback: 'callback', // è‡ªå®šä¹‰å›è°ƒå‡½æ•°å
    data: {}
});
```
æœåŠ¡ç«¯ä»£ç ï¼š
```js
const http = require('http');
const qs = require('querystring');
const server = http.createServer();

server.on('request', (req, res) => {
    // console.log(req.url);
    const queryData = qs.parse(req.url.split('?')[1]);
    console.log(queryData); // { user: 'admin', callback: 'show' }
    // jsonpè¿”å›è®¾ç½®
    const {callback, user} = queryData;
    const data = {user: 'æˆ‘æ˜¯æœåŠ¡ç«¯'};
    res.writeHead(200, {'Content-Type': 'text/plain;charset=utf-8'});
    res.write(`${callback}(${JSON.stringify(data)})`);
    res.end();
});

server.listen(3000, () => {
    console.log('server run port 3000');
});
```
### æ‰‹å†™jsonp
```js
<script>
// åªèƒ½å‘é€getè¯·æ±‚
// ä¸å®‰å…¨ xssæ”»å‡»
function jsonp({url, params, cb}) {
    return new Promise((resolve, reject) => {
        let script = document.createElement('script');
        window[cb] = data => {
            resolve(data);
            document.body.removeChild(script);
        };
        params = {...params, cb};
        let paramsArr = [];
        for (let key in params) {
            paramsArr.push(`${key}=${params[key]}`);
        }
        script.src = `${url}?${paramsArr.join('&')}`;
        document.body.appendChild(script);
    });
}
jsonp({
    url: 'http://localhost:3000/home',
    params: {wd: 'ddf'},
    cb: 'show'
}).then(data => {
    console.log(data);
});
</script>
```
server.js
```js
const express = require('express');
const app = express();

app.get('/home', (req, res) => {
    const {wd, cb} = req.query;
    res.setHeader('Content-Type', 'text/plain;charset=utf-8'); // æŒ‡å®šå­—ç¬¦ç¼–ç 
    res.end(`${cb}('æˆ‘æ˜¯åç«¯æœåŠ¡å™¨')`);
});
app.listen(3000, () => {
    console.log('server run at port 3000');
});
```
jsonpç¼ºç‚¹ï¼š
* åªèƒ½å®ç°getè¯·æ±‚ã€‚
* è¯·æ±‚ä¸å®‰å…¨ï¼Œå®¹æ˜“è¢«æ‹¦æˆªï¼Œè¿”å›æ¶æ„ä»£ç ï¼Œé€ æˆxssæ”»å‡»ã€‚
## 2. CORS(è·¨åŸŸèµ„æºå…±äº«)
[CORS-è·¨åŸŸèµ„æºå…±äº«](http://docs.liujie.fun/frontend/jsTopic/06.CORS-%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB.html)
CORSéœ€è¦åç«¯æœåŠ¡å™¨é…åˆå®ç°ã€‚å‰ç«¯æ­£å¸¸å‘é€è¯·æ±‚å°±å¯ä»¥äº†ï¼Œåç«¯é€šè¿‡è®¾ç½®ä¸€ç³»åˆ—çš„å“åº”å¤´æ¥è¿›è¡Œè·¨åŸŸè¯·æ±‚çš„å¤„ç†ã€‚è¿™é‡Œä¸¾ä¸ªğŸŒ°ï¼š
```html

```
```js

```
éœ€è¦æ³¨æ„ï¼š`Access-Control-Allow-Origin`è®¾ç½®ä¸º`*`å·çš„è¯ï¼Œè™½ç„¶ä»»æ„æºéƒ½å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯å°±ä¸èƒ½æºå¸¦cookieäº†(åŸå› æ˜¯æµè§ˆå™¨ä¸ºäº†ä¿è¯å®‰å…¨)ã€‚å¦‚æœ`Access-Control-Allow-Origin`è®¾ç½®ä¸ºæŒ‡å®šæºçš„è¯ï¼Œè™½ç„¶å¯ä»¥æºå¸¦cookieï¼Œä½†æ˜¯å°±åªèƒ½å•ä¸€æºè®¿é—®ã€‚
```js
res.setHeader('Access-Control-Allow-Origin', '*');
```
## 3. nginxè®¾ç½®åå‘ä»£ç†è·¨åŸŸ
* æ—¢ç„¶ä¸èƒ½è·¨åŸŸè¯·æ±‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸è·¨åŸŸå°±å¯ä»¥äº†ã€‚é€šè¿‡åœ¨è¯·æ±‚åˆ°è¾¾æœåŠ¡å‰éƒ¨ç½²ä¸€ä¸ªæœåŠ¡ï¼Œå°†æ¥å£è¯·æ±‚è¿›è¡Œè½¬å‘ï¼Œè¿™å°±æ˜¯åå‘ä»£ç†ã€‚é€šè¿‡ä¸€å®šçš„è½¬å‘è§„åˆ™å¯ä»¥å°†å‰ç«¯çš„è¯·æ±‚è½¬å‘åˆ°å…¶å®ƒçš„æœåŠ¡ï¼Œä»¥Nginxä¸ºä¾‹ï¼š
```bash
server {
    listen 8088; # æœåŠ¡ç›‘å¬çš„ç«¯å£
    server_name  localhost; # æœåŠ¡åç§°
    # å°†æ‰€æœ‰http://localhost:8088/apiå¼€å¤´çš„è¯·æ±‚è¿›è¡Œè½¬å‘
    location ^~ /api {
        proxy_pass http://localhost:8000; # åå‘ä»£ç†
    }
}
```
* é€šè¿‡åå‘ä»£ç†æˆ‘ä»¬å°†å‰ç«¯åç«¯é¡¹ç›®ç»Ÿä¸€é€šè¿‡åå‘ä»£ç†æ¥æä¾›å¯¹å¤–çš„æœåŠ¡ï¼Œè¿™æ ·åœ¨å‰ç«¯çœ‹ä¸Šå»å°±è·Ÿä¸å­˜åœ¨è·¨åŸŸä¸€æ ·ã€‚
* åå‘ä»£ç†éº»çƒ¦ä¹‹å¤„å°±åœ¨äºå¯¹Nginxç­‰åå‘ä»£ç†æœåŠ¡çš„é…ç½®ï¼Œåœ¨ç›®å‰å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­å¾ˆå¤šéƒ½æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚

ä½¿ç”¨nginxåå‘ä»£ç†å®ç°è·¨åŸŸï¼Œæ˜¯æœ€ç®€å•çš„è·¨åŸŸæ–¹å¼ã€‚è¯¥æ–¹æ³•ä¸éœ€è¦ç›®æ ‡æœåŠ¡å™¨é…åˆï¼Œä¸è¿‡éœ€è¦æˆ‘ä»¬è‡ªå·±æ­å»ºä¸€ä¸ªä¸­è½¬è¯·æ±‚çš„nginxæœåŠ¡å™¨ï¼Œç”¨äºè½¬å‘è¯·æ±‚ã€‚åªéœ€è¦ä¿®æ”¹nginxçš„é…ç½®å³å¯è§£å†³è·¨åŸŸé—®é¢˜ï¼Œæ”¯æŒæ‰€æœ‰æµè§ˆå™¨ï¼Œæ”¯æŒsessionï¼Œä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚
::: tip
å®ç°æ€è·¯ï¼šé€šè¿‡nginxé…ç½®ä¸€ä¸ªä»£ç†æœåŠ¡å™¨(åŸŸåä¸domain1ç›¸åŒï¼Œç«¯å£ä¸åŒ)åšè·³æ¿æœºï¼Œåå‘ä»£ç†è®¿é—®domain2æ¥å£ï¼Œå¹¶ä¸”å¯ä»¥é¡ºä¾¿ä¿®æ”¹cookieä¸­domainä¿¡æ¯ï¼Œæ–¹ä¾¿å½“å‰åŸŸcookieå†™å…¥ï¼Œå®ç°è·¨åŸŸç™»å½•ã€‚
:::
![](https://github.com/liujie2019/static_data/blob/master/img/20191231225849.png?raw=true)
```html
// å‰ç«¯æœ¬åœ°é¡µé¢http://localhost:8097/index.html
<script>
    let xhr = new XMLHttpRequest;
    xhr.open('get', 'http://a.baidu.com:81/?user=liujie', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300 || xhr.status === 304) {
                console.log(xhr.response);
            }
        }
    }
    xhr.send();
</script>
```
```js
// å‰ç«¯æœ¬åœ°é™æ€èµ„æºæœåŠ¡å™¨
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(8097, () => {
    console.log('server run at port 8097');
});
```
```js
// è®¾ç½®nginxä»£ç†æœåŠ¡å™¨
// http://localhost:81
server {
    listen  81; # æœåŠ¡ç›‘å¬çš„ç«¯å£
    server_name  localhost a.baidu.com; # æœåŠ¡åç§°
    location / {
        proxy_pass http://b.baidu.com:8000;
        add_header "Access-Control-Allow-Origin" "http://a.baidu.com:8097";
        index  index.html index.htm;
    }
}
```
```bash
location ~.*\.json {
    // è¡¨ç¤ºä»¥.jsonç»“å°¾çš„éƒ½å»jsonç›®å½•ä¸‹å»æ‰¾
    root json;
}
```
æ³¨æ„ï¼š`~`è¡¨ç¤ºå¿½ç•¥å¤§å°å†™ã€‚
```js
// ç›®æ ‡æœåŠ¡å™¨
var http = require('http');
var server = http.createServer();
var qs = require('querystring');
server.on('request', function(req, res) {
    console.log(req.url); // /api?user=liujie
    var params = qs.parse(req.url.substring(2));
    // å‘å‰å°å†™cookie
    res.writeHead(200, {
        'Set-Cookie': 'l=a123456;Path=/;Domain=b.baidu.com;HttpOnly'   // HttpOnly:è„šæœ¬æ— æ³•è¯»å–
    });
    res.write(JSON.stringify(params));
    res.end();
});
server.listen(8000);
console.log('Server is running at port 8000...');
```
### nginxç›¸å…³ç›®å½•
* nginxé…ç½®æ–‡ä»¶ç›®å½•ï¼š`cd /usr/local/etc/nginx/`
* nginxæœåŠ¡ç›®å½•ï¼š`/usr/local/Cellar/nginx/1.15.5/`
### nginxå‘½ä»¤
* å¯åŠ¨ï¼šnginx
* é‡å¯ï¼šnginx -s reload

## 4. Nodeä¸­é—´ä»¶ä»£ç†(ä¸¤æ¬¡è·¨åŸŸ)
::: tip
å®ç°åŸç†ï¼š**åŒæºç­–ç•¥æ˜¯æµè§ˆå™¨éœ€è¦éµå¾ªçš„æ ‡å‡†ï¼Œè€Œå¦‚æœæ˜¯æœåŠ¡å™¨å‘æœåŠ¡å™¨è¯·æ±‚çš„è¯å°±æ— éœ€éµå¾ªåŒæºç­–ç•¥**ã€‚
:::
Nodeä¸­é—´ä»¶ä»£ç†å®ç°è·¨åŸŸï¼ŒåŸç†ä¸nginxå¤§è‡´ç›¸åŒï¼Œéƒ½æ˜¯é€šè¿‡**å¯ä¸€ä¸ªä»£ç†æœåŠ¡å™¨**ï¼Œå®ç°æ•°æ®çš„è½¬å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®cookieDomainRewriteå‚æ•°ä¿®æ”¹å“åº”å¤´ä¸­cookieä¸­åŸŸåï¼Œå®ç°å½“å‰åŸŸçš„cookieå†™å…¥ï¼Œæ–¹ä¾¿æ¥å£ç™»å½•è®¤è¯ã€‚
![](https://github.com/liujie2019/static_data/blob/master/img/20191231231214.png?raw=true)

ä»£ç†æœåŠ¡å™¨ï¼Œéœ€è¦åšä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
* æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼›
* å°†è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ï¼›
* æ‹¿åˆ°æœåŠ¡å™¨å“åº”æ•°æ®ï¼›
* å°†å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚
### demo
å‰ç«¯æœ¬åœ°æ–‡ä»¶`http://localhost:81/index.html`æ–‡ä»¶ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨`http://localhost:8097`å‘ç›®æ ‡æœåŠ¡å™¨`http://localhost:8000`è¯·æ±‚æ•°æ®ã€‚
```js
// http://localhost:81/index.html
<script>
    const xhr = new XMLHttpRequest;
    xhr.open('get', 'http://a.baidu.com:8097/api?user=admin666', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300 || xhr.status === 304) {
                console.log(xhr.response);
                // console.log(xhr.getResponseHeader('name'));
            }
        }
    }
    xhr.send();
</script>
```
```js
// ä»£ç†æœåŠ¡å™¨http://localhost:8097
const express = require('express');
const proxy = require('http-proxy-middleware');
const app = express();

app.use('/', proxy({
    target: 'http://b.baidu.com:8000',
    changeOrigin: true,
    // ä¿®æ”¹å“åº”å¤´ä¿¡æ¯ï¼Œå®ç°è·¨åŸŸå¹¶å…è®¸å¸¦cookie
    onProxyRes: function(proxyRes, req, res) {
        res.header('Access-Control-Allow-Origin', 'http://a.baidu.com:81');
        res.header('Access-Control-Allow-Credentials', 'true');
    },

    // ä¿®æ”¹å“åº”ä¿¡æ¯ä¸­çš„cookieåŸŸå
    cookieDomainRewrite: 'a.baidu.com'  // å¯ä»¥ä¸ºfalseï¼Œè¡¨ç¤ºä¸ä¿®æ”¹
}));

app.listen(8097, () => {
    console.log('server running on port 8097');
});
```
```js
// ç›®æ ‡æœåŠ¡å™¨
const http = require('http');
const server = http.createServer();
const qs = require('querystring');
server.on('request', function(req, res) {
    console.log(req.url); // /api?user=liujie
    var params = qs.parse(req.url.substring(5));
    // å‘å‰å°å†™cookie
    res.writeHead(200, {
        'Set-Cookie': 'l=a123456;Path=/;Domain=b.baidu.com;HttpOnly' // HttpOnly: è®¾ç½®jsè„šæœ¬æ— æ³•è¯»å–Cookie
    });
    res.write(JSON.stringify(params));
    res.end();
});
server.listen(8000, () => {
    console.log('Server is running at port 8000...')
});
```
### åŸºäºhttp proxyå®ç°è·¨åŸŸè¯·æ±‚
vueæ¡†æ¶çš„è·¨åŸŸï¼ˆ1æ¬¡è·¨åŸŸï¼‰
åˆ©ç”¨node + webpack + webpack-dev-serverä»£ç†æ¥å£è·¨åŸŸã€‚åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œç”±äºvueæ¸²æŸ“æœåŠ¡å’Œæ¥å£ä»£ç†æœåŠ¡éƒ½æ˜¯webpack-dev-serveråŒä¸€ä¸ªï¼Œæ‰€ä»¥é¡µé¢ä¸ä»£ç†æ¥å£ä¹‹é—´ä¸å†è·¨åŸŸï¼Œæ— é¡»è®¾ç½®headersè·¨åŸŸä¿¡æ¯äº†ã€‚

webpack.config.jséƒ¨åˆ†é…ç½®ï¼š
```js
module.exports = {
    entry: {},
    module: {},
    // ...
    devServer: {
        historyApiFallback: true,
        proxy: [{
            context: '/login',
            target: 'http://www.domain2.com:8080',  // ä»£ç†è·¨åŸŸç›®æ ‡æ¥å£
            changeOrigin: true,
            secure: false,  // å½“ä»£ç†æŸäº›httpsæœåŠ¡æŠ¥é”™æ—¶ç”¨
            cookieDomainRewrite: 'www.domain1.com'  // å¯ä»¥ä¸ºfalseï¼Œè¡¨ç¤ºä¸ä¿®æ”¹
        }],
        noInfo: true
    }
}
```
## 5. postMessage
postMessageæ˜¯HTML5 `XMLHttpRequest Level 2`ä¸­çš„APIï¼Œä¸”æ˜¯ä¸ºæ•°ä¸å¤šå¯ä»¥è·¨åŸŸæ“ä½œçš„windowå±æ€§ä¹‹ä¸€ï¼Œå®ƒå¯ç”¨äºè§£å†³ä»¥ä¸‹æ–¹é¢çš„é—®é¢˜ï¼š
* é¡µé¢å’Œå…¶æ‰“å¼€çš„æ–°çª—å£çš„æ•°æ®ä¼ é€’ï¼›
* å¤šçª—å£ä¹‹é—´æ¶ˆæ¯ä¼ é€’ï¼›
* é¡µé¢ä¸åµŒå¥—çš„iframeæ¶ˆæ¯ä¼ é€’ï¼›
* ä¸Šé¢ä¸‰ä¸ªåœºæ™¯çš„è·¨åŸŸæ•°æ®ä¼ é€’ã€‚

postMessageæ–¹æ³•å…è®¸æ¥è‡ªä¸åŒæºçš„è„šæœ¬é‡‡ç”¨å¼‚æ­¥æ–¹å¼è¿›è¡Œæœ‰é™çš„é€šä¿¡ï¼Œå¯ä»¥å®ç°è·¨æ–‡æœ¬æ¡£ã€å¤šçª—å£ã€è·¨åŸŸæ¶ˆæ¯ä¼ é€’ã€‚
```js
otherWindow.postMessage(message, targetOrigin, [transfer]);
```
* message: å°†è¦å‘é€åˆ°å…¶ä»– windowçš„æ•°æ®ï¼›
* targetOrigin:é€šè¿‡çª—å£çš„originå±æ€§æ¥æŒ‡å®šå“ªäº›çª—å£èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶ï¼Œå…¶å€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²`"*"`ï¼ˆè¡¨ç¤ºæ— é™åˆ¶ï¼‰æˆ–è€…ä¸€ä¸ªURIã€‚åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœç›®æ ‡çª—å£çš„åè®®ã€ä¸»æœºåœ°å€æˆ–ç«¯å£è¿™ä¸‰è€…çš„ä»»æ„ä¸€é¡¹ä¸åŒ¹é…targetOriginæä¾›çš„å€¼ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¸ä¼šè¢«å‘é€ï¼›åªæœ‰ä¸‰è€…å®Œå…¨åŒ¹é…ï¼Œæ¶ˆæ¯æ‰ä¼šè¢«å‘é€ã€‚
* transfer(å¯é€‰)ï¼šæ˜¯ä¸€ä¸²å’Œmessage åŒæ—¶ä¼ é€’çš„ Transferable å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡çš„æ‰€æœ‰æƒå°†è¢«è½¬ç§»ç»™æ¶ˆæ¯çš„æ¥æ”¶æ–¹ï¼Œè€Œå‘é€ä¸€æ–¹å°†ä¸å†ä¿æœ‰æ‰€æœ‰æƒã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼šhttp://localhost:3000/a.htmlé¡µé¢å‘http://localhost:4000/b.htmlä¼ é€’æ•°æ®ï¼Œç„¶ååè€…ä¼ å›æ•°æ®çš„ä¾‹å­ã€‚
```html
// a.html
<body>
    <h2>æˆ‘æ˜¯aé¡µé¢</h2>
    <iframe
        src="http://localhost:4000/b.html"
        id="frame"
        frameborder="10"
        onload="load()"
    >
    </iframe>
    <script>
        function load() {
            const frame = document.querySelector('#frame'); // è·å–åˆ°iframe
            frame.contentWindow.postMessage('æˆ‘æ˜¯çˆ¶é¡µé¢a', 'http://localhost:4000');
            window.onmessage = function(e) {
                console.log(e);
                console.log(e.data);
            }
        }
    </script>
</body>
```
```js
// a.htmlå¯¹åº”çš„é™æ€èµ„æºæœåŠ¡å™¨
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(3000, () => {
    console.log('server run at port 3000');
});
```
```html
<body>
    <h2>æˆ‘æ˜¯bé¡µé¢</h2>
    <script>
        // ç›‘å¬aé¡µé¢å‘é€è¿‡æ¥ä¿¡æ¯
        window.onmessage = function(e) {
            const {source, data, origin} = e;
            console.log(e);
            // console.log(window.parent);
            // window.parent.postMessage('æˆ‘æ˜¯å­é¡µé¢b', origin);
            source.postMessage('æˆ‘æ˜¯å­é¡µé¢b', origin);
        }
    </script>
</body>
```
eä¸­åŒ…å«å¦‚ä¸‹ä¿¡æ¯ï¼š
<img :src="$withBase('/jsTopic/kuayu2.png')" alt="">

```js
// b.htmlå¯¹åº”çš„é™æ€èµ„æºæœåŠ¡å™¨
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(4000, () => {
    console.log('server run at port 4000');
});
```
## 6. Websocket
Websocketæ˜¯HTML5çš„ä¸€ä¸ªæŒä¹…åŒ–çš„åè®®ï¼Œå®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨çš„å…¨åŒå·¥é€šä¿¡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯è·¨åŸŸçš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

WebSocketå’ŒHTTPéƒ½æ˜¯åº”ç”¨å±‚åè®®ï¼Œéƒ½åŸºäºTCPåè®®ã€‚ä½†æ˜¯ WebSocketæ˜¯ä¸€ç§åŒå‘é€šä¿¡åè®®ï¼Œåœ¨å»ºç«‹è¿æ¥ä¹‹åï¼ŒWebSocketçš„ serverä¸clientéƒ½èƒ½ä¸»åŠ¨å‘å¯¹æ–¹å‘é€æˆ–æ¥æ”¶æ•°æ®ã€‚åŒæ—¶ï¼ŒWebSocketåœ¨å»ºç«‹è¿æ¥æ—¶éœ€è¦å€ŸåŠ©HTTPåè®®ï¼Œè¿æ¥å»ºç«‹å¥½äº†ä¹‹å clientä¸server ä¹‹é—´çš„åŒå‘é€šä¿¡å°±ä¸HTTPæ— å…³äº†ã€‚

åŸç”ŸWebSocket APIä½¿ç”¨èµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨Socket.ioï¼Œå®ƒå¾ˆå¥½åœ°å°è£…äº†webSocketæ¥å£ï¼Œæä¾›äº†æ›´ç®€å•ã€çµæ´»çš„æ¥å£ï¼Œä¹Ÿå¯¹ä¸æ”¯æŒwebSocketçš„æµè§ˆå™¨æä¾›äº†å‘ä¸‹å…¼å®¹ã€‚

æ¥çœ‹ä¸ªä¾‹å­ï¼šæœ¬åœ°æ–‡ä»¶index.htmlå‘`localhost:3000`å‘é€æ•°æ®å’Œæ¥å—æ•°æ®ã€‚
```js
// å®¢æˆ·ç«¯
<script>
    // é«˜çº§api ä¸å…¼å®¹ socket.io(ä¸€èˆ¬ä½¿ç”¨å®ƒ)
    let socket = new WebSocket('ws://localhost:3000');
    socket.onopen = function() {
        socket.send('æˆ‘æ˜¯å®¢æˆ·ç«¯'); // å‘æœåŠ¡å™¨å‘é€æ•°æ®
    };
    socket.onmessage = function(e) {
        console.log(e.data); // æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„æ•°æ®
    }
</script>
```
```js
// æœåŠ¡ç«¯
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

const WebSocket = require('ws');

const wss = new WebSocket.Server({port: 3000});
// è¿æ¥æˆåŠŸå¤„ç†
wss.on('connection', function(ws) {
    // ç›‘å¬å®¢æˆ·ç«¯æ¶ˆæ¯
    ws.on('message', function(data) {
        console.log(data);
        ws.send('æˆ‘æ˜¯æœåŠ¡ç«¯');
    });
});

app.listen(5000, () => {
    console.log('server run at port 5000');
});
```
## 7. åŸºäºiframeçš„è·¨åŸŸè§£å†³æ–¹æ¡ˆ
### 7.1 window.name + iframe
window.nameå±æ€§çš„ç‹¬ç‰¹ä¹‹å¤„ï¼šnameå€¼åœ¨ä¸åŒçš„é¡µé¢ï¼ˆç”šè‡³ä¸åŒåŸŸåï¼‰åŠ è½½åä¾æ—§å­˜åœ¨ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒéå¸¸é•¿çš„nameå€¼(2MB)ã€‚

å…¶ä¸­a.htmlå’Œb.htmlæ˜¯åŒåŸŸçš„ï¼Œéƒ½æ˜¯http://localhost:3000ï¼›è€Œc.htmlæ˜¯http://localhost:4000ã€‚
```html
// a.html
<body>
    <h2>aé¡µé¢</h2>
    <iframe
        src="http://localhost:4000/c.html"
        frameborder="0"
        id="iframe"
        onload="load()"
    >
    </iframe>
    <script>
        /*
         * aå’Œbæ˜¯åŒåŸŸçš„ http://localhost:3000
         * cæ˜¯ç‹¬ç«‹çš„ http://localhost:4000
         * aè·å–cçš„æ•°æ®
         * aå…ˆå¼•ç”¨cï¼ŒcæŠŠå€¼æ”¾åˆ°window.nameä¸­ï¼ŒæŠŠaå¼•ç”¨çš„åœ°å€æ”¹ä¸ºb
         */
        let isFirst = true;
        function load() {
            console.log(666);
            if (isFirst) {
                const iframe = document.querySelector('#iframe');
                // å°†åœ°å€é‡æ–°æŒ‡å‘åˆ°åŒæº
                // è¿™é‡Œé‡æ–°æŒ‡å®šsrcåä¹Ÿä¼šè§¦å‘loadäº‹ä»¶ï¼Œå› æ­¤loadå‡½æ•°ä¼šæ‰§è¡Œä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ˜¯åœ¨iframeåŠ è½½å®Œæˆ
                iframe.src = 'http://localhost:3000/b.html';
                isFirst = false;
            }
            else {
                console.log(iframe.contentWindow.name);
            }
        }
    </script>
</body>
```
```js
// a.htmlå’Œb.htmlé™æ€èµ„æºæœåŠ¡å™¨
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(3000, () => {
    console.log('server run at port 3000');
});
```
**b.htmlä¸ºä¸­é—´ä»£ç†é¡µï¼Œä¸a.htmlåŒåŸŸï¼Œå†…å®¹ä¸ºç©º**ã€‚
```html
<body>
    <h2>bé¡µé¢</h2>
</body>
```
```html
<body>
    <h2>cé¡µé¢</h2>
    <script>
        window.name = 'æˆ‘æ˜¯cé¡µé¢';
    </script>
</body>
```
```js
// c.htmlé™æ€èµ„æºæœåŠ¡å™¨
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(4000, () => {
    console.log('server run at port 4000');
});
```
<img :src="$withBase('/jsTopic/kuayu.png')" alt="">

666æ‰“å°äº†ä¸¤æ¬¡ï¼Œè¯´æ˜loadå‡½æ•°æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚

æ€»ç»“ï¼šé€šè¿‡iframeçš„srcå±æ€§ç”±å¤–åŸŸè½¬å‘æœ¬åœ°åŸŸï¼Œè·¨åŸŸæ•°æ®å³ç”±iframeçš„window.nameä»å¤–åŸŸä¼ é€’åˆ°æœ¬åœ°åŸŸã€‚è¿™ä¸ªå°±å·§å¦™åœ°ç»•è¿‡äº†æµè§ˆå™¨çš„è·¨åŸŸè®¿é—®é™åˆ¶ï¼Œä½†åŒæ—¶å®ƒåˆæ˜¯å®‰å…¨æ“ä½œã€‚
### 7.2 location.hash + iframe
å®ç°åŸç†ï¼ša.htmlæƒ³è®¿é—®c.htmlè·¨åŸŸç›¸äº’é€šä¿¡ï¼Œé€šè¿‡ä¸­é—´é¡µb.htmlæ¥å®ç°ã€‚ä¸‰ä¸ªé¡µé¢ï¼Œä¸åŒåŸŸä¹‹é—´åˆ©ç”¨iframeçš„location.hashä¼ å€¼ï¼Œç›¸åŒåŸŸä¹‹é—´ç›´æ¥jsè®¿é—®æ¥é€šä¿¡ã€‚

å…·ä½“å®ç°æ­¥éª¤ï¼š
1. ä¸€å¼€å§‹a.htmlç»™c.htmlä¼ ä¸€ä¸ªhashå€¼ï¼›
2. ç„¶åc.htmlæ”¶åˆ°hashå€¼åï¼Œå†æŠŠhashå€¼ä¼ é€’ç»™b.htmlï¼›
3. æœ€åb.htmlå°†ç»“æœæ”¾åˆ°a.htmlçš„hashå€¼ä¸­ã€‚

åŒæ ·çš„ï¼Œa.htmlå’Œb.htmlæ˜¯åŒåŸŸçš„ï¼Œéƒ½æ˜¯http://localhost:3000ï¼Œè€Œc.htmlæ˜¯http://localhost:4000ã€‚
```html
// a.html
<body>
    <!--
        è·¯å¾„åé¢çš„hashå€¼å¯ä»¥ç”¨æ¥é€šä¿¡
        ç›®çš„ï¼šaæƒ³è®¿é—®c
        aç»™cä¼ ä¸€ä¸ªhashå€¼ï¼Œcæ”¶åˆ°hashå€¼åï¼ŒcæŠŠhashå€¼ä¼ é€’ç»™bï¼Œbå°†ç»“æœæ”¾åˆ°açš„hashå€¼ä¸­
    -->
    <iframe src="http://localhost:4000/c.html#æˆ‘æ˜¯aé¡µé¢" frameborder="0"></iframe>
    <script>
        // ç›‘å¬hashå˜åŒ–
        window.onhashchange = function () {
            console.log(decodeURIComponent(location.hash));
        }
    </script>
</body>
```
```js
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(3000, () => {
    console.log('server run at port 3000');
});
```
```html
// b.html
<body>
    <h2>bé¡µé¢</h2>
    <script>
        // window.parentæ˜¯æ‹¿åˆ°bçš„parent å³c.html
        // window.parent.parentæ˜¯æ‹¿åˆ°cçš„parent å³a.html
        window.parent.parent.location.hash = location.hash;
    </script>
</body>
```
```html
// c.html
<body>
    <h2>cé¡µé¢</h2>
    <script>
        console.log(decodeURIComponent(location.hash));
        let iframe = document.createElement('iframe');
        iframe.src = 'http://localhost:3000/b.html#æˆ‘æ˜¯cé¡µé¢';
        document.body.appendChild(iframe);
    </script>
</body>
```
```js
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(4000, () => {
    console.log('server run at port 4000');
});
```
### 7.3 document.domain + iframe
**è¯¥æ–¹å¼åªèƒ½ç”¨äºï¼šåŒä¸€ä¸ªä¸»åŸŸï¼Œä¸åŒå­åŸŸä¹‹é—´çš„æ“ä½œã€‚**
ä¸»åŸŸåç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚a.baidu.comå’Œb.baidu.comé€‚ç”¨äºè¯¥æ–¹å¼ã€‚

åªéœ€è¦ç»™é¡µé¢æ·»åŠ `document.domain = 'baidu.com'`ï¼Œè¡¨ç¤ºä¸»åŸŸåç›¸åŒå°±å¯ä»¥å®ç°è·¨åŸŸã€‚

å®ç°åŸç†ï¼šä¸¤ä¸ªé¡µé¢éƒ½é€šè¿‡jså¼ºåˆ¶è®¾ç½®document.domainä¸ºåŸºç¡€ä¸»åŸŸï¼Œå°±å®ç°äº†åŒåŸŸã€‚

æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼šé¡µé¢a.baidu.com:3000/a.htmlè·å–é¡µé¢b.baidu.com:3000/b.htmlä¸­açš„å€¼ã€‚
```html
<body>
    <!-- åŸŸå ä¸€çº§åŸŸåå’ŒäºŒçº§åŸŸå -->
    <!-- ä¸»åŸŸåï¼šbaidu.com -->
    <!-- www.baidu.com -->
    <!-- video.baidu.com -->
    <!-- a.htmlé€šè¿‡http://a.baidu.com:3000/a.html -->
    <iframe src="http://b.baidu.com:3000/b.html" id="iframe" onload="load()" frameborder="0"></iframe>
    <script>
        var str = 'lisi';
        document.domain = 'baidu.com';
        const iframe = document.querySelector('#iframe');
        function load() {
            console.log(iframe.contentWindow.a);
        }
    </script>
</body>
```
```html
<body>
    <script>
        document.domain = 'baidu.com';
        var a = 1000;
        // è®¿é—®çˆ¶é¡µé¢ä¸­çš„strå˜é‡
        console.log(window.parent.str); // lisi
    </script>
</body>
```
```js
const express = require('express');
const app = express();
// ä»¥å½“å‰ç›®å½•ä½œä¸ºé™æ€èµ„æºç›®å½•
app.use(express.static(__dirname));

app.listen(3000, () => {
    console.log('server run at port 3000');
});
```
## æ€»ç»“
* CORSæ”¯æŒæ‰€æœ‰ç±»å‹çš„HTTPè¯·æ±‚ï¼Œæ˜¯è·¨åŸŸHTTPè¯·æ±‚çš„æ ¹æœ¬è§£å†³æ–¹æ¡ˆï¼›
* JSONPåªæ”¯æŒGETè¯·æ±‚ï¼ŒJSONPçš„ä¼˜åŠ¿åœ¨äºæ”¯æŒè€å¼æµè§ˆå™¨ï¼Œä»¥åŠå¯ä»¥å‘ä¸æ”¯æŒCORSçš„ç½‘ç«™è¯·æ±‚æ•°æ®ï¼›
* ä¸ç®¡æ˜¯Nodeä¸­é—´ä»¶ä»£ç†è¿˜æ˜¯nginxåå‘ä»£ç†ï¼Œä¸»è¦æ˜¯é€šè¿‡åŒæºç­–ç•¥å¯¹æœåŠ¡å™¨ä¸åŠ é™åˆ¶ï¼›
* æ—¥å¸¸å·¥ä½œä¸­ï¼Œç”¨å¾—æ¯”è¾ƒå¤šçš„è·¨åŸŸæ–¹æ¡ˆæ˜¯corså’Œnginxåå‘ä»£ç†
## å‚è€ƒæ–‡æ¡£
1. [å‰ç«¯å¸¸è§è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆå…¨ï¼‰](https://segmentfault.com/a/1190000011145364)
2. [ä¹ç§è·¨åŸŸæ–¹å¼å®ç°åŸç†ï¼ˆå®Œæ•´ç‰ˆ\)](https://github.com/ljianshu/Blog/issues/55)
3. [è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£](http://www.ruanyifeng.com/blog/2016/04/cors.html)
4. [æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•](http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html)
5. [Nginxåå‘ä»£ç†è§£å†³è·¨åŸŸé—®é¢˜](https://segmentfault.com/a/1190000012859206)
6. [å‰ç«¯å¼€å‘å¦‚ä½•ç‹¬ç«‹è§£å†³è·¨åŸŸé—®é¢˜](https://segmentfault.com/a/1190000010719058#articleHeader15)