---
title: 2.æ‰‹å†™babelæ’ä»¶
---
::: tip
å†™ä½œä¸æ˜“ï¼ŒStaræ˜¯æœ€å¤§é¼“åŠ±ï¼Œæ„Ÿè§‰å†™çš„ä¸é”™çš„å¯ä»¥ç»™ä¸ªStarâ­ï¼Œè¯·å¤šå¤šæŒ‡æ•™ã€‚[æœ¬åšå®¢çš„Githubåœ°å€](https://github.com/liujie2019/VuePress-Blog)ã€‚
:::
## babelæ¦‚è¿°
babelå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼ŒæŠŠä¸€äº›çš„ä»£ç è½¬æˆæµè§ˆå™¨å¯ä»¥è¿è¡Œçš„ä»£ç ã€‚å…¶è½¬æ¢è¿‡ç¨‹å¯ä»¥åˆ†ä¸º3ä¸ªæ­¥éª¤ï¼š

1. æºç è§£æç”ŸæˆAST
2. ASTè½¬æ¢æˆæ–°çš„ASTï¼ˆbabelæ’ä»¶åœ¨æ­¤è¿‡ç¨‹å¯¹ä»£ç è¿›è¡Œæ”¹é€ ï¼‰
3. æ–°çš„ASTç”Ÿæˆæ–°çš„ä»£ç 

## AST(Abstract Syntax Tree

æˆ‘ä»¬çŸ¥é“ï¼Œbabelçš„ä½œç”¨å…¶å®å°±æ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼ŒæŠŠæˆ‘ä»¬çš„ä»£ç è½¬æˆæµè§ˆå™¨å¯ä»¥è¿è¡Œçš„ä»£ç ã€‚ç¼–è¯‘ä»£ç éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªæ–‡ä»¶çš„å¤„ç†ï¼ŒæŠŠä»£ç è¯»å‡ºæ¥ï¼Œç„¶åç»è¿‡å¤„ç†ï¼Œå†è¾“å‡ºï¼Œåœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­æ¯ä¸ªæ–‡ä»¶çš„ä»£ç å…¶å®å°±æ˜¯ä¸ªå¤§çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯æˆ‘ä»¬è¦æŠŠæœ‰äº›è¯­æ³•ä¿®æ”¹ï¼Œæ¯”å¦‚letå®šä¹‰å˜é‡æ”¹æˆvarå®šä¹‰ï¼Œå¾ˆæ˜æ˜¾ç”¨å­—ç¬¦ä¸²æ›¿æ¢æ˜¯ä¸ç°å®çš„ï¼Œè¿™é‡Œbabelæ˜¯æŠŠä»£ç è½¬æˆastè¯­æ³•æ ‘ï¼Œç„¶åç»è¿‡ä¸€ç³»åˆ—æ“ä½œä¹‹åå†è½¬æˆå­—ç¬¦ä¸²è¾“å‡ºã€‚

## å®ç°ç®­å¤´å‡½æ•°è½¬æ¢æ’ä»¶
æ’ä»¶åŠŸèƒ½ï¼š
1. æŠŠç®­å¤´å‡½æ•°è½¬æ¢æˆæ™®é€šfunctionï¼›
2. constè½¬æ¢æˆvarã€‚

```js
// æºä»£ç ä¸ºï¼š
const fn = (a, b) => a + b
// è½¬æ¢åçš„ç»“æœå¦‚ä¸‹ï¼š
var fn = function fn(a, b) {
  return a + b;
};
```
åˆ†æï¼š
é€šè¿‡[astexplorer](https://astexplorer.net/)å°†æºä»£ç è½¬ä¸ºASTï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<img :src="$withBase('/babel/plugin.png')" alt="">

ä»ä¸Šå›¾ä¸­å¯ä»¥å‘ç°æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªtypeå­—æ®µï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹çš„ç±»å‹ï¼ŒASTçš„èŠ‚ç‚¹ç±»å‹æœ‰å¾ˆå¤šï¼Œæ›´å¤šçš„typeå¯ä»¥åˆ°è¿™é‡Œ[èŠ‚ç‚¹ç±»å‹](https://github.com/babel/babylon/blob/master/ast/spec.md)æŸ¥çœ‹ã€‚

### å®ç°æ’ä»¶æ ¸å¿ƒæ–¹æ³•å’Œå·¥å…·
#### visitor
visitorå¯¹è±¡ç®€å•ç†è§£å°±æ˜¯ä¸€äº›ç›‘å¬å‡½æ•°çš„é›†åˆï¼Œå½“babelåœ¨å¤„ç†ASTçš„æ¯ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœåœ¨visitorä¸­å­˜åœ¨å£°æ˜æŸä¸ªèŠ‚ç‚¹ç±»å‹çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå½“babelå¤„ç†ASTæ­¤ç±»å‹èŠ‚ç‚¹æ—¶å°±ä¼šæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ï¼Œä¸¾ä¸ªğŸŒ°ï¼š
```js
visitor: {
    Identifier(path, state) { // å½“èŠ‚ç‚¹ç±»å‹ä¸ºidentifieræ—¶ï¼Œå°±ä¼šæ‰§è¡Œè¯¥æ–¹æ³•
        console.log('Called!');
    }
}
```
>å¦‚ä½•æ·»åŠ visitorå¯¹è±¡çš„èŠ‚ç‚¹ç›‘å¬æ–¹æ³•ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å°†è¦è½¬æ¢çš„æºç æ”¾åˆ°[astexplorer](https://astexplorer.net/)ä¸­è½¬æ¢æˆASTï¼Œç„¶åæ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹çš„typeå­—æ®µï¼Œtypeå­—æ®µçš„å€¼å°±æ˜¯å°±æˆ‘ä»¬è¦åœ¨visitorå¯¹è±¡é‡Œæ·»åŠ çš„æ–¹æ³•åç§°ã€‚

#### Path
åœ¨visitorå¯¹è±¡å£°æ˜çš„æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯pathï¼Œè¿™ä¸ªå‚æ•°ä¸­åŒ…å«äº†å½“å‰èŠ‚ç‚¹çš„ä¿¡æ¯ä»¥åŠå¯¹èŠ‚ç‚¹çš„æ·»åŠ ã€æ›´æ–°ã€ç§»åŠ¨å’Œåˆ é™¤ç­‰æ–¹æ³•ã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯è§[pathæºç ](https://github.com/babel/babel/blob/master/packages/babel-traverse/src/path/index.js)ã€‚

#### @babel/types
`@babel/types`æ˜¯ç”¨äºå¤„ç†ASTèŠ‚ç‚¹çš„å·¥å…·åº“ï¼ŒåŒ…å«äº†æ„é€ ã€éªŒè¯ASTèŠ‚ç‚¹ç­‰æ–¹æ³•ã€‚å…·ä½“è¯·å‚è€ƒ[@babel/typesç›¸å…³API](https://babeljs.io/docs/en/babel-types#blockstatement)
### å®ç°ç®­å¤´å‡½æ•°è½¬æ¢ä¸ºfunctionå‡½æ•°
ç¬¬ä¸€æ­¥ï¼šç»™visitorå¯¹è±¡æ·»åŠ å¯¹åº”èŠ‚ç‚¹çš„ç›‘å¬æ–¹æ³•ã€‚å¯ä»¥ä»ASTä¸­æ‰¾åˆ°ç®­å¤´å‡½æ•°ç±»å‹çš„ç›‘å¬æ–¹æ³•çš„å†™æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<img :src="$withBase('/babel/plugin1.png')" alt="">

ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºç®­å¤´å‡½æ•°ç±»å‹æ˜¯ArrowFunctionExpressionï¼Œæ‰€ä»¥visitoré‡Œçš„å†™æ³•å¦‚ä¸‹ï¼š
```js
visitor: {
  ArrowFunctionExpression: (path, state) => {}
}
```
ç¬¬äºŒæ­¥ï¼šè½¬æ¢ASTã€‚è¦å°†ç®­å¤´å‡½æ•°è½¬æ¢ä¸ºfunctionæ™®é€šå‡½æ•°ï¼Œéœ€è¦ä½¿ç”¨`@babel/types`çš„functionå‡½æ•°æ„é€ æ–¹æ³•æ¥æ„é€ ä¸€ä¸ªfunctionå‡½æ•°èŠ‚ç‚¹ï¼Œç„¶åå°†åŸæ¥çš„ç®­å¤´å‡½æ•°èŠ‚ç‚¹æ›¿æ¢æ‰å³å¯ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•è§[@babel/types](https://babeljs.io/docs/en/babel-types#functionexpression)ã€‚

<img :src="$withBase('/babel/plugin2.png')" alt="">

### å®ç°constè½¬æ¢æˆvar
ç¬¬ä¸€æ­¥ï¼šç»™visitorå¯¹è±¡æ·»åŠ å¯¹åº”èŠ‚ç‚¹çš„ç›‘å¬æ–¹æ³•ã€‚å¯ä»¥ä»ASTä¸­æ‰¾åˆ°å˜é‡å£°æ˜çš„typeä¸ºVariableDeclarationï¼Œå³visitorå¯¹è±¡å¯¹åº”çš„æ–¹æ³•åã€‚
```js
visitor: {
  VariableDeclaration: (path, state) => {}
}
```
ç¬¬äºŒæ­¥ï¼šè½¬æ¢AST
<img :src="$withBase('/babel/plugin3.png')" alt="">

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šVariableDeclarationç±»å‹çš„èŠ‚ç‚¹æœ‰ä¸€ä¸ªå˜é‡kindæ ‡è¯†ç€å£°æ˜å˜é‡çš„æ–¹å¼ï¼Œæ‰€ä»¥è¦å®ç°å°†constè½¬æ¢ä¸ºvarï¼Œé‚£å¯ä»¥ç›´æ¥åœ¨visitoré‡Œç›‘å¬çš„VariableDeclarationæ–¹æ³•å°†è¯¥èŠ‚ç‚¹çš„kindå±æ€§èµ‹å€¼ä¸ºvarå³å¯ï¼š
```js
visitor: {
  VariableDeclaration: (path, state) => {
      const {node} = path;
      if (node.kind === 'const' || node.kind === 'let') {
          node.kind = 'var'; // æ–¹å¼1ï¼šç›´æ¥æ›¿æ¢
      }
  }
}
```
é™¤äº†ä¸Šè¿°ç›´æ¥æ›¿æ¢çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ›¿æ¢å½“å‰èŠ‚ç‚¹çš„æ–¹å¼æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚ä¸Šæ–‡è¯´è¿‡`@babel/types`ç”¨äºå¤„ç†ASTèŠ‚ç‚¹çš„å·¥å…·åº“ï¼ŒåŒ…å«äº†æ„é€ ã€éªŒè¯ASTèŠ‚ç‚¹ç­‰æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨`@babel/types`å®šä¹‰çš„æ„é€ æ–¹æ³•æ¥æ„é€ ä¸€ä¸ªvariableDeclarationèŠ‚ç‚¹ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š
```js
visitor: {
  VariableDeclaration: (path, state) => {
      const {node} = path;
      if (node.kind === 'const' || node.kind === 'let') {
          // åŸºäº@babel/typesçš„VariableDeclarationæ–¹æ³•æ„é€ ä¸€ä¸ªvariableDeclarationèŠ‚ç‚¹
          const variableDeclaration = type.VariableDeclaration('var', node.declarations)
          // replaceWithä¸ºæ›¿æ¢èŠ‚ç‚¹çš„æ–¹æ³•
          path.replaceWith(variableDeclaration);
      }
  }
}
```

æœ€ç»ˆå®ç°å¦‚ä¸‹ï¼š
```js
const babel = require('@babel/core');
const type = require('@babel/types');

const transformArrowFunction = {
    // è¯¥visitoråŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ç›‘å¬æ–¹æ³•VariableDeclarationå’ŒArrowFunctionExpression
    visitor: {
        // å°†constå’Œletè½¬æ¢ä¸ºvar
        // æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªtypeå­—æ®µï¼Œtypeå€¼ä¸ºVariableDeclarationä¼šè¢«åŒ¹é…æˆåŠŸ
        VariableDeclaration: (path, state) => {
            const {node} = path;
            if (node.kind === 'const' || node.kind === 'let') {
                // node.kind = 'var'; // æ–¹å¼1ï¼šç›´æ¥æ›¿æ¢
                // æ–¹å¼2ï¼šé‡‡ç”¨replaceWith
                // åŸºäº@babel/typesçš„VariableDeclarationæ–¹æ³•æ„é€ ä¸€ä¸ªvariableDeclarationèŠ‚ç‚¹
                const variableDeclaration = type.VariableDeclaration('var', node.declarations)
                // replaceWithä¸ºæ›¿æ¢èŠ‚ç‚¹çš„æ–¹æ³•
                path.replaceWith(variableDeclaration);
            }
        },
        // Visitorä¸­çš„æ¯ä¸ªå‡½æ•°æ¥æ”¶2ä¸ªå‚æ•°ï¼špathå’Œstate
        // pathæ˜¯è¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿æ¥çš„å¯¹è±¡
        ArrowFunctionExpression: (path, state) => {
            // console.log(path);
            // nodeå°±æ˜¯ArrowFunctionExpressionåŒ¹é…åˆ°çš„å½“å‰èŠ‚ç‚¹
            // parentæ˜¯å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹
            const {node, parent} = path;
            const id = parent.id;
            const params = node.params; // è·å–å‚æ•°
            // å°†BinaryExpressionè½¬æ¢ä¸ºBlockStatement
            const body = type.blockStatement([
                type.returnStatement(node.body)
            ]);
            // ç”Ÿæˆå¯¹åº”çš„functionExpression
            const functionExpression = type.functionExpression(id, params, body, false, false);
            // èŠ‚ç‚¹æ›¿æ¢ï¼Œå°†åŒ¹é…åˆ°çš„ArrowFunctionExpressionæ›¿æ¢ä¸ºæ–°ç”Ÿæˆçš„FunctionExpression
            path.replaceWith(functionExpression);
        }
    }
};

const code = 'const fn = (a, b) => a + b';
const result = babel.transform(code, {
    plugins: [
        transformArrowFunction
    ]
});

console.log(result.code);
```
## é¢„è®¡ç®—æ’ä»¶
```js
const babel = require('@babel/core');
const type = require('@babel/types');
const code = 'const num = 2 * 3 * 4 * 5';

const preCalculatePlugin = {
    visitor: {
        BinaryExpression: (path, state) => {
            const node = path.node;
            const {left, right, operator} = node;
            if (!isNaN(left.value) && !isNaN(right.value)) {
                let result = eval(left.value + operator + right.value);
                result = type.numericLiteral(result);
                path.replaceWith(result);
                // å¦‚æœå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¹Ÿæ˜¯è¡¨è¾¾å¼çš„è¯ï¼Œéœ€è¦é€’å½’è®¡ç®—
                if (path.parentPath.node.type === 'BinaryExpression') {
                    preCalculatePlugin.visitor.BinaryExpression.call(null, path.parentPath);
                }
            }
        }
    }
}

const res = babel.transform(code, {
    plugins: [preCalculatePlugin]
});

console.log(res.code); // const num = 120;
```
## å®ç°æŒ‰éœ€åŠ è½½æ’ä»¶
### é»˜è®¤å¯¼å…¥ä¸åšå¤„ç†
<img :src="$withBase('/babel/plugin6.png')" alt="">

ä¸Šå›¾å¯¼å…¥çš„æ–¹å¼ä¸ºé»˜è®¤å¯¼å…¥ï¼Œä¸åšå¤„ç†ã€‚
```js
// åˆ¤æ–­æ˜¯å¦æ˜¯é»˜è®¤å¯¼å…¥
types.isImportDefaultSpecifier(specifiers[0]
```
<img :src="$withBase('/babel/plugin4.png')" alt="">
<img :src="$withBase('/babel/plugin5.png')" alt="">

ä»ä¸Šé¢ä¸¤ä¸ªå›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºä¸¤ç§å¯¼å…¥æ–¹å¼çš„åŒºåˆ«åœ¨äºspecifiersçš„ç±»å‹ä¸åŒã€‚å› æ­¤ï¼Œåªè¦é‡æ–°ç”ŸæˆnewImportSpecifierså³å¯ï¼Œæœ€ç»ˆä»£ç å®ç°å¦‚ä¸‹ï¼š
```js
const types = require('@babel/types');

const visitor = {
    // è¿™é‡Œçš„refæ˜¯ImportDeclarationçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå€¼æ˜¯.babelrcä¸­çš„{"library": "lodash"}
    ImportDeclaration(path, ref = {opts: {}}) {
        const {opts} = ref;
        const node = path.node; // æ‹¿åˆ°å½“å‰èŠ‚ç‚¹
        const specifiers = node.specifiers;
        // isImportDefaultSpecifieråˆ¤æ–­æ˜¯å¦æ˜¯é»˜è®¤å¯¼å…¥ï¼Œæ˜¯çš„è¯ä¸åšå¤„ç†
        if (opts.library === node.source.value && !types.isImportDefaultSpecifier(specifiers[0])) {
            const newImportSpecifiers = specifiers.map(specifier => (
                    types.importDeclaration([types.ImportDefaultSpecifier(specifier.local)],
                    types.stringLiteral(`${node.source.value}/${specifier.local.name}`
                ))
            ));
            path.replaceWithMultiple(newImportSpecifiers);
        }
    }
}

module.exports = () => {
    return {visitor};
}
```
```js
// .babelrcé…ç½®ï¼š
{
    "presets": ["@babel/preset-env"],
    "plugins": [
        [
            "dynamic-import",
            {
                "library": "lodash" // å¼•ç”¨å“ªä¸ªåº“çš„æ—¶å€™ä½¿ç”¨æˆ‘ä»¬å†™çš„è¿™ä¸ªæ’ä»¶
            }
        ]
    ]
}
```
æœ€åå°†ç¼–å†™å¥½çš„æ’ä»¶æ”¾å…¥åˆ°`/node_modules/babel-plugin-dynamic-import/`æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶åœ¨package.jsonæ–‡ä»¶ä¸­æŒ‡æ˜å…¥å£ã€‚

æ²¡æœ‰æŒ‰éœ€åŠ è½½å‰çš„æ‰“åŒ…ç»“æœå¦‚ä¸‹ï¼š
```js
yarn run v1.16.0
$ webpack --mode development
Hash: 8e4da5b2edbe6c47dd1c
Version: webpack 4.41.2
Time: 325ms
Built at: 2019-11-13 19:45:03
    Asset     Size  Chunks             Chunk Names
bundle.js  552 KiB    main  [emitted]  main
Entrypoint main = bundle.js
[./node_modules/webpack/buildin/global.js] (webpack)/buildin/global.js 472 bytes {main} [built]
[./node_modules/webpack/buildin/module.js] (webpack)/buildin/module.js 497 bytes {main} [built]
[./src/index.js] 37 bytes {main} [built]
    + 1 hidden module
âœ¨  Done in 1.53s.
```
é‡‡ç”¨æŒ‰éœ€åŠ è½½å‰çš„æ‰“åŒ…ç»“æœå¦‚ä¸‹ï¼š
```js
yarn run v1.16.0
$ webpack --mode development
Hash: 58ece130df8aef56b95d
Version: webpack 4.41.2
Time: 105ms
Built at: 2019-11-13 19:46:28
    Asset      Size  Chunks             Chunk Names
bundle.js  20.9 KiB    main  [emitted]  main
Entrypoint main = bundle.js
[./node_modules/webpack/buildin/global.js] (webpack)/buildin/global.js 472 bytes {main} [built]
[./src/index.js] 110 bytes {main} [built]
    + 15 hidden modules
âœ¨  Done in 0.67s.
```
### æ³¨æ„äº‹é¡¹
1. babelæ’ä»¶çš„æ–‡ä»¶å¤¹å‘½åï¼Œå¿…é¡»ä»¥babel-plugin-xxxå‘½åï¼Œå¦åˆ™å¼•å…¥ä¸æˆåŠŸï¼›
2. babelæ’ä»¶è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªvisitorå¯¹è±¡ã€‚

## æ€»ç»“
æ’ä»¶å…¶å®å°±æ˜¯åŸºäºæºä»£ç çš„ASTï¼Œåˆ©ç”¨ä¸€äº›å·¥å…·ç”Ÿæˆç›®æ ‡ä»£ç çš„ASTçš„è¿‡ç¨‹ã€‚
## å‚è€ƒæ–‡æ¡£
1. [Babel æ’ä»¶å¼€å‘æŒ‡å—](https://github.com/brigand/babel-plugin-handbook/blob/master/translations/zh-Hans/README.md#babylon)
2. [Babel æ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—](http://web.jobbole.com/94758/?utm_source=blog.jobbole.com&utm_medium=relatedPosts)
3. [è‡ªå·±å†™ä¸€ä¸ªBabelæ’ä»¶](https://www.colabug.com/4556670.html)
4. [ç†è§£ Babel æ’ä»¶](http://taobaofed.org/blog/2016/09/30/babel-plugins/)
5. [Babelæ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—](https://www.colabug.com/3050689.html)
6. [Babelæ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—](https://www.cnblogs.com/chyingp/p/how-to-write-a-babel-plugin.html)
7. [åŸæ¥babelæ’ä»¶æ˜¯è¿™æ ·å†™çš„](https://juejin.im/post/5d5bdb02e51d4561db5e3a52#heading-1)