---
title: 2. æ‰‹å†™babelæ’ä»¶
---
[TOC]
::: tip
å†™ä½œä¸æ˜“ï¼ŒStaræ˜¯æœ€å¤§é¼“åŠ±ï¼Œæ„Ÿè§‰å†™çš„ä¸é”™çš„å¯ä»¥ç»™ä¸ªStarâ­ï¼Œè¯·å¤šå¤šæŒ‡æ•™ã€‚[æœ¬åšå®¢çš„Githubåœ°å€](https://github.com/liujie2019/VuePress-Blog)ã€‚
:::
## babelæ¦‚è¿°
babelå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼ŒæŠŠä¸€äº›ä»£ç è½¬æˆæµè§ˆå™¨å¯ä»¥è¿è¡Œçš„ä»£ç ã€‚å…¶è½¬æ¢è¿‡ç¨‹å¯ä»¥åˆ†ä¸º3ä¸ªæ­¥éª¤ï¼š
1. æºç è§£æç”ŸæˆASTï¼šå°†ä»£ç è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œæ¯ä¸ªjså¼•æ“ï¼ˆæ¯”å¦‚Chromeæµè§ˆå™¨ä¸­çš„V8å¼•æ“ï¼‰éƒ½æœ‰è‡ªå·±çš„ASTè§£æå™¨ï¼Œè€ŒBabelæ˜¯é€šè¿‡Babylonå®ç°çš„ã€‚åœ¨è§£æè¿‡ç¨‹ä¸­æœ‰ä¸¤ä¸ªé˜¶æ®µï¼šè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æï¼Œè¯æ³•åˆ†æé˜¶æ®µæŠŠå­—ç¬¦ä¸²å½¢å¼çš„ä»£ç è½¬æ¢ä¸ºä»¤ç‰Œï¼ˆtokensï¼‰æµï¼Œä»¤ç‰Œç±»ä¼¼äºASTä¸­èŠ‚ç‚¹ï¼›è€Œè¯­æ³•åˆ†æé˜¶æ®µåˆ™ä¼šæŠŠä¸€ä¸ªä»¤ç‰Œæµè½¬æ¢æˆ ASTçš„å½¢å¼ï¼ŒåŒæ—¶è¿™ä¸ªé˜¶æ®µä¼šæŠŠä»¤ç‰Œä¸­çš„ä¿¡æ¯è½¬æ¢æˆASTçš„è¡¨è¿°ç»“æ„ã€‚
2. ASTè½¬æ¢æˆæ–°çš„ASTï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼ŒBabelæ¥å—å¾—åˆ°ASTå¹¶é€šè¿‡babel-traverseå¯¹å…¶è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€æ›´æ–°åŠç§»é™¤æ“ä½œã€‚è¿™éƒ¨åˆ†ä¹Ÿæ˜¯Babelæ’ä»¶ä»‹å…¥å·¥ä½œçš„éƒ¨åˆ†ã€‚
3. ç”¨æ–°çš„ASTç”Ÿæˆæ–°çš„ä»£ç ï¼šå°†ç»è¿‡è½¬æ¢çš„ASTé€šè¿‡babel-generatorå†è½¬æ¢æˆjsä»£ç ï¼Œè¿‡ç¨‹å°±æ˜¯æ·±åº¦ä¼˜å…ˆéå†æ•´ä¸ªASTï¼Œç„¶åæ„å»ºå¯ä»¥è¡¨ç¤ºè½¬æ¢åä»£ç çš„å­—ç¬¦ä¸²ã€‚

## AST(Abstract Syntax Tree)
æˆ‘ä»¬çŸ¥é“ï¼Œbabelçš„ä½œç”¨å…¶å®å°±æ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼ŒæŠŠæˆ‘ä»¬çš„ä»£ç è½¬æˆæµè§ˆå™¨å¯ä»¥è¿è¡Œçš„ä»£ç ã€‚ç¼–è¯‘ä»£ç éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªæ–‡ä»¶çš„å¤„ç†ï¼ŒæŠŠä»£ç è¯»å‡ºæ¥ï¼Œç„¶åç»è¿‡å¤„ç†ï¼Œå†è¾“å‡ºï¼Œåœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­æ¯ä¸ªæ–‡ä»¶çš„ä»£ç å…¶å®å°±æ˜¯ä¸ªå¤§çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯æˆ‘ä»¬è¦æŠŠæœ‰äº›è¯­æ³•ä¿®æ”¹ï¼Œæ¯”å¦‚letå®šä¹‰å˜é‡æ”¹æˆvarå®šä¹‰ï¼Œå¾ˆæ˜æ˜¾ç”¨å­—ç¬¦ä¸²æ›¿æ¢æ˜¯ä¸ç°å®çš„ï¼Œè¿™é‡Œbabelæ˜¯æŠŠä»£ç è½¬æˆastè¯­æ³•æ ‘ï¼Œç„¶åç»è¿‡ä¸€ç³»åˆ—æ“ä½œä¹‹åå†è½¬æˆå­—ç¬¦ä¸²è¾“å‡ºã€‚

## è®¿é—®è€…æ¨¡å¼
è®¿é—®è€…æ¨¡å¼æ˜¯ä¸€ç§å°†ç®—æ³•ä¸å¯¹è±¡ç»“æ„åˆ†ç¦»çš„è½¯ä»¶è®¾è®¡æ¨¡å¼ã€‚

è¿™ä¸ªæ¨¡å¼çš„åŸºæœ¬æƒ³æ³•å¦‚ä¸‹ï¼šé¦–å…ˆæˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªç”±è®¸å¤šå¯¹è±¡æ„æˆçš„å¯¹è±¡ç»“æ„ï¼Œè¿™äº›å¯¹è±¡çš„ç±»éƒ½æ‹¥æœ‰ä¸€ä¸ªacceptæ–¹æ³•ç”¨æ¥æ¥å—è®¿é—®è€…å¯¹è±¡ï¼›è®¿é—®è€…æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªvisitæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹è®¿é—®åˆ°çš„å¯¹è±¡ç»“æ„ä¸­ä¸åŒç±»å‹çš„å…ƒç´ ä½œå‡ºä¸åŒçš„ååº”ï¼›åœ¨å¯¹è±¡ç»“æ„çš„ä¸€æ¬¡è®¿é—®è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éå†æ•´ä¸ªå¯¹è±¡ç»“æ„ï¼Œå¯¹æ¯ä¸€ä¸ªå…ƒç´ éƒ½å®æ–½acceptæ–¹æ³•ï¼Œåœ¨æ¯ä¸€ä¸ªå…ƒç´ çš„acceptæ–¹æ³•ä¸­å›è°ƒè®¿é—®è€…çš„visitæ–¹æ³•ï¼Œä»è€Œä½¿è®¿é—®è€…å¾—ä»¥å¤„ç†å¯¹è±¡ç»“æ„çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥é’ˆå¯¹å¯¹è±¡ç»“æ„è®¾è®¡ä¸åŒçš„è®¿é—®è€…ç±»æ¥å®Œæˆä¸åŒçš„æ“ä½œã€‚â€”â€”â€”â€” ç»´åŸºç™¾ç§‘

å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬çš„ASTçš„æ¯ä¸€ä¸ªNodeæœ‰ä¸€ä¸ªacceptæ–¹æ³•ï¼Œå½“æˆ‘ä»¬ç”¨ä¸€ä¸ª visitor æ¥éå†æˆ‘ä»¬çš„ AST æ—¶ï¼Œæ¯éå†åˆ°ä¸€ä¸ª Node å°±ä¼šè°ƒç”¨è¿™ä¸ª Node çš„ accept æ–¹æ³•æ¥æ¥å¾…è¿™ä¸ªvisitorï¼Œè€Œåœ¨ accept æ–¹æ³•å†…ï¼Œæˆ‘ä»¬ä¼šå›è°ƒ visitor çš„ visit æ–¹æ³•ã€‚æˆ‘ä»¬æ¥ç”¨è®¿é—®è€…æ¨¡å¼æ¥å®ç°ä¸€ä¸ªæ—…è¡Œè€…è®¿é—®åŸå¸‚æ™¯ç‚¹çš„é€»è¾‘ã€‚

å®é™…ä¸ŠNodeæ˜¯æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œenterå’Œexitï¼ŒæŒ‡éå†è¿›å…¥å’Œç¦»å¼€ Node çš„æ—¶å€™ã€‚é€šå¸¸è®¿é—®è€…çš„ visit æ–¹æ³•ä¼šåœ¨ enter å†…è¢«è°ƒç”¨ã€‚
### Visitorsï¼ˆè®¿é—®è€…ï¼‰
å½“æˆ‘ä»¬è°ˆåŠâ€œè¿›å…¥â€ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®é™…ä¸Šæ˜¯è¯´æˆ‘ä»¬åœ¨è®¿é—®å®ƒä»¬ï¼Œ ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·çš„æœ¯è¯­æ˜¯å› ä¸ºæœ‰ä¸€ä¸ªè®¿é—®è€…æ¨¡å¼ï¼ˆvisitorï¼‰çš„æ¦‚å¿µã€‚

è®¿é—®è€…æ˜¯ä¸€ä¸ªç”¨äº AST éå†çš„è·¨è¯­è¨€çš„æ¨¡å¼ã€‚ ç®€å•çš„è¯´å®ƒä»¬å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®šä¹‰äº†ç”¨äºåœ¨ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ä¸­è·å–å…·ä½“èŠ‚ç‚¹çš„æ–¹æ³•ã€‚ è¿™ä¹ˆè¯´æœ‰äº›æŠ½è±¡æ‰€ä»¥è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚
```js
const MyVisitor = {
  Identifier() {
    console.log("Called!");
  }
};
```
>æ³¨æ„ï¼š Identifier() { ... } æ˜¯ Identifier: { enter() { ... } } çš„ç®€å†™å½¢å¼ã€‚

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è®¿é—®è€…ï¼ŒæŠŠå®ƒç”¨äºéå†ä¸­æ—¶ï¼Œæ¯å½“åœ¨æ ‘ä¸­é‡è§ä¸€ä¸ª Identifier çš„æ—¶å€™ä¼šè°ƒç”¨ Identifier() æ–¹æ³•ã€‚

æ‰€ä»¥åœ¨ä¸‹é¢çš„ä»£ç ä¸­ Identifier() æ–¹æ³•ä¼šè¢«è°ƒç”¨å››æ¬¡ï¼ˆåŒ…æ‹¬ square åœ¨å†…ï¼Œæ€»å…±æœ‰å››ä¸ª Identifierï¼‰ã€‚)
```js
function square(n) {
  return n * n;
}
```
```js
Called!
Called!
Called!
Called!
```
è¿™äº›è°ƒç”¨éƒ½å‘ç”Ÿåœ¨è¿›å…¥èŠ‚ç‚¹æ—¶ï¼Œä¸è¿‡æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é€€å‡ºæ—¶è°ƒç”¨è®¿é—®è€…æ–¹æ³•ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼š
```js
- FunctionDeclaration
  - Identifier (id)
  - Identifier (params[0])
  - BlockStatement (body)
    - ReturnStatement (body)
      - BinaryExpression (argument)
        - Identifier (left)
        - Identifier (right)
```
å½“æˆ‘ä»¬å‘ä¸‹éå†è¿™é¢—æ ‘çš„æ¯ä¸€ä¸ªåˆ†æ”¯æ—¶æˆ‘ä»¬æœ€ç»ˆä¼šèµ°åˆ°å°½å¤´ï¼Œäºæ˜¯æˆ‘ä»¬éœ€è¦å¾€ä¸Šéå†å›å»ä»è€Œè·å–åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ å‘ä¸‹éå†è¿™æ£µæ ‘æˆ‘ä»¬è¿›å…¥æ¯ä¸ªèŠ‚ç‚¹ï¼Œå‘ä¸Šéå†å›å»æ—¶æˆ‘ä»¬é€€å‡ºæ¯ä¸ªèŠ‚ç‚¹ã€‚

è®©æˆ‘ä»¬ä»¥ä¸Šé¢é‚£æ£µæ ‘ä¸ºä¾‹å­èµ°ä¸€éè¿™ä¸ªè¿‡ç¨‹ã€‚
* è¿›å…¥ FunctionDeclaration
    * è¿›å…¥ Identifier (id)
    * èµ°åˆ°å°½å¤´
    * é€€å‡º Identifier (id)
    * è¿›å…¥ Identifier (params[0])
    * èµ°åˆ°å°½å¤´
    * é€€å‡º Identifier (params[0])
    * è¿›å…¥ BlockStatement (body)
        * è¿›å…¥ ReturnStatement (body)
        * è¿›å…¥ BinaryExpression (argument)
        * è¿›å…¥ Identifier (left)
            * èµ°åˆ°å°½å¤´
        * é€€å‡º Identifier (left)
        * è¿›å…¥ Identifier (right)
            * èµ°åˆ°å°½å¤´
        * é€€å‡º Identifier (right)
        * é€€å‡º BinaryExpression (argument)
    * é€€å‡º ReturnStatement (body)
    * é€€å‡º BlockStatement (body)
* é€€å‡º FunctionDeclaration

æ‰€ä»¥å½“åˆ›å»ºè®¿é—®è€…æ—¶ä½ å®é™…ä¸Šæœ‰ä¸¤æ¬¡æœºä¼šæ¥è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹ã€‚
```js
const MyVisitor = {
  Identifier: {
    enter() {
      console.log("Entered!");
    },
    exit() {
      console.log("Exited!");
    }
  }
};
```
## éå†
æƒ³è¦è½¬æ¢ASTä½ éœ€è¦è¿›è¡Œé€’å½’çš„æ ‘å½¢éå†ã€‚

æ¯”å¦‚ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ª FunctionDeclaration ç±»å‹ã€‚å®ƒæœ‰å‡ ä¸ªå±æ€§ï¼šidï¼Œparamsï¼Œå’Œ bodyï¼Œæ¯ä¸€ä¸ªéƒ½æœ‰ä¸€äº›å†…åµŒèŠ‚ç‚¹ã€‚
```js
{
  type: "FunctionDeclaration",
  id: {
    type: "Identifier",
    name: "square"
  },
  params: [{
    type: "Identifier",
    name: "n"
  }],
  body: {
    type: "BlockStatement",
    body: [{
      type: "ReturnStatement",
      argument: {
        type: "BinaryExpression",
        operator: "*",
        left: {
          type: "Identifier",
          name: "n"
        },
        right: {
          type: "Identifier",
          name: "n"
        }
      }
    }]
  }
}
```
## å®ç°ç®­å¤´å‡½æ•°è½¬æ¢æ’ä»¶
* @Babel/typeï¼šç±»ä¼¼lodashé‚£æ ·çš„å·¥å…·é›†ï¼Œä¸»è¦ç”¨æ¥æ“ä½œASTèŠ‚ç‚¹ï¼Œæ¯”å¦‚åˆ›å»ºã€æ ¡éªŒã€è½¬å˜ç­‰ã€‚ä¸¾ä¾‹ï¼šåˆ¤æ–­æŸä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯æ ‡è¯†ç¬¦(identifier)ã€‚
* pathï¼šASTä¸­æœ‰å¾ˆå¤šèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯èƒ½æœ‰ä¸åŒçš„å±æ€§ï¼Œå¹¶ä¸”èŠ‚ç‚¹ä¹‹é—´å¯èƒ½å­˜åœ¨å…³è”ã€‚pathæ˜¯ä¸ªå¯¹è±¡ï¼Œå®ƒä»£è¡¨äº†ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å…³è”ã€‚ä½ å¯ä»¥åœ¨pathä¸Šè®¿é—®åˆ°èŠ‚ç‚¹çš„å±æ€§ï¼Œä¹Ÿå¯ä»¥é€šè¿‡pathæ¥è®¿é—®åˆ°å…³è”çš„èŠ‚ç‚¹ï¼ˆæ¯”å¦‚çˆ¶èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹ç­‰ï¼‰
* stateï¼šä»£è¡¨äº†æ’ä»¶çš„çŠ¶æ€ï¼Œä½ å¯ä»¥é€šè¿‡stateæ¥è®¿é—®æ’ä»¶çš„é…ç½®é¡¹ã€‚
* visitorï¼šBabelé‡‡å–é€’å½’çš„æ–¹å¼è®¿é—®ASTçš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œä¹‹æ‰€ä»¥å«åšvisitorï¼Œåªæ˜¯å› ä¸ºæœ‰ä¸ªç±»ä¼¼çš„è®¾è®¡æ¨¡å¼å«åšè®¿é—®è€…æ¨¡å¼ï¼Œä¸ç”¨åœ¨æ„èƒŒåçš„ç»†èŠ‚ã€‚
* Identifierï¼šASTçš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œéƒ½æœ‰å¯¹åº”çš„èŠ‚ç‚¹ç±»å‹ï¼Œæ¯”å¦‚æ ‡è¯†ç¬¦ï¼ˆIdentifierï¼‰ã€å‡½æ•°å£°æ˜ï¼ˆFunctionDeclarationï¼‰ç­‰ï¼Œå¯ä»¥åœ¨visitorä¸Šå£°æ˜åŒåçš„å±æ€§ï¼Œå½“Babeléå†åˆ°ç›¸åº”ç±»å‹çš„èŠ‚ç‚¹ï¼Œå±æ€§å¯¹åº”çš„æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œä¼ å…¥çš„å‚æ•°å°±æ˜¯pathã€stateã€‚

æ’ä»¶åŠŸèƒ½ï¼š
1. æŠŠç®­å¤´å‡½æ•°è½¬æ¢æˆæ™®é€šfunctionï¼›
2. constè½¬æ¢æˆvarã€‚

```js
// æºä»£ç ä¸ºï¼š
const fn = (a, b) => a + b
// è½¬æ¢åçš„ç»“æœå¦‚ä¸‹ï¼š
var fn = function fn(a, b) {
  return a + b;
};
```
åˆ†æï¼š
é€šè¿‡[astexplorer](https://astexplorer.net/)å°†æºä»£ç è½¬ä¸ºASTï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![](./assets/plugin.png)

ä»ä¸Šå›¾ä¸­å¯ä»¥å‘ç°ï¼š**æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªtypeå­—æ®µï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹çš„ç±»å‹**ï¼Œï¼ˆå¦‚ï¼š"FunctionDeclaration"ï¼Œ"Identifier"ï¼Œæˆ– "BinaryExpression"ï¼‰ã€‚ASTçš„èŠ‚ç‚¹ç±»å‹æœ‰å¾ˆå¤šï¼Œæ›´å¤šçš„typeå¯ä»¥åˆ°è¿™é‡Œ[èŠ‚ç‚¹ç±»å‹](https://github.com/babel/babylon/blob/master/ast/spec.md)æŸ¥çœ‹ã€‚

### å®ç°æ’ä»¶æ ¸å¿ƒæ–¹æ³•å’Œå·¥å…·
#### visitor
visitorå¯¹è±¡ç®€å•ç†è§£å°±æ˜¯**ä¸€äº›ç›‘å¬å‡½æ•°çš„é›†åˆ**ï¼Œå½“babelåœ¨å¤„ç†ASTçš„æ¯ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœåœ¨visitorä¸­å­˜åœ¨å£°æ˜æŸä¸ªèŠ‚ç‚¹ç±»å‹çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå½“babelå¤„ç†ASTæ­¤ç±»å‹èŠ‚ç‚¹æ—¶å°±ä¼šæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ï¼Œä¸¾ä¸ªğŸŒ°ï¼š
```js
visitor: {
    Identifier(path, state) { // å½“èŠ‚ç‚¹ç±»å‹ä¸ºidentifieræ—¶ï¼Œå°±ä¼šæ‰§è¡Œè¯¥æ–¹æ³•
        console.log('Called!');
    }
}
```
#### å¦‚ä½•æ·»åŠ visitorå¯¹è±¡çš„èŠ‚ç‚¹ç›‘å¬æ–¹æ³•ï¼Ÿ
æˆ‘ä»¬å¯ä»¥å°†éœ€è¦è½¬æ¢çš„æºç æ”¾åˆ°[astexplorer](https://astexplorer.net/)ä¸­è½¬æ¢æˆASTï¼Œç„¶åæ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹çš„typeå­—æ®µï¼Œtypeå­—æ®µçš„å€¼å°±æ˜¯å°±æˆ‘ä»¬è¦åœ¨visitorå¯¹è±¡é‡Œæ·»åŠ çš„æ–¹æ³•åç§°ã€‚
### Path
Pathæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒè¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥ã€‚åœ¨visitorå¯¹è±¡å£°æ˜çš„æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯pathï¼Œæ˜¯æ•è·åˆ°çš„èŠ‚ç‚¹å¯¹åº”çš„ä¿¡æ¯ï¼ŒåŒ…å«äº†å½“å‰èŠ‚ç‚¹çš„ä¿¡æ¯ä»¥åŠå¯¹èŠ‚ç‚¹çš„æ·»åŠ ã€æ›´æ–°ã€ç§»åŠ¨å’Œåˆ é™¤ç­‰æ–¹æ³•ã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯è§[pathæºç ](https://github.com/babel/babel/blob/master/packages/babel-traverse/src/path/index.js)ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡path.nodeè·å¾—è¿™ä¸ªèŠ‚ç‚¹çš„ASTï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹å°±èƒ½å®Œæˆäº†æˆ‘ä»¬çš„ç›®æ ‡ã€‚
```js
â”€â”€ å±æ€§
  - node   å½“å‰èŠ‚ç‚¹
  - parent  çˆ¶èŠ‚ç‚¹
  - parentPath çˆ¶path
  - scope   ä½œç”¨åŸŸ
  - context  ä¸Šä¸‹æ–‡
  - ...
â”€â”€ æ–¹æ³•
  - get   å½“å‰èŠ‚ç‚¹
  - findParent  å‘çˆ¶èŠ‚ç‚¹æœå¯»èŠ‚ç‚¹
  - getSibling è·å–å…„å¼ŸèŠ‚ç‚¹
  - replaceWith  ç”¨ASTèŠ‚ç‚¹æ›¿æ¢è¯¥èŠ‚ç‚¹
  - replaceWithMultiple ç”¨å¤šä¸ªASTèŠ‚ç‚¹æ›¿æ¢è¯¥èŠ‚ç‚¹
  - insertBefore  åœ¨èŠ‚ç‚¹å‰æ’å…¥èŠ‚ç‚¹
  - insertAfter åœ¨èŠ‚ç‚¹åæ’å…¥èŠ‚ç‚¹
  - remove   åˆ é™¤èŠ‚ç‚¹
  - ...

```
### @babel/types
`@babel/types`æ˜¯ç”¨äºå¤„ç†ASTèŠ‚ç‚¹çš„å·¥å…·åº“ï¼ŒåŒ…å«äº†æ„é€ ã€éªŒè¯ASTèŠ‚ç‚¹ç­‰æ–¹æ³•ã€‚å…·ä½“è¯·å‚è€ƒ[@babel/typesç›¸å…³API](https://babeljs.io/docs/en/babel-types#blockstatement)
### å®ç°ç®­å¤´å‡½æ•°è½¬æ¢ä¸ºfunctionå‡½æ•°
ç¬¬ä¸€æ­¥ï¼šç»™visitorå¯¹è±¡æ·»åŠ å¯¹åº”èŠ‚ç‚¹çš„ç›‘å¬æ–¹æ³•ã€‚å¯ä»¥ä»ASTä¸­æ‰¾åˆ°ç®­å¤´å‡½æ•°ç±»å‹çš„ç›‘å¬æ–¹æ³•çš„å†™æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![](./assets/plugin1.png)

ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºç®­å¤´å‡½æ•°ç±»å‹æ˜¯ArrowFunctionExpressionï¼Œæ‰€ä»¥visitoré‡Œçš„å†™æ³•å¦‚ä¸‹ï¼š
```js
visitor: {
  ArrowFunctionExpression: (path, state) => {}
}
```
ç¬¬äºŒæ­¥ï¼šè½¬æ¢ASTã€‚è¦å°†ç®­å¤´å‡½æ•°è½¬æ¢ä¸ºfunctionæ™®é€šå‡½æ•°ï¼Œéœ€è¦ä½¿ç”¨`@babel/types`çš„functionå‡½æ•°æ„é€ æ–¹æ³•æ¥æ„é€ ä¸€ä¸ªfunctionå‡½æ•°èŠ‚ç‚¹ï¼Œç„¶åå°†åŸæ¥çš„ç®­å¤´å‡½æ•°èŠ‚ç‚¹æ›¿æ¢æ‰å³å¯ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•è§[@babel/types](https://babeljs.io/docs/en/babel-types#functionexpression)ã€‚
![](./assets/plugin2.png)

### å®ç°constè½¬æ¢æˆvar
ç¬¬ä¸€æ­¥ï¼šç»™visitorå¯¹è±¡æ·»åŠ å¯¹åº”èŠ‚ç‚¹çš„ç›‘å¬æ–¹æ³•ã€‚å¯ä»¥ä»ASTä¸­æ‰¾åˆ°å˜é‡å£°æ˜çš„typeä¸ºVariableDeclarationï¼Œå³visitorå¯¹è±¡å¯¹åº”çš„æ–¹æ³•åã€‚
```js
visitor: {
  VariableDeclaration: (path, state) => {}
}
```
ç¬¬äºŒæ­¥ï¼šè½¬æ¢AST
![](./assets/plugin3.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šVariableDeclarationç±»å‹çš„èŠ‚ç‚¹æœ‰ä¸€ä¸ªå˜é‡kindæ ‡è¯†ç€å£°æ˜å˜é‡çš„æ–¹å¼ï¼Œæ‰€ä»¥è¦å®ç°å°†constè½¬æ¢ä¸ºvarï¼Œé‚£å¯ä»¥ç›´æ¥åœ¨visitoré‡Œç›‘å¬çš„VariableDeclarationæ–¹æ³•ä¸­å°†è¯¥èŠ‚ç‚¹çš„kindå±æ€§èµ‹å€¼ä¸ºvarå³å¯ï¼š
```js
visitor: {
  VariableDeclaration: (path, state) => {
      const {node} = path;
      if (node.kind === 'const' || node.kind === 'let') {
          node.kind = 'var'; // æ–¹å¼1ï¼šç›´æ¥æ›¿æ¢
      }
  }
}
```
é™¤äº†ä¸Šè¿°ç›´æ¥æ›¿æ¢çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ›¿æ¢å½“å‰èŠ‚ç‚¹çš„æ–¹å¼æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚ä¸Šæ–‡è¯´è¿‡`@babel/types`ç”¨äºå¤„ç†ASTèŠ‚ç‚¹çš„å·¥å…·åº“ï¼ŒåŒ…å«äº†æ„é€ ã€éªŒè¯ASTèŠ‚ç‚¹ç­‰æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨`@babel/types`å®šä¹‰çš„æ„é€ æ–¹æ³•æ¥æ„é€ ä¸€ä¸ªvariableDeclarationèŠ‚ç‚¹ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š
```js
visitor: {
  VariableDeclaration: (path, state) => {
      const {node} = path;
      if (node.kind === 'const' || node.kind === 'let') {
          // åŸºäº@babel/typesçš„VariableDeclarationæ–¹æ³•æ„é€ ä¸€ä¸ªvariableDeclarationèŠ‚ç‚¹
          const variableDeclaration = type.VariableDeclaration('var', node.declarations)
          // replaceWithä¸ºæ›¿æ¢èŠ‚ç‚¹çš„æ–¹æ³•
          path.replaceWith(variableDeclaration);
      }
  }
}
```
æœ€ç»ˆå®ç°å¦‚ä¸‹ï¼š
```js
const babel = require('@babel/core');
const type = require('@babel/types');

const transformArrowFunction = {
    // è¯¥visitoråŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ç›‘å¬æ–¹æ³•VariableDeclarationå’ŒArrowFunctionExpression
    visitor: {
        // å°†constå’Œletè½¬æ¢ä¸ºvar
        // æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªtypeå­—æ®µï¼Œtypeå€¼ä¸ºVariableDeclarationä¼šè¢«åŒ¹é…æˆåŠŸ
        VariableDeclaration: (path, state) => {
            const {node} = path;
            if (node.kind === 'const' || node.kind === 'let') {
                // node.kind = 'var'; // æ–¹å¼1ï¼šç›´æ¥æ›¿æ¢
                // æ–¹å¼2ï¼šé‡‡ç”¨replaceWith
                // åŸºäº@babel/typesçš„VariableDeclarationæ–¹æ³•æ„é€ ä¸€ä¸ªvariableDeclarationèŠ‚ç‚¹
                const variableDeclaration = type.VariableDeclaration('var', node.declarations)
                // replaceWithä¸ºæ›¿æ¢èŠ‚ç‚¹çš„æ–¹æ³•
                path.replaceWith(variableDeclaration);
            }
        },
        // Visitorä¸­çš„æ¯ä¸ªå‡½æ•°æ¥æ”¶2ä¸ªå‚æ•°ï¼špathå’Œstate
        // pathæ˜¯è¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿æ¥çš„å¯¹è±¡
        ArrowFunctionExpression: (path, state) => {
            // console.log(path);
            // nodeå°±æ˜¯ArrowFunctionExpressionåŒ¹é…åˆ°çš„å½“å‰èŠ‚ç‚¹
            // parentæ˜¯å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹
            const {node, parent} = path;
            const id = parent.id;
            const params = node.params; // è·å–å‚æ•°
            // å°†BinaryExpressionè½¬æ¢ä¸ºBlockStatement
            const body = type.blockStatement([
                // node.bodyåŸæ¥æ˜¯a+bï¼Œå³BinaryExpression
                type.returnStatement(node.body)
            ]);
            // ç”Ÿæˆå¯¹åº”çš„functionExpression
            const functionExpression = type.functionExpression(id, params, body, false, false);
            // èŠ‚ç‚¹æ›¿æ¢ï¼Œå°†åŒ¹é…åˆ°çš„ArrowFunctionExpressionæ›¿æ¢ä¸ºæ–°ç”Ÿæˆçš„FunctionExpression
            path.replaceWith(functionExpression);
        }
    }
};

const code = 'const fn = (a, b) => a + b';
const result = babel.transform(code, {
    plugins: [
        transformArrowFunction
    ]
});

console.log(result.code);
```
## é¢„è®¡ç®—æ’ä»¶
```js
const babel = require('@babel/core');
const type = require('@babel/types');
const code = 'const num = 2 * 3 * 4 * 5';

const preCalculatePlugin = {
    visitor: {
        BinaryExpression: (path, state) => {
            const node = path.node;
            const {left, right, operator} = node;
            if (!isNaN(left.value) && !isNaN(right.value)) {
                let result = eval(left.value + operator + right.value);
                result = type.numericLiteral(result);
                path.replaceWith(result);
                // å¦‚æœå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¹Ÿæ˜¯è¡¨è¾¾å¼çš„è¯ï¼Œéœ€è¦é€’å½’è®¡ç®—
                if (path.parentPath.node.type === 'BinaryExpression') {
                    preCalculatePlugin.visitor.BinaryExpression.call(null, path.parentPath);
                }
            }
        }
    }
}

const res = babel.transform(code, {
    plugins: [preCalculatePlugin]
});

console.log(res.code); // const num = 120;
```
## å®ç°æŒ‰éœ€åŠ è½½æ’ä»¶
### é»˜è®¤å¯¼å…¥ä¸åšå¤„ç†
![](./assets/plugin6.png)

ä¸Šå›¾å¯¼å…¥çš„æ–¹å¼ä¸ºé»˜è®¤å¯¼å…¥ï¼Œä¸åšå¤„ç†ã€‚
```js
// åˆ¤æ–­æ˜¯å¦æ˜¯é»˜è®¤å¯¼å…¥
types.isImportDefaultSpecifier(specifiers[0]))
```
![](./assets/plugin4.png)
![](./assets/plugin5.png)

ä»ä¸Šé¢ä¸¤ä¸ªå›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºä¸¤ç§å¯¼å…¥æ–¹å¼çš„åŒºåˆ«åœ¨äºspecifiersçš„ç±»å‹ä¸åŒã€‚å› æ­¤ï¼Œåªè¦é‡æ–°ç”ŸæˆnewImportSpecifierså³å¯ï¼Œæœ€ç»ˆä»£ç å®ç°å¦‚ä¸‹ï¼š
```js
const types = require('@babel/types');

const visitor = {
    // è¿™é‡Œçš„refæ˜¯ImportDeclarationçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå€¼æ˜¯.babelrcä¸­çš„{"library": "lodash"}
    ImportDeclaration(path, ref = {opts: {}}) {
        const {opts} = ref;
        const node = path.node; // æ‹¿åˆ°å½“å‰èŠ‚ç‚¹
        const specifiers = node.specifiers;
        // isImportDefaultSpecifieråˆ¤æ–­æ˜¯å¦æ˜¯é»˜è®¤å¯¼å…¥ï¼Œæ˜¯çš„è¯ä¸åšå¤„ç†
        if (opts.library === node.source.value && !types.isImportDefaultSpecifier(specifiers[0])) {
            const newImportSpecifiers = specifiers.map(specifier => (
                    types.importDeclaration([types.ImportDefaultSpecifier(specifier.local)],
                    types.stringLiteral(`${node.source.value}/${specifier.local.name}`
                ))
            ));
            path.replaceWithMultiple(newImportSpecifiers);
        }
    }
}

module.exports = () => {
    return {visitor};
}
```
```js
// .babelrcé…ç½®ï¼š
{
    "presets": ["@babel/preset-env"],
    "plugins": [
        [
            "dynamic-import",
            {
                "library": "lodash" // å¼•ç”¨å“ªä¸ªåº“çš„æ—¶å€™ä½¿ç”¨æˆ‘ä»¬å†™çš„è¿™ä¸ªæ’ä»¶
            }
        ]
    ]
}
```
æœ€åå°†ç¼–å†™å¥½çš„æ’ä»¶æ”¾å…¥åˆ°`/node_modules/babel-plugin-dynamic-import/`æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶åœ¨package.jsonæ–‡ä»¶ä¸­æŒ‡æ˜å…¥å£ã€‚

æ²¡æœ‰æŒ‰éœ€åŠ è½½å‰çš„æ‰“åŒ…ç»“æœå¦‚ä¸‹ï¼š
```js
yarn run v1.16.0
$ webpack --mode development
Hash: 8e4da5b2edbe6c47dd1c
Version: webpack 4.41.2
Time: 325ms
Built at: 2019-11-13 19:45:03
    Asset     Size  Chunks             Chunk Names
bundle.js  552 KiB    main  [emitted]  main
Entrypoint main = bundle.js
[./node_modules/webpack/buildin/global.js] (webpack)/buildin/global.js 472 bytes {main} [built]
[./node_modules/webpack/buildin/module.js] (webpack)/buildin/module.js 497 bytes {main} [built]
[./src/index.js] 37 bytes {main} [built]
    + 1 hidden module
âœ¨  Done in 1.53s.
```
é‡‡ç”¨æŒ‰éœ€åŠ è½½å‰çš„æ‰“åŒ…ç»“æœå¦‚ä¸‹ï¼š
```js
yarn run v1.16.0
$ webpack --mode development
Hash: 58ece130df8aef56b95d
Version: webpack 4.41.2
Time: 105ms
Built at: 2019-11-13 19:46:28
    Asset      Size  Chunks             Chunk Names
bundle.js  20.9 KiB    main  [emitted]  main
Entrypoint main = bundle.js
[./node_modules/webpack/buildin/global.js] (webpack)/buildin/global.js 472 bytes {main} [built]
[./src/index.js] 110 bytes {main} [built]
    + 15 hidden modules
âœ¨  Done in 0.67s.
```
### æ³¨æ„äº‹é¡¹
1. babelæ’ä»¶çš„æ–‡ä»¶å¤¹å‘½åï¼Œå¿…é¡»ä»¥babel-plugin-xxxå‘½åï¼Œå¦åˆ™å¼•å…¥ä¸æˆåŠŸï¼›
2. babelæ’ä»¶è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªvisitorå¯¹è±¡ã€‚

## demo
```js
// è¿™é‡Œæ‰‹åŠ¨æŒ‡å®šç¯å¢ƒå˜é‡ä¸ºdevelopmentï¼Œåœ¨å‘½ä»¤è¡Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š
NODE_ENV=development npx babel index.js
// è½¬æ¢ç»“æœå¦‚ä¸‹ï¼š
if ("development" === 'development') {
  console.log('å¼€å‘ç¯å¢ƒ');
}
```
## @babel/parser(Babylonçš„å‡çº§)
èƒ½ä¼ é€’é€‰é¡¹ç»™ parse()ï¼š
```js
babylon.parse(code, {
  sourceType: "module", // default: "script"
  plugins: ["jsx"] // default: []
});
```
sourceType å¯ä»¥æ˜¯ "module" æˆ–è€… "script"ï¼Œå®ƒè¡¨ç¤º Babylon åº”è¯¥ç”¨å“ªç§æ¨¡å¼æ¥è§£æã€‚ "module" å°†ä¼šåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹è§£æå¹¶ä¸”å…è®¸æ¨¡å—å®šä¹‰ï¼Œ"script" åˆ™ä¸ä¼šã€‚

>æ³¨æ„ï¼šsourceType çš„é»˜è®¤å€¼æ˜¯ "script" å¹¶ä¸”åœ¨å‘ç° importæˆ– export æ—¶äº§ç”Ÿé”™è¯¯ï¼Œä½¿ç”¨ scourceType: "module" æ¥é¿å…è¿™äº›é”™è¯¯ã€‚

## æ€»ç»“
æ’ä»¶å…¶å®å°±æ˜¯åŸºäºæºä»£ç çš„ASTï¼Œåˆ©ç”¨ä¸€äº›å·¥å…·ç”Ÿæˆç›®æ ‡ä»£ç çš„ASTçš„è¿‡ç¨‹ã€‚

## å‚è€ƒæ–‡æ¡£
1. [Babel æ’ä»¶å¼€å‘æŒ‡å—](https://github.com/brigand/babel-plugin-handbook/blob/master/translations/zh-Hans/README.md#babylon)
2. [Babel æ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—](http://web.jobbole.com/94758/?utm_source=blog.jobbole.com&utm_medium=relatedPosts)
3. [è‡ªå·±å†™ä¸€ä¸ªBabelæ’ä»¶](https://www.colabug.com/4556670.html)
4. [ç†è§£ Babel æ’ä»¶](http://taobaofed.org/blog/2016/09/30/babel-plugins/)
6. [Babelæ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—](https://www.cnblogs.com/chyingp/p/how-to-write-a-babel-plugin.html)
7. [åŸæ¥babelæ’ä»¶æ˜¯è¿™æ ·å†™çš„](https://juejin.im/post/5d5bdb02e51d4561db5e3a52#heading-1)
8. [AST ä¸å‰ç«¯å·¥ç¨‹åŒ–å®æˆ˜](https://juejin.im/post/5d50d1d9f265da03aa25607b#heading-15)
9. [Parser_API](https://developer.mozilla.org/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Parser_API)
10. [å¦‚ä½•ç¼–å†™ä¸€ä¸ª babel æ’ä»¶](https://www.imliyan.com/blogs/article/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%20babel%20%E6%8F%92%E4%BB%B6/)
11. [é‡æ‹³å‡ºå‡»ï¼šæ‰“é€  Vue3.0 + Typescript + TSX å¼€(ä¹)å‘(ä¸)æ¨¡å¼](https://www.codenong.com/j5e3251546fb9a02ff84/)
12. [æ·±å…¥Babelï¼Œè¿™ä¸€ç¯‡å°±å¤Ÿäº†](https://juejin.im/post/5c21b584e51d4548ac6f6c99#heading-1)
13. [13 ä¸ªç¤ºä¾‹å¿«é€Ÿå…¥é—¨ JS æŠ½è±¡è¯­æ³•æ ‘](https://juejin.im/post/5b4d759d51882519a62f5b64#heading-72)
14. [å…¥é—¨babel--å®ç°ä¸€ä¸ªes6çš„classè½¬æ¢å™¨](https://juejin.im/post/5ac1c5bf518825558949f898)