---
title: 4.ç¼–å†™è‡ªå®šä¹‰loader
---
::: tip
å†™ä½œä¸æ˜“ï¼ŒStaræ˜¯æœ€å¤§é¼“åŠ±ï¼Œæ„Ÿè§‰å†™çš„ä¸é”™çš„å¯ä»¥ç»™ä¸ªStarâ­ï¼Œè¯·å¤šå¤šæŒ‡æ•™ã€‚[æœ¬åšå®¢çš„Githubåœ°å€](https://github.com/liujie2019/VuePress-Blog)ã€‚
:::
[TOC]
åŸåˆ™ä¸Šwebpackåªèƒ½å¤„ç†jsæ¨¡å—ï¼Œå¦‚æœè¦å¤„ç†å…¶ä»–ç±»å‹çš„æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨å¯¹åº”çš„loaderè¿›è¡Œè½¬æ¢å¤„ç†ã€‚

ä¸¾ä¸ªğŸŒ°ï¼šå¤„ç†SCSSæ–‡ä»¶
* å…ˆå°†SCSSæºä»£ç æäº¤ç»™sass-loaderï¼Œå°†SCSSè½¬æ¢æˆCSSï¼›
* å°†sass-loaderè¾“å‡ºçš„CSSæäº¤ç»™css-loaderå¤„ç†ï¼Œæ‰¾å‡ºCSSä¸­ä¾èµ–çš„èµ„æºã€å‹ç¼©CSSç­‰ï¼›
* å°†css-loaderè¾“å‡ºçš„CSSæäº¤ç»™style-loaderå¤„ç†ï¼Œè½¬æ¢æˆé€šè¿‡è„šæœ¬åŠ è½½çš„JavaScriptä»£ç ï¼›

Webpackç›¸å…³é…ç½®å¦‚ä¸‹ï¼š
```js
module.exports = {
  module: {
    rules: [
      {
        // å¢åŠ å¯¹ SCSS æ–‡ä»¶çš„æ”¯æŒ
        test: /\.scss$/,
        // SCSSæ–‡ä»¶çš„å¤„ç†é¡ºåºä¸ºå…ˆsass-loaderï¼Œå†css-loaderï¼Œå†style-loader
        use: [
          'style-loader',
          {
            loader: 'css-loader',
            // ç»™css-loaderä¼ å…¥é…ç½®é¡¹
            options: {
              minimize: true,
            }
          },
          'sass-loader']
      },
    ]
  },
};
```
å¯ä»¥çœ‹å‡ºï¼Œä»¥ä¸Šå¤„ç†è¿‡ç¨‹éœ€è¦æœ‰é¡ºåºçš„é“¾å¼æ‰§è¡Œï¼Œå…ˆsass-loaderï¼Œå†css-loaderï¼Œå†style-loaderã€‚æ˜¯**ä»åå‘å‰**ä¾æ¬¡æ‰§è¡Œå¯¹åº”çš„loaderï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆloaderçš„æ‰§è¡Œé¡ºåºæ˜¯ä»åå‘å‰çš„å‘¢ï¼Ÿè¿™å°±è¦è¯´åˆ°å‡½æ•°ç»„åˆäº†ã€‚

## å‡½æ•°ç»„åˆçš„ä¸¤ç§æƒ…å†µ
* Unixä¸­çš„piplineï¼šæ‰§è¡Œé¡ºåºæ˜¯**ä»å·¦å¾€å³**
* å‡½æ•°ç»„åˆCompose(webpacké‡‡ç”¨çš„å°±æ˜¯è¿™ç§)ï¼šæ‰§è¡Œé¡ºåºæ˜¯**ä»å³å¾€å·¦**

## ä»€ä¹ˆæ˜¯loader
loaderæ˜¯webpackä¸­ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œç”¨æ¥å°†ä¸€æ®µä»£ç è½¬æ¢æˆå¦ä¸€æ®µä»£ç çš„webpackåŠ è½½å™¨ã€‚loaderæ˜¯å¯¼å‡ºä¸ºä¸€ä¸ªå‡½æ•°çš„nodeæ¨¡å—ï¼Œè¯¥å‡½æ•°åœ¨loaderè½¬æ¢èµ„æºçš„æ—¶å€™è°ƒç”¨ã€‚ç»™å®šçš„å‡½æ•°å°†è°ƒç”¨loader APIï¼Œå¹¶é€šè¿‡thisä¸Šä¸‹æ–‡è®¿é—®ã€‚loaderå°±åƒæ˜¯ä¸€ä¸ªç¿»è¯‘å‘˜ï¼Œèƒ½å°†æºæ–‡ä»¶ç»è¿‡è½¬åŒ–åè¾“å‡ºæ–°çš„ç»“æœï¼Œå¹¶ä¸”ä¸€ä¸ªæ–‡ä»¶è¿˜å¯ä»¥é“¾å¼åœ°ç»è¿‡å¤šä¸ªç¿»è¯‘å‘˜ç¿»è¯‘ã€‚
## loaderç‰¹ç‚¹
* ç¬¬ä¸€ä¸ªloaderè¦è¿”å›jsè„šæœ¬
* æ¯ä¸ªloaderçš„èŒè´£æ˜¯å•ä¸€çš„ï¼Œå³åªåšä¸€ä»¶äº‹(åªéœ€è¦å®Œæˆä¸€ç§è½¬æ¢)
* æ¯ä¸€ä¸ªloaderéƒ½æ˜¯ä¸€ä¸ªNodeæ¨¡å—
* æ¯ä¸ªloaderéƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œç¡®ä¿loaderåœ¨ä¸åŒæ¨¡å—è½¬æ¢ä¹‹é—´ä¸ä¿å­˜çŠ¶æ€

::: warning
éœ€è¦æ³¨æ„ï¼šåœ¨å¼€å‘ä¸€ä¸ªloaderæ—¶ï¼Œè¯·ä¿æŒå…¶**èŒè´£çš„å•ä¸€æ€§**ï¼Œæˆ‘ä»¬åªéœ€å…³å¿ƒè¾“å…¥å’Œè¾“å‡ºã€‚å¦‚æœä¸€ä¸ªæºæ–‡ä»¶éœ€è¦ç»å†å¤šæ­¥è½¬æ¢æ‰èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå°±é€šè¿‡å¤šä¸ªloaderå»è½¬æ¢ã€‚ åœ¨è°ƒç”¨å¤šä¸ªloader`è½¬æ¢ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæ¯ä¸ªloaderéƒ½ä¼šé“¾å¼åœ°é¡ºåºæ‰§è¡Œã€‚ç¬¬ä¸€ä¸ªloaderå°†ä¼šæ‹¿åˆ°éœ€å¤„ç†çš„åŸå†…å®¹ï¼Œä¸Šä¸€ä¸ªloaderå¤„ç†åçš„ç»“æœä¼šè¢«ä¼ ç»™ä¸‹ä¸€ä¸ªloaderæ¥ç€å¤„ç†ï¼Œæœ€åçš„loaderå°†å¤„ç†åçš„æœ€ç»ˆç»“æœè¿”å›ç»™Webpackã€‚
:::
## loaderåŸºç¡€
Webpackæ˜¯è¿è¡Œåœ¨Node.jsä¹‹ä¸Šçš„ï¼Œ**ä¸€ä¸ªloaderå…¶å®å°±æ˜¯ä¸€ä¸ªNode.jsæ¨¡å—**ï¼Œè¿™ä¸ªæ¨¡å—éœ€è¦å¯¼å‡ºä¸€ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå¯¼å‡ºå‡½æ•°çš„å·¥ä½œå°±æ˜¯ï¼šè·å¾—å¤„ç†å‰çš„åŸå†…å®¹ï¼Œå¯¹åŸå†…å®¹æ‰§è¡Œå¤„ç†åï¼Œè¿”å›å¤„ç†åçš„å†…å®¹ã€‚

ä¸€ä¸ªæœ€ç®€å•çš„loaderçš„æºç å¦‚ä¸‹ï¼š
```js
module.exports = function(source) {
  // sourceä¸ºcompilerä¼ é€’ç»™loaderçš„ä¸€ä¸ªæ–‡ä»¶çš„åŸå†…å®¹
  // è¯¥å‡½æ•°éœ€è¦è¿”å›å¤„ç†åçš„å†…å®¹ï¼Œè¿™é‡Œä¸ºäº†ç®€å•èµ·è§ï¼Œç›´æ¥æŠŠåŸå†…å®¹è¿”å›äº†ï¼Œç›¸å½“äºè¯¥loaderæ²¡æœ‰åšä»»ä½•è½¬æ¢
  return source;
};
```
ç”±äºloaderè¿è¡Œåœ¨Node.jsä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»æ„`Node.js`è‡ªå¸¦çš„`API`ï¼Œæˆ–è€…å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—è¿›è¡Œè°ƒç”¨ï¼š
```js
const sass = require('node-sass');
module.exports = function(source) {
  return sass(source);
};
```
## åˆå§‹åŒ–loaderåˆ›å»º
```js
// å…ˆå®‰è£…webpack-cli
webpack-cli generate-loader
```
## loaderè¿›é˜¶
ä»¥ä¸Šåªæ˜¯ä¸ªæœ€ç®€å•çš„loaderï¼ŒWebpackè¿˜æä¾›ä¸€äº›APIä¾›loaderè°ƒç”¨ï¼Œä¸‹é¢æ¥ä¸€ä¸€ä»‹ç»ï¼š
### ä½¿ç”¨loader-runneré«˜æ•ˆè¿›è¡Œloaderçš„è°ƒè¯•
`loader-runner`å…è®¸æˆ‘ä»¬åœ¨ä¸å®‰è£…webpackçš„æƒ…å†µä¸‹è¿è¡Œloadersã€‚
ä½œç”¨ï¼š
* ä½œä¸ºwebpackçš„ä¾èµ–ï¼Œwebpackä¸­ä½¿ç”¨å®ƒæ‰§è¡Œloaderï¼›
* è¿›è¡Œloaderçš„å¼€å‘å’Œè°ƒè¯•ã€‚
```js

```
### loaderå‚æ•°çš„è·å–(é€šè¿‡loader-utils)
åœ¨æœ€ä¸Šé¢å¤„ç†SCSSæ–‡ä»¶çš„Webpacké…ç½®ä¸­ï¼Œå°†optionså‚æ•°ä¼ ç»™äº†css-loaderï¼Œä»¥æ§åˆ¶css-loaderã€‚å¦‚ä½•åœ¨è‡ªå·±ç¼–å†™çš„Loaderä¸­è·å–åˆ°ç”¨æˆ·ä¼ å…¥çš„optionså‘¢ï¼Ÿéœ€è¦è¿™æ ·åšï¼š
```js
const loaderUtils = require('loader-utils');
module.exports = function(source) {
  // è·å–ç”¨æˆ·ä¸ºå½“å‰Loaderä¼ å…¥çš„options
  const options = loaderUtils.getOptions(this);
  return source;
};
```
### è¿”å›å…¶å®ƒç»“æœ
ä¸Šé¢çš„loaderéƒ½åªæ˜¯è¿”å›äº†åŸå†…å®¹è½¬æ¢åçš„å†…å®¹ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹è¿˜éœ€è¦è¿”å›é™¤äº†å†…å®¹ä¹‹å¤–çš„ä¸œè¥¿ã€‚

ä»¥ç”¨babel-loaderè½¬æ¢ES6ä»£ç ä¸ºä¾‹ï¼Œå®ƒè¿˜éœ€è¦è¾“å‡ºè½¬æ¢åçš„ES5ä»£ç å¯¹åº”çš„Source Mapï¼Œä»¥æ–¹ä¾¿è°ƒè¯•æºç ã€‚ä¸ºäº†å°†Source Mapä¹Ÿä¸€èµ·éšç€ES5 ä»£ç è¿”å›ç»™Webpackï¼Œå¯ä»¥è¿™æ ·å†™ï¼š
```js
module.exports = function(source) {
  // é€šè¿‡ this.callback å‘Šè¯‰ Webpack è¿”å›çš„ç»“æœ
  this.callback(null, source, sourceMaps);
  // å½“æˆ‘ä»¬ä½¿ç”¨ this.callback è¿”å›å†…å®¹æ—¶ï¼Œè¯¥ Loader å¿…é¡»è¿”å› undefinedï¼Œ
  // ä»¥è®© Webpack çŸ¥é“è¯¥ Loader è¿”å›çš„ç»“æœåœ¨ this.callback ä¸­ï¼Œè€Œä¸æ˜¯ return ä¸­
  return;
};
```
å…¶ä¸­çš„`this.callback`æ˜¯ Webpack ç»™ Loader æ³¨å…¥çš„ APIï¼Œä»¥æ–¹ä¾¿ Loader å’Œ Webpack ä¹‹é—´é€šä¿¡ã€‚`this.callback`çš„è¯¦ç»†ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š
```js
this.callback(
    // å½“æ— æ³•è½¬æ¢åŸå†…å®¹æ—¶ï¼Œç»™ Webpack è¿”å›ä¸€ä¸ª Error
    err: Error | null,
    // åŸå†…å®¹è½¬æ¢åçš„å†…å®¹
    content: string | Buffer,
    // ç”¨äºæŠŠè½¬æ¢åçš„å†…å®¹å¾—å‡ºåŸå†…å®¹çš„ Source Mapï¼Œæ–¹ä¾¿è°ƒè¯•
    sourceMap?: SourceMap,
    // å¦‚æœæœ¬æ¬¡è½¬æ¢ä¸ºåŸå†…å®¹ç”Ÿæˆäº† AST è¯­æ³•æ ‘ï¼Œå¯ä»¥æŠŠè¿™ä¸ª AST è¿”å›ï¼Œ
    // ä»¥æ–¹ä¾¿ä¹‹åéœ€è¦ AST çš„ Loader å¤ç”¨è¯¥ ASTï¼Œä»¥é¿å…é‡å¤ç”Ÿæˆ ASTï¼Œæå‡æ€§èƒ½
    abstractSyntaxTree?: AST
);
```
`Source Map`çš„ç”Ÿæˆå¾ˆè€—æ—¶ï¼Œé€šå¸¸åœ¨å¼€å‘ç¯å¢ƒä¸‹æ‰ä¼šç”Ÿæˆ`Source Map`ï¼Œå…¶ä»–ç¯å¢ƒä¸‹ä¸ç”¨ç”Ÿæˆï¼Œä»¥åŠ é€Ÿæ„å»ºã€‚å› æ­¤ï¼ŒWebpackä¸ºLoaderæä¾›äº† this.sourceMap APIå»å‘Šè¯‰`Loader`å½“å‰æ„å»ºç¯å¢ƒä¸‹ç”¨æˆ·æ˜¯å¦éœ€è¦ Source Mapã€‚å¦‚æœæˆ‘ä»¬ç¼–å†™çš„Loaderä¼šç”ŸæˆSource Mapï¼Œè¯·è€ƒè™‘åˆ°è¿™ç‚¹ã€‚
### loaderè¿”å›å€¼å¤„ç†
```js
return `export default ${json}`;
// loaderè¿”å›ä¸€ä¸ªå€¼çš„è¯å¯ä»¥é‡‡ç”¨returnçš„æ–¹å¼
// å¦‚æœè¦è¿”å›å¤šä¸ªå€¼çš„è¯å°±éœ€è¦é‡‡ç”¨this.callbackçš„æ–¹å¼äº†
// this.callback(null, json, 2, 3, 4);
```
### åŒæ­¥ä¸å¼‚æ­¥
Loaderæœ‰åŒæ­¥å’Œå¼‚æ­¥ä¹‹åˆ†ï¼Œä¸Šé¢ä»‹ç»çš„Loaderéƒ½æ˜¯åŒæ­¥çš„Loaderï¼Œå› ä¸ºå®ƒä»¬çš„è½¬æ¢æµç¨‹éƒ½æ˜¯åŒæ­¥çš„ï¼Œè½¬æ¢å®Œæˆåå†è¿”å›ç»“æœã€‚ä½†åœ¨æŸäº›åœºæ™¯ä¸‹è½¬æ¢çš„æ­¥éª¤åªèƒ½æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œä¾‹å¦‚ï¼šæˆ‘ä»¬éœ€è¦é€šè¿‡ç½‘ç»œè¯·æ±‚æ‰èƒ½å¾—å‡ºç»“æœï¼Œå¦‚æœé‡‡ç”¨åŒæ­¥çš„æ–¹å¼ï¼Œåˆ™ç½‘ç»œè¯·æ±‚ä¼šé˜»å¡æ•´ä¸ªæ„å»ºï¼Œå¯¼è‡´æ„å»ºéå¸¸ç¼“æ…¢ã€‚

å¦‚æœæ˜¯å¼‚æ­¥è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼šé€šè¿‡this.asyncæ¥è¿”å›ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ã€‚
```js
module.exports = function(source) {
    // å‘Šè¯‰ Webpack æœ¬æ¬¡è½¬æ¢æ˜¯å¼‚æ­¥çš„ï¼ŒLoader ä¼šåœ¨ callback ä¸­å›è°ƒç»“æœ
    var callback = this.async();
    someAsyncOperation(source, function(err, result, sourceMaps, ast) {
        // é€šè¿‡ callback è¿”å›å¼‚æ­¥æ‰§è¡Œåçš„ç»“æœ
        // callbackæ˜¯this.asyncè¿”å›çš„å¼‚æ­¥å‡½æ•°
        // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Errorï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¤„ç†çš„ç»“æœ
        callback(err, result, sourceMaps, ast);
    });
};
```
### åŒæ­¥loaderå¼‚å¸¸å¤„ç†
* loaderå†…ç›´æ¥é€šè¿‡throwæŠ›å‡º
* é€šè¿‡this.callbackä¼ é€’é”™è¯¯

```js
this.callback(
    err: Error | null,
    content: string | Buffer,
    sourceMap?: SourceMap,
    meta?: any
);
```
## å¤„ç†äºŒè¿›åˆ¶æ•°æ®
åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼ŒWebpackä¼ ç»™Loaderçš„åŸå†…å®¹éƒ½æ˜¯UTF-8æ ¼å¼ç¼–ç çš„å­—ç¬¦ä¸²ã€‚ä½†æŸäº›åœºæ™¯ä¸‹ï¼ŒLoaderä¸ä¼šå¤„ç†æ–‡æœ¬æ–‡ä»¶ï¼Œè€Œæ˜¯ä¼šå¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶å¦‚file-loaderï¼Œå°±éœ€è¦Webpackç»™Loaderä¼ å…¥äºŒè¿›åˆ¶æ ¼å¼çš„æ•°æ®ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è¿™æ ·ç¼–å†™Loaderï¼š
```js
module.exports = function(source) {
    // åœ¨ exports.raw === true æ—¶ï¼ŒWebpack ä¼ ç»™ Loader çš„ source æ˜¯ Buffer ç±»å‹çš„
    source instanceof Buffer === true;
    // Loader è¿”å›çš„ç±»å‹ä¹Ÿå¯ä»¥æ˜¯ Buffer ç±»å‹çš„
    // åœ¨ exports.raw !== true æ—¶ï¼ŒLoader ä¹Ÿå¯ä»¥è¿”å› Buffer ç±»å‹çš„ç»“æœ
    return source;
};
// é€šè¿‡exports.rawå±æ€§å‘Šè¯‰Webpackè¯¥Loaderæ˜¯å¦éœ€è¦äºŒè¿›åˆ¶æ•°æ®
module.exports.raw = true;
```
ä»¥ä¸Šä»£ç ä¸­æœ€å…³é”®çš„ä»£ç æ˜¯æœ€åä¸€è¡Œ`module.exports.raw = true;`ï¼Œå¦‚æœæ²¡æœ‰è¯¥è¡Œä»£ç ï¼Œåˆ™loaderåªèƒ½æ‹¿åˆ°å­—ç¬¦ä¸²ã€‚
## å¼€å¯loaderç¼“å­˜åŠ é€Ÿ
åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæœ‰äº›è½¬æ¢æ“ä½œéœ€è¦å¤§é‡çš„è®¡ç®—ï¼Œéå¸¸è€—æ—¶ï¼Œå¦‚æœæ¯æ¬¡æ„å»ºéƒ½é‡æ–°æ‰§è¡Œé‡å¤çš„è½¬æ¢æ“ä½œï¼Œåˆ™æ„å»ºå°†ä¼šå˜å¾—éå¸¸ç¼“æ…¢ã€‚å› æ­¤ï¼Œ**Webpackä¼šé»˜è®¤ç¼“å­˜æ‰€æœ‰loaderçš„å¤„ç†ç»“æœ**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šåœ¨éœ€è¦è¢«å¤„ç†çš„æ–‡ä»¶æˆ–è€…å…¶ä¾èµ–çš„æ–‡ä»¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ˜¯ä¸ä¼šé‡æ–°è°ƒç”¨å¯¹åº”çš„Loaderå»æ‰§è¡Œè½¬æ¢æ“ä½œçš„ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è®©Webpackä¸ç¼“å­˜è¯¥loaderçš„å¤„ç†ç»“æœï¼Œå¯ä»¥è¿™æ ·è®¾ç½®ï¼š
```js
module.exports = function(source) {
  // å…³é—­loaderçš„ç¼“å­˜åŠŸèƒ½
  this.cacheable(false);
  return source;
};
```
ç¼“å­˜æ¡ä»¶ï¼šloaderçš„ç»“æœåœ¨ç›¸åŒçš„è¾“å…¥ä¸‹æœ‰ç¡®å®šçš„è¾“å‡ºã€‚éœ€è¦æ³¨æ„ï¼šæœ‰ä¾èµ–çš„loaderæ— æ³•ä½¿ç”¨ç¼“å­˜ã€‚
### loaderå¦‚ä½•è¿›è¡Œæ–‡ä»¶è¾“å‡ºï¼Ÿ
å¯ä»¥é€šè¿‡`this.emitFile`è¿›è¡Œæ–‡ä»¶å†™å…¥ã€‚
```js
const loaderUtils = require('loader-utils');

module.exports = function(source) {
    console.log('Loader a is excuted!');

    const url = loaderUtils.interpolateName(this, '[name].[ext]', source);

    console.log(url);
    this.emitFile(url, source);
    return source;
}
```
### å…¶å®ƒLoader API
é™¤äº†ä»¥ä¸Šæåˆ°çš„åœ¨`Loader`ä¸­èƒ½è°ƒç”¨çš„`Webpack API`ï¼Œè¿˜å­˜åœ¨ä»¥ä¸‹å¸¸ç”¨ APIï¼š
* **this.context**ï¼šå½“å‰å¤„ç†æ–‡ä»¶çš„æ‰€åœ¨ç›®å½•ï¼Œå‡å¦‚å½“å‰ Loader å¤„ç†çš„æ–‡ä»¶æ˜¯ /src/main.jsï¼Œåˆ™ this.context å°±ç­‰äº /srcï¼›
* **this.resource**ï¼šå½“å‰å¤„ç†çš„æ–‡ä»¶çš„å®Œæ•´è¯·æ±‚è·¯å¾„ï¼ŒåŒ…æ‹¬ querystringï¼Œä¾‹å¦‚`/src/main.js?name=1`ï¼›
* **this.resourcePath**ï¼šå½“å‰å¤„ç†çš„æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚ /src/main.jsï¼›
* **this.resourceQuery**ï¼šå½“å‰å¤„ç†çš„æ–‡ä»¶çš„ querystringï¼›
* **this.target**ï¼šç­‰äº Webpack é…ç½®ä¸­çš„ Targetï¼›
* **this.loadModule**ï¼šä½†Loader åœ¨å¤„ç†ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå¦‚æœä¾èµ–å…¶å®ƒæ–‡ä»¶çš„å¤„ç†ç»“æœæ‰èƒ½å¾—å‡ºå½“å‰æ–‡ä»¶çš„ç»“æœæ—¶ï¼Œå°±å¯ä»¥é€šè¿‡this.loadModule(request: string, callback: function(err, source, sourceMap, module)) å»è·å–requestå¯¹åº”æ–‡ä»¶çš„å¤„ç†ç»“æœï¼›
* **this.resolve**ï¼šåƒrequireè¯­å¥ä¸€æ ·è·å¾—æŒ‡å®šæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œä½¿ç”¨æ–¹æ³•ä¸ºresolve(context: string, request: string, callback: function(err, result: string))ï¼›
* **this.addDependency**ï¼šç»™å½“å‰å¤„ç†æ–‡ä»¶æ·»åŠ å…¶ä¾èµ–çš„æ–‡ä»¶ï¼Œä»¥ä¾¿å†å…¶ä¾èµ–çš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé‡æ–°è°ƒç”¨ Loader å¤„ç†è¯¥æ–‡ä»¶ã€‚ä½¿ç”¨æ–¹æ³•ä¸º addDependency(file: string)ï¼›
* **this.addContextDependency**ï¼šå’ŒaddDependency ç±»ä¼¼ï¼Œä½† addContextDependency æ˜¯æŠŠæ•´ä¸ªç›®å½•åŠ å…¥åˆ°å½“å‰æ­£åœ¨å¤„ç†æ–‡ä»¶çš„ä¾èµ–ä¸­ã€‚ä½¿ç”¨æ–¹æ³•ä¸º addContextDependency(directory: string)ï¼›
* **this.clearDependencies**ï¼šæ¸…é™¤å½“å‰æ­£åœ¨å¤„ç†æ–‡ä»¶çš„æ‰€æœ‰ä¾èµ–ï¼Œä½¿ç”¨æ–¹æ³•ä¸º clearDependencies()ï¼›
* **this.emitFile**ï¼šè¾“å‡ºä¸€ä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨æ–¹æ³•ä¸º emitFile(name: string, content: Buffer|string, sourceMap: {...})ã€‚

## 4ç§æœ¬åœ°å¼€å‘æµ‹è¯•loaderçš„æ–¹æ³•(åŠ è½½æœ¬åœ° Loader)
åœ¨å¼€å‘Loaderçš„è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†æµ‹è¯•ç¼–å†™çš„Loaderæ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦æŠŠå®ƒé…ç½®åˆ° Webpackä¸­åï¼Œæ‰å¯èƒ½ä¼šè°ƒç”¨è¯¥Loaderã€‚åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œä½¿ç”¨çš„Loaderéƒ½æ˜¯é€šè¿‡npmå®‰è£…çš„ï¼Œè¦ä½¿ç”¨Loaderæ—¶ä¼šç›´æ¥ä½¿ç”¨Loaderçš„åç§°ï¼Œä»£ç å¦‚ä¸‹ï¼š
```js
module.exports = {
  module: {
    rules: [
      {
        test: /\.css/,
        use: ['style-loader']
      },
    ]
  },
};
```
å¦‚æœè¿˜é‡‡å–ä»¥ä¸Šçš„æ–¹æ³•å»ä½¿ç”¨æœ¬åœ°å¼€å‘çš„Loaderå°†ä¼šå¾ˆéº»çƒ¦ï¼Œå› ä¸ºä½ éœ€è¦ç¡®ä¿ç¼–å†™çš„ Loader çš„æºç æ˜¯åœ¨`node_modules`ç›®å½•ä¸‹ã€‚ä¸ºæ­¤ä½ éœ€è¦å…ˆæŠŠç¼–å†™çš„ Loaderå‘å¸ƒåˆ°Npmä»“åº“åå†å®‰è£…åˆ°æœ¬åœ°é¡¹ç›®ä½¿ç”¨ã€‚

è§£å†³ä»¥ä¸Šé—®é¢˜çš„ä¾¿æ·æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ç§ï¼š
### åŒ¹é…å•ä¸ªloaderï¼Œä½ å¯ä»¥ç®€å•é€šè¿‡åœ¨ruleå¯¹è±¡è®¾ç½®path.resolveæŒ‡å‘è¿™ä¸ªæœ¬åœ°æ–‡ä»¶
```js
module.exports = {
  //...
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [
          {
            loader: path.resolve('path/to/loader.js'),
            options: {/* ... */}
          }
        ]
      }
    ]
  }
};
```
### åŒ¹é…å¤šä¸ªloadersï¼Œå¯ä»¥ä½¿ç”¨`resolveLoader.modules` é…ç½®
`ResolveLoader`ç”¨äºé…ç½®`Webpack`å¦‚ä½•å¯»æ‰¾`Loader`ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªä¼šå» `node_modules`ç›®å½•ä¸‹å¯»æ‰¾ï¼Œä¸ºäº†è®©`Webpack`åŠ è½½æ”¾åœ¨æœ¬åœ°é¡¹ç›®ä¸­çš„`Loader`éœ€è¦ä¿®æ”¹`resolveLoader.modules`ã€‚
`webpack`å°†ä¼šä»è¿™äº›ç›®å½•ä¸­æœç´¢è¿™äº›`loaders`ã€‚å‡å¦‚æœ¬åœ°çš„ Loader åœ¨é¡¹ç›®ç›®å½•ä¸­çš„`./loaders/loader-name`ä¸­ï¼Œåˆ™éœ€è¦å¦‚ä¸‹é…ç½®ï¼š

```js
module.exports = {
  //...
  resolveLoader: {
    // å»å“ªäº›ç›®å½•ä¸‹å¯»æ‰¾ Loaderï¼Œæœ‰å…ˆåé¡ºåºä¹‹åˆ†
    modules: [
      'node_modules',
      path.resolve(__dirname, 'loaders')
    ]
  }
};
```
åŠ ä¸Šä¸Šè¿°é…ç½®åï¼ŒWebpackä¼šå…ˆå»`node_modules`é¡¹ç›®ä¸‹å¯»æ‰¾`Loader`ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œä¼šå†å»`./loaders/`ç›®å½•ä¸‹å¯»æ‰¾ã€‚

### resolveLoader.alias
```js
resolveLoader: {
        // ç»™loaderé…ç½®åˆ«å
        alias: {
            'my-loader': path.resolve(__dirname, 'loaders', 'my-loader')
        }
        // é»˜è®¤å»node_modulesç›®å½•ä¸‹æ‰¾å¯¹åº”çš„loaderï¼Œæ‰¾ä¸åˆ°äº†å†å»loadersç›®å½•ä¸‹å¯»æ‰¾
        // æ¨èä½¿ç”¨
        // modules: ['node_modules', path.resolve(__dirname, 'loaders')]
    }
```
### ä½¿ç”¨`npm link`
`npm link`ä¸“é—¨ç”¨äºå¼€å‘å’Œè°ƒè¯•æœ¬åœ°çš„`npm`æ¨¡å—ï¼Œèƒ½åšåˆ°åœ¨ä¸å‘å¸ƒæ¨¡å—çš„æƒ…å†µä¸‹ï¼Œå°†æœ¬åœ°çš„ä¸€ä¸ªæ­£åœ¨å¼€å‘çš„æ¨¡å—çš„æºç é“¾æ¥åˆ°é¡¹ç›®çš„`node_modules`ç›®å½•ä¸‹ï¼Œè®©é¡¹ç›®å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°çš„Npmæ¨¡å—ã€‚ç”±äºæ˜¯é€šè¿‡è½¯é“¾æ¥çš„æ–¹å¼å®ç°çš„ï¼Œç¼–è¾‘äº†æœ¬åœ°çš„Npmæ¨¡å—ä»£ç ï¼Œæ‰€ä»¥åœ¨é¡¹ç›®ä¸­ä¹Ÿèƒ½ä½¿ç”¨åˆ°ç¼–è¾‘åçš„ä»£ç ã€‚

å®Œæˆ`npm link`çš„æ­¥éª¤å¦‚ä¸‹ï¼š
1. ç¡®ä¿æ­£åœ¨å¼€å‘çš„æœ¬åœ°`npm`æ¨¡å—ï¼ˆä¹Ÿå°±æ˜¯æ­£åœ¨å¼€å‘çš„ Loaderï¼‰çš„ `package.json`å·²ç»æ­£ç¡®é…ç½®å¥½ï¼›
2. åœ¨æœ¬åœ°`npm`æ¨¡å—æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`npm link`ï¼ŒæŠŠæœ¬åœ°æ¨¡å—æ³¨å†Œåˆ°å…¨å±€ï¼›
3. åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`npm link loader-name`ï¼ŒæŠŠç¬¬2æ­¥æ³¨å†Œåˆ°å…¨å±€çš„æœ¬åœ° Npm æ¨¡å—é“¾æ¥åˆ°é¡¹ç›®çš„`node_moduels`ä¸‹ï¼Œå…¶ä¸­çš„`loader-name`æ˜¯æŒ‡åœ¨ç¬¬1æ­¥ä¸­çš„`package.json`æ–‡ä»¶ä¸­é…ç½®çš„æ¨¡å—åç§°ã€‚

é“¾æ¥å¥½`Loader`åˆ°é¡¹ç›®åä½ å°±å¯ä»¥åƒä½¿ç”¨ä¸€ä¸ªçœŸæ­£çš„Npmæ¨¡å—ä¸€æ ·ä½¿ç”¨æœ¬åœ°çš„Loaderäº†ã€‚
## loaderåˆ†ç±»
* å‰ç½®(pre)loader
* æ™®é€š(normal)loader
* åç½®(post)loader
* è¡Œå†…(inline)loader

## é…ç½®å¤šä¸ªloader
### æ•°ç»„å½¢å¼
```js
rules: [
    {
        test: /\.js$/,
        loader: ['my-loader3', 'my-loader2', 'my-loader']
    }

```
![](./assets/loader.png)

### å¯¹è±¡å½¢å¼(å¯ä»¥é…ç½®loaderå‚æ•°)
```js
rules: [
    {
        test: /\.js$/,
        use: {
            loader: 'my-loader'
        }
    }, {
        test: /\.js$/,
        use: {
            loader: 'my-loader2'
        }
    }, {
        test: /\.js$/,
        use: {
            loader: 'my-loader3'
        }
    }
]
```
<img :src="$withBase('/webpack4/loader2.png')" alt="">

### å¤šä¸ªloaderæ‰§è¡Œé¡ºåº
::: tip
æ€»ç»“ï¼šä»ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¤šä¸ªloaderæ‰§è¡Œé¡ºåºæ˜¯ï¼šå¤šä¸ªloaderæ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä»å³åˆ°å·¦ï¼Œä»ä¸‹åˆ°ä¸Šã€‚
:::
### é…ç½®å‚æ•°æ”¹å˜loaderæ‰§è¡Œé¡ºåº
```js
rules: [
    {
        test: /\.js$/,
        use: {
            loader: 'my-loader'
        },
        enforce: 'pre' // æŒ‡å®šmy-loaderæœ€å…ˆä½¿ç”¨
    }, {
        test: /\.js$/,
        use: {
            loader: 'my-loader2' // é»˜è®¤ä¸ºnormal
        }
    }, {
        test: /\.js$/,
        use: {
            loader: 'my-loader3'
        },
        enforce: 'post' // æœ€åä½¿ç”¨
    }
]
```
::: warning
éœ€è¦æ³¨æ„ï¼šloaderå¸¦å‚æ•°æ‰§è¡Œçš„é¡ºåº: pre -> normal -> inline -> postï¼Œinlineä¸ºè¡Œå†…loaderã€‚
:::

## inline-loader(è¡Œå†…loader)
```js
// ./å‰é¢çš„!è¡¨ç¤ºå°†å½“å‰å¼•å…¥çš„æ–‡ä»¶äº¤ç»™è¡Œå†…loaderå¤„ç†
const a = require('inline-loader!./a'); // ä¸åŠ é™åˆ¶ï¼Œæ‰€æœ‰loaderéƒ½è°ƒç”¨æ¥å¤„ç†a.js
```
```js
npx webpack
// è¾“å‡º
my-loader1
my-loader2
my-loader3
my-loader1 // pre
my-loader2 // normal
inline-loader
my-loader3 // post
```

### !ç¦ç”¨normal-loader
```js
const a = require('!inline-loader!./a'); // !ç¦ç”¨normal-loaderï¼Œåªä½¿ç”¨pre-loaderã€post-loaderå’Œinline-loaderå¤„ç†å¤„ç†a.js
```
```js
npx webpack
// è¾“å‡º
my-loader1
my-loader2
my-loader3
my-loader1 // pre
inline-loader
my-loader3 // post
```
### -!ç¦ç”¨pre-loaderå’Œnormal-loader
```js
const a = require('-!inline-loader!./a'); // -!ç¦ç”¨pre-loaderã€normal-loaderï¼Œåªä½¿ç”¨post-loaderå’Œinline-loaderå¤„ç†å¤„ç†a.js
```
```js
npx webpack
// è¾“å‡º
my-loader1
my-loader2
my-loader3
inline-loader
my-loader3 // post
```
### !!ç¦ç”¨pre-loaderã€normal-loaderã€post-loaderï¼Œåªèƒ½è¡Œå†…å¤„ç†
```js
const a = require('!!inline-loader!./a'); // !!ç¦ç”¨pre-loaderã€normal-loaderã€post-loaderï¼Œåªä½¿ç”¨inline-loaderå¤„ç†å¤„ç†a.js
```
```js
npx webpack
// è¾“å‡º
my-loader1
my-loader2
my-loader3
inline-loader
```
## loaderç»„æˆ
loaderé»˜è®¤ç”±**pitchå’Œnormal**ä¸¤éƒ¨åˆ†ç»„æˆã€‚

æ¯ä¸ªloaderæ¨¡å—éƒ½æ”¯æŒä¸€ä¸ª`.pitch`å±æ€§ï¼Œä¸Šé¢çš„æ–¹æ³•ä¼šä¼˜å…ˆäºloaderçš„å®é™…æ–¹æ³•æ‰§è¡Œã€‚å®é™…ä¸Šï¼Œwebpackå®˜æ–¹ä¹Ÿç»™å‡ºäº†pitchä¸loaderæœ¬èº«æ–¹æ³•çš„æ‰§è¡Œé¡ºåºå›¾ï¼š
```js
|- a-loader `pitch`
  |- b-loader `pitch`
    |- c-loader `pitch`
      |- requested module is picked up as a dependency
    |- c-loader normal execution
  |- b-loader normal execution
|- a-loader normal execution
```
pitchå’Œnormalçš„æ‰§è¡Œé¡ºåºæ­£å¥½ç›¸åï¼Œå½“pitchæ²¡æœ‰å®šä¹‰æˆ–è€…æ²¡æœ‰è¿”å›å€¼æ—¶ï¼Œä¼šå…ˆä¾æ¬¡æ‰§è¡Œå†è·å–èµ„æºæ‰§è¡Œloaderã€‚å¦‚æœå®šä¹‰çš„æŸä¸ªpitchæœ‰è¿”å›å€¼ï¼Œåˆ™ä¼šè·³è¿‡è¯»å–èµ„æºå’Œè‡ªå·±çš„loaderã€‚
### æ‰€æœ‰loaderå‡æ— è¿”å›å€¼

```js
use: ['my-loader3', 'my-loader2', 'my-loader']
```
å¦‚æœ'my-loader3', 'my-loader2', 'my-loader'3ä¸ªloaderå‡æ— è¿”å›å€¼ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ`pitch`æ–¹æ³•ï¼Œä»å·¦åˆ°å³ï¼Œå†è·å–èµ„æºã€‚
<img :src="$withBase('/webpack4/loader3.png')" alt="">

æ‰€æœ‰çš„pitchLoaderéƒ½æ²¡æœ‰è¿”å›å€¼ã€‚
```js
pitch   loader3 â†’ loader2 â†’ loader1
                                    â†˜
                                      èµ„æº
                                    â†™
normal   loader3 â† loader2 â† loader1
```
```js
æˆ‘æ˜¯loader3 çš„pitch
æˆ‘æ˜¯loader2 çš„pitch
æˆ‘æ˜¯loader1 çš„pitch
my-loader1
my-loader2
my-loader3
```
### æœ‰pitchLoaderå­˜åœ¨è¿”å›å€¼
æœ‰è¿”å›å€¼ï¼š**ç›´æ¥è·³è¿‡åç»­æ‰€æœ‰çš„loaderåŒ…æ‹¬è‡ªå·±çš„**ï¼Œè·³åˆ°ä¹‹å‰çš„loaderï¼Œå¯ç”¨äºé˜»æ–­loaderã€‚
<img :src="$withBase('/webpack4/loader4.png')" alt="">

```js
const loader = source => {
    // å½“å‰loaderä»…ä»…åœ¨æºç åé¢è¿½åŠ äº†ä¸€æ®µæ–‡å­—
    console.log('my-loader2');
    return source + 'æˆ‘æ˜¯æ‰‹å†™loaderå¤„ç†è¿‡çš„';
}

loader.pitch = () => {
    return 'æˆ‘æœ‰è¿”å›å€¼-é˜»æ–­äº†';
}

module.exports = loader;
```
è¾“å‡ºï¼š
```js
my-loader3
```
## loader-runner
å®šä¹‰ï¼šloader-runner å…è®¸ä½ åœ¨ä¸å®‰è£… webpack çš„æƒ…å†µä¸‹è¿è¡Œ loadersã€‚

ä½œç”¨ï¼š
* ä½œä¸º webpack çš„ä¾èµ–ï¼Œwebpack ä¸­ä½¿ç”¨å®ƒæ‰§è¡Œ loader
* è¿›è¡Œ loader çš„å¼€å‘å’Œè°ƒè¯•

## å®æˆ˜
![](./assets/loader6.png)

é¦–å…ˆåœ¨é¡¹ç›®ç›®å½•ä¸‹æ–°å»ºloadersç›®å½•ï¼Œç”¨æ¥å­˜æ”¾è‡ªå®šä¹‰çš„loaderã€‚åœ¨loadersç›®å½•ä¸­æ–°å»º`my-webpack-loader`ç›®å½•ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè‡ªå®šä¹‰loaderï¼Œå¹¶åœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºindex.jså’Œpackage.jsonæ–‡ä»¶ã€‚å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š

index.jsï¼š
```js
const loaderUtils = require('loader-utils');

module.exports = function(content) {
    // è·å–ç”¨æˆ·é…ç½®çš„options
    const options = loaderUtils.getOptions(this);
    console.log('***options***', options);
    // è¯¥loaderçš„ä½œç”¨å°±æ˜¯åœ¨åŸå†…å®¹å‰åŠ ä¸Šå¦‚ä¸‹å­—ç¬¦ä¸²
    return '{test123};' + content;
}
```
package.jsonï¼š
```js
{
  "name": "my-webpack-loader",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "liujie",
  "license": "ISC"
}
```
åœ¨webpack.config.jsä¸­é…ç½®ï¼š
```js
module: {
    rules: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: {
            loader: 'my-webpack-loader',
            options: {
                test: 'wangwu'
            }
        }
      }
    ]
}
```
æ‰§è¡Œ`npm run dev`ï¼Œç»“æœå¦‚ä¸‹ï¼š
<img :src="$withBase('/webpack4/loader5.png')" alt="">

### raw-loader
![image-20200605193224056](./assets/image-20200605193224056.png)

* `\u2028`ï¼šè¡Œåˆ†éš”ç¬¦(è¡Œç»“æŸç¬¦)
* `\u2029`ï¼šæ®µè½åˆ†éš”ç¬¦(è¡Œç»“æŸç¬¦)

`\u2028`ä¸ºè¡Œåˆ†éš”ç¬¦ï¼Œä¼šè¢«æµè§ˆå™¨è§£æä¸ºæ¢è¡Œï¼Œè€Œåœ¨Javascriptçš„å­—ç¬¦ä¸²è¡¨è¾¾å¼ä¸­æ˜¯ä¸å…è®¸æ¢è¡Œçš„ï¼Œä»è€Œå¯¼è‡´é”™è¯¯ã€‚

æŠŠç‰¹æ®Šå­—ç¬¦è½¬ä¹‰æ›¿æ¢å³å¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
```
str = str.replace(/\u2028/g, '\\u2028');
```



## å‚è€ƒæ–‡æ¡£
1. [loader API](https://webpack.docschina.org/api/loaders/)
2. [webpackåŸç†](https://segmentfault.com/a/1190000015088834#articleHeader10)
3. [ç¼–å†™ä¸€ä¸ª loader](https://webpack.docschina.org/contribute/writing-a-loader/)
4. [ã€webpackè¿›é˜¶ã€‘ä½ çœŸçš„æŒæ¡äº†loaderä¹ˆï¼Ÿ- loaderåé—®](https://juejin.im/post/5bc1a73df265da0a8d36b74f)
5. [Webpack Loader é«˜æ‰‹è¿›é˜¶(ä¸€)](https://github.com/CommanderXL/Biu-blog/issues/31)
