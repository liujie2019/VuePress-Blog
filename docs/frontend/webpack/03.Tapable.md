---
title: 3.Tapableå­¦ä¹ 
---
::: tip
å†™ä½œä¸æ˜“ï¼ŒStaræ˜¯æœ€å¤§é¼“åŠ±ï¼Œæ„Ÿè§‰å†™çš„ä¸é”™çš„å¯ä»¥ç»™ä¸ªStarâ­ï¼Œè¯·å¤šå¤šæŒ‡æ•™ã€‚[æœ¬åšå®¢çš„Githubåœ°å€](https://github.com/liujie2019/VuePress-Blog)ã€‚
:::
é¦–å…ˆå£°æ˜ä¸€ç‚¹ï¼šWebpackä¸­æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªå¯¹è±¡ï¼šè´Ÿè´£ç¼–è¯‘çš„`Compiler`å’Œè´Ÿè´£åˆ›å»º`bundles`çš„`Compilation`éƒ½ç»§æ‰¿è‡ªTapableã€‚
```js
class Compilation extends Tapable {}
```
```js
class Compiler extends Tapable {}
```
## tapableä»‹ç»
Webpackæœ¬è´¨ä¸Šæ˜¯ä¸€ç§äº‹ä»¶æµçš„æœºåˆ¶ï¼Œå®ƒçš„å·¥ä½œæµç¨‹å°±æ˜¯ï¼šå°†å„ä¸ªæ’ä»¶ä¸²è”èµ·æ¥ï¼Œè€Œå®ç°è¿™ä¸€åˆ‡çš„æ ¸å¿ƒå°±æ˜¯Tapableã€‚

Tapableæ˜¯ä¸€ä¸ªç±»ä¼¼äºnodejsçš„EventEmitterçš„åº“ï¼Œæ ¸å¿ƒåŸç†ä¹Ÿä¾èµ–äº**å‘å¸ƒ-è®¢é˜…æ¨¡å¼**ã€‚ä¸»è¦æ˜¯æ§åˆ¶é’©å­å‡½æ•°çš„å‘å¸ƒä¸è®¢é˜…ï¼Œæ§åˆ¶ç€webpackçš„æ’ä»¶ç³»ç»Ÿã€‚Tapableåº“å¯¹å¤–æš´éœ²äº†å¾ˆå¤šHook(é’©å­)ç±»ï¼Œä¸ºæ’ä»¶æä¾›æŒ‚è½½çš„é’©å­å‡½æ•°ã€‚
```js
const {
	SyncHook, // åŒæ­¥é’©å­
	SyncBailHook, // åŒæ­¥ç†”æ–­é’©å­(ç†”æ–­çš„ä½œç”¨ï¼šé‡åˆ°returnå°±ä¼šè¿”å›ï¼Œåœæ­¢å‘ä¸‹æ‰§è¡Œ)
	SyncWaterfallHook, // åŒæ­¥æµæ°´é’©å­(æµæ°´çš„ä½œç”¨ï¼šå‰ä¸€ä¸ªæ’ä»¶çš„æ‰§è¡Œç»“æœä½œä¸ºå‚æ•°ä¼ ç»™ä¸‹ä¸€ä¸ªæ’ä»¶)
	SyncLoopHook, // åŒæ­¥å¾ªç¯é’©å­
	AsyncParallelHook, // å¼‚æ­¥å¹¶å‘é’©å­
	AsyncParallelBailHook, // å¼‚æ­¥å¹¶å‘ç†”æ–­é’©å­
	AsyncSeriesHook, // å¼‚æ­¥ä¸²è¡Œé’©å­
	AsyncSeriesBailHook, // å¼‚æ­¥ä¸²è¡Œç†”æ–­é’©å­
	AsyncSeriesWaterfallHook // å¼‚æ­¥ä¸²è¡Œæµæ°´é’©å­
 } = require('tapable');
```
tapableæš´éœ²å‡ºæ¥çš„éƒ½æ˜¯ç±»æ–¹æ³•ï¼Œnewä¸€ä¸ªç±»æ–¹æ³•å°±å¯ä»¥è·å¾—æˆ‘ä»¬éœ€è¦çš„é’©å­ã€‚
classæ¥å—æ•°ç»„å‚æ•°optionsï¼Œéå¿…ä¼ ã€‚ç±»æ–¹æ³•ä¼šæ ¹æ®ä¼ å‚ï¼Œæ¥å—åŒæ ·æ•°é‡çš„å‚æ•°ã€‚
```js
const hook = new SyncHook(['args', 'arg2', 'arg3']);
```
### hooksæ¦‚è§ˆ
å¸¸ç”¨çš„é’©å­ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ç§ï¼Œåˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥ï¼Œå¼‚æ­¥åˆåˆ†ä¸ºå¹¶å‘æ‰§è¡Œå’Œä¸²è¡Œæ‰§è¡Œï¼Œå¦‚ä¸‹å›¾ï¼š
<img :src="$withBase('/webpack/tapable.png')" alt="">

| é’©å­åç§°/æ‰§è¡Œæ–¹å¼ | ä½¿ç”¨è¯´æ˜ |
| ------------- |:-------------:|
| SyncHook/åŒæ­¥ä¸²è¡Œ | ä¸å…³å¿ƒç›‘å¬å‡½æ•°çš„è¿”å›å€¼ |
| SyncBailHook/åŒæ­¥ä¸²è¡Œ     |  åªè¦ç›‘å¬å‡½æ•°ä¸­æœ‰ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ä¸ä¸ºundefinedï¼Œåˆ™è·³è¿‡å‰©ä¸‹æ‰€æœ‰çš„é€»è¾‘ |
| SyncWaterfallHook/åŒæ­¥ä¸²è¡Œ      | ä¸Šä¸€ä¸ªç›‘å¬å‡½æ•°çš„è¿”å›å€¼å¯ä»¥ä¼ ç»™ä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•° |
| SyncLoopHook/åŒæ­¥å¾ªç¯ | å½“ç›‘å¬å‡½æ•°è¢«è§¦å‘çš„æ—¶å€™ï¼Œå¦‚æœè¯¥ç›‘å¬å‡½æ•°è¿”å›trueæ—¶åˆ™è¿™ä¸ªç›‘å¬å‡½æ•°ä¼šåå¤æ‰§è¡Œï¼Œå¦‚æœè¿”å› undefined åˆ™è¡¨ç¤ºé€€å‡ºå¾ªç¯ |
| AsyncParallelHook/å¼‚æ­¥å¹¶è¡Œ      |   ä¸å…³å¿ƒç›‘å¬å‡½æ•°çš„è¿”å›å€¼ |
| AsyncParallelBailHook/å¼‚æ­¥å¹¶è¡Œ      |   åªè¦ç›‘å¬å‡½æ•°çš„è¿”å›å€¼ä¸ä¸ºundefinedï¼Œå°±ä¼šå¿½ç•¥åé¢çš„ç›‘å¬å‡½æ•°æ‰§è¡Œï¼Œç›´æ¥è·³åˆ°callAsyncå‡½æ•°ç»‘å®šçš„å›è°ƒå‡½æ•°ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªå›è°ƒå‡½æ•° |
| AsyncSeriesHook/å¼‚æ­¥ä¸²è¡Œ  | ä¸å…³ç³»callback()çš„å‚æ•° |
| AsyncSeriesBailHook/å¼‚æ­¥ä¸²è¡Œ      |   callback()çš„å‚æ•°ä¸ä¸ºnullï¼Œå°±ä¼šç›´æ¥æ‰§è¡ŒcallAsyncç­‰è§¦å‘å‡½æ•°ç»‘å®šçš„å›è°ƒå‡½æ•° |
| AsyncSeriesWaterfallHook/å¼‚æ­¥ä¸²è¡Œ      |    ä¸Šä¸€ä¸ªç›‘å¬å‡½æ•°çš„ä¸­çš„callback(err, data)çš„ç¬¬äºŒä¸ªå‚æ•°,å¯ä»¥ä½œä¸ºä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°çš„å‚æ•° |

### hooksç±»å‹æ€»ç»“
| type | function |
| ------------- |:-------------:|
| Hook | æ‰€æœ‰é’©å­çš„åç¼€ |
| Waterfall | åŒæ­¥æ–¹æ³•ï¼Œä½†æ˜¯å®ƒä¼šä¼ å€¼ç»™ä¸‹ä¸€ä¸ªå‡½æ•° |
| Bail | ç†”æ–­ï¼šå½“å‡½æ•°æœ‰ä»»ä½•è¿”å›å€¼æ—¶ï¼Œå°±ä¼šåœ¨å½“å‰æ‰§è¡Œå‡½æ•°åœæ­¢ |
| Loop | ç›‘å¬å‡½æ•°è¿”å›trueæ—¶åˆ™è¿™ä¸ªç›‘å¬å‡½æ•°ä¼šå¾ªç¯æ‰§è¡Œï¼Œå¦‚æœè¿”å›undefinedåˆ™è¡¨ç¤ºé€€å‡ºå¾ªç¯ |
| Sync | åŒæ­¥æ–¹æ³• |
| AsyncSeries | å¼‚æ­¥ä¸²è¡Œé’©å­ |
| AsyncParallel | å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œé’©å­ |

### é’©å­çš„ç»‘å®šä¸æ‰§è¡Œ
Tabableæä¾›äº†åŒæ­¥å’Œå¼‚æ­¥ç»‘å®šé’©å­çš„æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒä»¬éƒ½æœ‰ç»‘å®šäº‹ä»¶å’Œæ‰§è¡Œäº‹ä»¶å¯¹åº”çš„æ–¹æ³•ã€‚
| Async* | Sync* |
| ------------- |:-------------:|
| ç»‘å®šï¼štapAsync/tapPromise/tap | ç»‘å®šï¼štap |
| æ‰§è¡Œï¼šcallAsync/promise | æ‰§è¡Œï¼šcall |

éœ€è¦æ³¨æ„ï¼šåŒæ­¥é’©å­åªèƒ½ç”¨tapç»‘å®šï¼Œä½†æ˜¯å¼‚æ­¥é’©å­æ—¢å¯ä»¥ä½¿ç”¨tapç»‘å®šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨tapAsync/tapPromiseç»‘å®šã€‚
## åŒæ­¥é’©å­
### SyncHook
SyncHookä¸å…³å¿ƒç›‘å¬å‡½æ•°çš„è¿”å›å€¼ã€‚
```bash
npm i tabable -D
```
æ¥çœ‹ä¸ªğŸŒ°ï¼š

```js
const {SyncHook} = require('tapable'); // è§£æ„åŒæ­¥é’©å­

class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new SyncHook(['name', 'age'])
        }
    }
    start() {
        // åˆ©ç”¨é’©å­çš„callæ–¹æ³•è°ƒç”¨ç›‘å¬å‡½æ•°
        this.hooks.arch.call('tom', 12);
    }
    tap() {
        // åˆ©ç”¨é’©å­çš„tapæ–¹æ³•æ³¨å†Œç›‘å¬å‡½æ•°
        this.hooks.arch.tap('node', (name, age) => {
            console.log('node', `${name}-${age}`); // node tom-12
        });
        this.hooks.arch.tap('vue', name => {
            console.log('vue', name); // vue tom
        });
    }
}

const l = new Lesson();
// console.log(l.hooks.arch);
l.tap(); // è¿™é‡Œæ³¨å†Œäº†ä¸¤ä¸ªç›‘å¬å‡½æ•°
// console.log(l.hooks.arch.taps);
l.start(); // å¯åŠ¨é’©å­
```
#### SyncHooké’©å­å®ç°
```js
class SyncHook {
    constructor() {
        this.tasks = [];
    }
    // è®¢é˜…
    tap(name, task) {
        this.tasks.push(task);
    }
    // å‘å¸ƒ
    call(...args) {
        this.tasks.forEach(task => task(...args));
    }
}

const hook = new SyncHook(['name', 'age']);
hook.tap('webpack', (name, age) => {
    console.log('webpack', `${name}--${age}`);
});
hook.tap('node', (name, age) => {
    console.log('node', `${name}--${age}`);
});

hook.call('tom', 12);
```
### SyncBailHook
SyncBailHookä¸ºé’©å­åŠ ä¸ªä¿é™©ï¼Œå½“returnè¿”å›ä¸æ˜¯undefineæ—¶å°±ä¼šåœæ­¢ã€‚

æ¥çœ‹ä¸ªğŸŒ°ï¼š
```js
const {SyncBailHook} = require('tapable'); // è§£æ„åŒæ­¥é’©å­

class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new SyncBailHook(['name', 'age'])
        }
    }
    start() {
        // åˆ©ç”¨é’©å­çš„callæ–¹æ³•è°ƒç”¨ç›‘å¬å‡½æ•°
        this.hooks.arch.call('tom', 12);
    }
    tap() {
        // åˆ©ç”¨é’©å­çš„tapæ–¹æ³•æ³¨å†Œç›‘å¬å‡½æ•°
        this.hooks.arch.tap('node', (name, age) => {
            console.log('node', `${name}-${age}`); // node tom-12
            // return 'æœ‰ç‚¹ç´¯ï¼Œåœæ­¢å­¦ä¹ '; // ä¼šåœæ­¢
            // return undefined; // ä¸ä¼šåœæ­¢
        });
        this.hooks.arch.tap('vue', name => {
            console.log('vue', name); // vue tom
            // æ²¡æœ‰returnè¯­å¥ï¼Œé»˜è®¤æ˜¯return undefined;
        });
    }
}

const l = new Lesson();
console.log(l.hooks.arch);
l.tap(); // æ³¨å†Œç›‘å¬å‡½æ•°
console.log(l.hooks.arch.taps);
l.start(); // å¯åŠ¨é’©å­
```
#### SyncBailHooké’©å­å®ç°ï¼š
```js
class SyncBailHook {
    constructor() {
        this.tasks = [];
    }
    // è®¢é˜…
    tap(name, task) {
        this.tasks.push(task);
    }
    // å‘å¸ƒ
    // è¿™é‡Œç”¨å‡½æ•°å‰©ä½™è¿ç®—ç¬¦æ¥æ”¶è‹¥å¹²ä¸ªå‚æ•°ï¼Œå°†æ‰€æœ‰å‚æ•°å­˜å…¥æ•°ç»„argsä¸­
    call(...args) {
        let res; // å½“å‰å›è°ƒå‡½æ•°çš„è¿”å›å€¼
        let index = 0; // å½“å‰è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°ç´¢å¼•å€¼ï¼Œé»˜è®¤ä»ç¬¬ä¸€ä¸ªå¼€å§‹
        // è‡³å°‘è¦æ‰§è¡Œä¸€ä¸ªå›è°ƒ
        // å½“å‰å›è°ƒè¿”å›undefinedä¸”è¿˜æœ‰å›è°ƒæœªæ‰§è¡Œçš„è¯å†ç»§ç»­æ‰§è¡Œ
        do {
            // å›è°ƒå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦åˆ©ç”¨æ•°ç»„çš„å±•å¼€è¿ç®—ç¬¦ï¼Œå°†æ•°ç»„ä¸­çš„å‚æ•°åˆ†åˆ«ä¼ é€’ç»™è®¢é˜…å‡½æ•°
            res = this.tasks[index++](...args);
        } while (res === undefined && this.tasks.length > index);
    }
}

const hook = new SyncBailHook(['name', 'age']);
// è¿™é‡Œè™½ç„¶æ³¨å†Œäº†ä¸¤ä¸ªå›è°ƒï¼Œä½†æ˜¯nodeå›è°ƒä¸ä¼šæ‰§è¡Œ
hook.tap('webpack', (name, age) => {
    console.log('webpack', `${name}--${age}`);
    return 'åœæ­¢å­¦ä¹ ';
});
hook.tap('node', (name, age) => {
    console.log('node', `${name}--${age}`);
});

hook.call('tom', 12);
```
### SyncWaterfallHook
SyncWaterfallHooké’©å­ç›‘å¬ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼å¹¶å°†è¯¥è¿”å›å€¼ä¼ ç»™ä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°ã€‚

æ¥çœ‹ä¸ªğŸŒ°ï¼š
```js
const {SyncWaterfallHook} = require('tapable'); // è§£æ„åŒæ­¥é’©å­

class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­ waterfall ç€‘å¸ƒ
            arch: new SyncWaterfallHook(['name', 'age'])
        }
    }
    start() {
        // åˆ©ç”¨é’©å­çš„callæ–¹æ³•è°ƒç”¨ç›‘å¬å‡½æ•°
        this.hooks.arch.call('tom', 12);
    }
    tap() {
        // åˆ©ç”¨é’©å­çš„tapæ–¹æ³•æ³¨å†Œç›‘å¬å‡½æ•°
        this.hooks.arch.tap('node', (name, age) => {
            console.log('node', `${name}-${age}`); // node tom-12
            return 'nodeå­¦çš„ä¸é”™'; // returnè¿”å›å€¼æ˜¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°çš„æ•°æ®
        });
        this.hooks.arch.tap('vue', data => {
            console.log('vue', data); // vue nodeå­¦çš„ä¸é”™
        });
    }
}

const l = new Lesson();
l.tap(); // æ³¨å†Œç›‘å¬å‡½æ•°
l.start(); // å¯åŠ¨é’©å­
```
#### SyncWaterfallHooké’©å­å®ç°
```js
class SyncWaterfallHook { // åŒæ­¥é’©å­-ç€‘å¸ƒ
    constructor() {
        this.tasks = [];
    }
    // è®¢é˜…
    tap(name, task) {
        this.tasks.push(task);
    }
    // å‘å¸ƒ
    // è¿™é‡Œç”¨å‡½æ•°å‰©ä½™è¿ç®—ç¬¦æ¥æ”¶è‹¥å¹²ä¸ªå‚æ•°ï¼Œå°†æ‰€æœ‰å‚æ•°å­˜å…¥æ•°ç»„argsä¸­
    call(...args) {
        // è§£æ„è·å–ç¬¬ä¸€ä¸ªtaskå’Œå…¶ä½™å‰©ä½™çš„task
        const [first, ...others] = this.tasks;
        const res = first(...args); // è·å–ç¬¬ä¸€ä¸ªtashå›è°ƒå‡½æ•°çš„è¿”å›å€¼
        // reduceè¿­ä»£
        // preæ˜¯å‰ä¸€ä¸ªtaskçš„è¿”å›ç»“æœï¼Œcuræ˜¯å½“å‰task
        others.reduce((pre, cur) => {
            return cur(pre);
        }, res);
    }
}

const hook = new SyncWaterfallHook(['name', 'age']);
hook.tap('webpack', (name, age) => {
    console.log('webpack', `${name}--${age}`);
    return 'webpackå­¦çš„ä¸é”™å–”';
});
hook.tap('node', data => {
    console.log('node', data);
    return 'nodeå­¦çš„ä¸é”™å–”';
});
hook.tap('vue', data => {
    console.log('vue', data);
});

hook.call('tom', 12);
/**
æ‰§è¡Œç»“æœï¼š
webpack tom--12
node webpackå­¦çš„ä¸é”™å–”
vue nodeå­¦çš„ä¸é”™å–”
*/
```
### SyncLoopHook
SyncLoopHooké’©å­å½“ç›‘å¬å‡½æ•°è¢«è§¦å‘çš„æ—¶å€™ï¼Œå¦‚æœè¯¥ç›‘å¬å‡½æ•°è¿”å›trueæ—¶ï¼Œè¿™ä¸ªç›‘å¬å‡½æ•°ä¼šå¤šæ¬¡æ‰§è¡Œï¼Œå¦‚æœè¿”å›undefinedï¼Œåˆ™è¡¨ç¤ºé€€å‡ºå¾ªç¯ã€‚

æ¥çœ‹ä¸ªğŸŒ°ï¼š
```js
const {SyncLoopHook} = require('tapable'); // è§£æ„åŒæ­¥é’©å­

class Lesson {
    constructor() {
        this.index = 0;
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new SyncLoopHook(['name', 'age'])
        }
    }
    start() {
        // åˆ©ç”¨é’©å­çš„callæ–¹æ³•è°ƒç”¨ç›‘å¬å‡½æ•°
        this.hooks.arch.call('tom', 12);
    }
    tap() {
        // åˆ©ç”¨é’©å­çš„tapæ–¹æ³•æ³¨å†Œç›‘å¬å‡½æ•°
        this.hooks.arch.tap('node', (name, age) => {
            console.log('node', `${name}-${age}`); // node tom-12
            return ++this.index === 3 ? undefined : 'ç»§ç»­å­¦';
        });
        this.hooks.arch.tap('vue', name => {
            console.log('vue', name);
        });
    }
}

const l = new Lesson();
console.log(l.hooks.arch);
l.tap(); // æ³¨å†Œç›‘å¬å‡½æ•°
console.log(l.hooks.arch.taps);
l.start(); // å¯åŠ¨é’©å­
```
#### SyncLoopHooké’©å­å®ç°
```js
class SyncLoopHook { // åŒæ­¥é’©å­-ç€‘å¸ƒ
    constructor() {
        this.tasks = [];
    }
    // è®¢é˜…
    tap(name, task) {
        this.tasks.push(task);
    }
    // å‘å¸ƒ
    // è¿™é‡Œç”¨å‡½æ•°å‰©ä½™è¿ç®—ç¬¦æ¥æ”¶è‹¥å¹²ä¸ªå‚æ•°ï¼Œå°†æ‰€æœ‰å‚æ•°å­˜å…¥æ•°ç»„argsä¸­
    call(...args) {
        this.tasks.forEach(task => {
            let res; // resä¸ºå½“å‰ç›‘å¬å‡½æ•°çš„è¿”å›å€¼
            // å½“è¯¥è¿”å›å€¼ä¸ä¸ºundefinedæ—¶ç»§ç»­æ‰§è¡Œ
            do {
                res = task(...args);
            } while (res !== undefined);
        });
    }
}

const hook = new SyncLoopHook(['name', 'age']);
let total = 0;
hook.tap('webpack', (name, age) => {
    console.log('webpack', `${name}--${age}`);
    return ++total === 3 ? undefined : 'ç»§ç»­å­¦';
});
hook.tap('node', name => {
    console.log('node', name);
});
hook.tap('vue', name => {
    console.log('vue', name);
});

hook.call('tom', 12);
/**
æ‰§è¡Œç»“æœï¼š
webpack tom--12
webpack tom--12
webpack tom--12
node tom
vue tom
*/
```
## å¼‚æ­¥é’©å­
å¼‚æ­¥çš„é’©å­åˆ†ä¸º`ä¸²è¡Œ`å’Œ`å¹¶è¡Œ`ä¸¤ç§ï¼Œ`å¹¶è¡Œ`éœ€è¦ç­‰å¾…æ‰€æœ‰å¹¶å‘çš„å¼‚æ­¥äº‹ä»¶æ‰§è¡Œå®Œæˆåå†æ‰§è¡Œå›è°ƒã€‚

>Tapableåº“ä¸­æœ‰ä¸‰ç§æ³¨å†Œ/å‘å¸ƒæ¨¡å¼ï¼š

| è®¢é˜…æ¨¡å¼       | è°ƒç”¨æ–¹æ³•        |
| ------------- |:-------------:|
| åŒæ­¥è®¢é˜…tap     | call(åŒæ­¥è°ƒç”¨) |
| å¼‚æ­¥è®¢é˜…tapAsync(callback)      | callAsyncï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰      |
| å¼‚æ­¥è®¢é˜…tapPromise | promise     |

### AsyncParallelHook(å¼‚æ­¥å¹¶è¡Œ)
`AsyncParallelHook`æ˜¯å¼‚æ­¥å¹¶è¡Œçš„é’©å­ï¼šä¸å…³å¿ƒç›‘å¬å‡½æ•°çš„è¿”å›å€¼ã€‚
æ¥çœ‹ä¸ªğŸŒ°ï¼šå¼‚æ­¥tapAsyncæ³¨å†Œã€‚
```js
const {AsyncParallelHook} = require('tapable'); // è§£æ„å¼‚æ­¥é’©å­
// å¼‚æ­¥tapAsyncæ³¨å†Œ
class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncParallelHook(['name'])
        }
    }
    start() {
        this.hooks.arch.callAsync('tom', () => {
            console.log('end');
        });
    }
    tap() {
        // tapAsyncå¼‚æ­¥è®¢é˜…
        this.hooks.arch.tapAsync('webpack', (name, callback) => {
            setTimeout(() => {
                console.log('webpack', name);
                callback();
            }, 1000);
        });
        this.hooks.arch.tapAsync('node', (name, callback) => {
            setTimeout(() => {
                console.log('node', name);
                callback();
            }, 1000);
        });
    }
}

let l = new Lesson();
l.tap(); // æ³¨å†Œä¸¤ä¸ªç›‘å¬å‡½æ•°
l.start(); // å¯åŠ¨é’©å­
/**
æ‰§è¡Œç»“æœï¼š
webpack tom
node tom
end
*/
```
æ¥çœ‹ä¸ªğŸŒ°ï¼šå¼‚æ­¥tapPromiseæ³¨å†Œã€‚
```js
const {AsyncParallelHook} = require('tapable'); // è§£æ„å¼‚æ­¥é’©å­
// å¼‚æ­¥tapPromiseæ³¨å†Œ
class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncParallelHook(['name'])
        }
    }
    start() {
        this.hooks.arch.promise('tom').then(() => {
            console.log('end');
        })
    }
    tap() {
        // tapPromiseå¼‚æ­¥è®¢é˜…
        this.hooks.arch.tapPromise('webpack', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('webpack', name);
                    resolve();
                }, 1000);
            })
        });
        this.hooks.arch.tapPromise('node', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('node', name);
                    resolve();
                }, 1000);
            });
        });
    }
}

let l = new Lesson();
l.tap(); // æ³¨å†Œä¸¤ä¸ªç›‘å¬å‡½æ•°
l.start(); // å¯åŠ¨é’©å­
/**
æ‰§è¡Œç»“æœï¼š
webpack tom
node tom
end
*/
```
#### AsyncParallelHooké’©å­å®ç°
```js
class AsyncParallelHook { // é’©å­æ˜¯å¼‚æ­¥çš„
    constructor() {
        this.tasks = [];
    }
    tapAsync(name, task) {
        this.tasks.push(task);
    }
    callAsync(...args) {
        // è·å–åˆ°æœ€ç»ˆçš„æ‰§è¡Œå‡½æ•°
        const finalCallback = args.pop();
        let index = 0;
        // ç±»ä¼¼äºpromise.allçš„å®ç°
        const done = () => {
            index++;
            if (index === this.tasks.length) {
                finalCallback();
            }
        };
        this.tasks.forEach(task => {
            // popæ–¹æ³•ä¼šä¿®æ”¹åŸæ•°ç»„ï¼Œæ‰€ä»¥è¿™é‡Œçš„argså·²ç»æŠŠæœ€åä¸€ä¸ªå‚æ•°åˆ æ‰
            // æ¯ä¸ªtaskéƒ½ä¼šæ‰§è¡Œdoneæ–¹æ³•ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦æ‰€æœ‰taskéƒ½æ‰§è¡Œå®Œæ¯•
            task(...args, done);
        })
    }
    tapPromise(name, task) {
        this.tasks.push(task);
    }
    promise(...args) {
        const tasks = this.tasks.map(task => {
            return task(...args);
        });
        return Promise.all(tasks);
    }
}

const hook = new AsyncParallelHook(['name']);
// hook.tapAsync('react', (name, callback) => {
//     setTimeout(() => {
//         console.log('react', name);
//         callback()
//     }, 1000)
// });

// hook.tapAsync('node', (name, callback) => {
//     setTimeout(() => {
//         console.log('node', name);
//         callback()
//     }, 1000)
// });

// hook.tapAsync('webpack', (name, callback) => {
//     setTimeout(() => {
//         console.log('webpack', name);
//         callback();
//     }, 1000);
// });

// hook.callAsync('tom', () => {
//     console.log('end');
// });
hook.tapPromise('react', name => {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            console.log('react', name);
            resolve();
        }, 1000);
    });
});

hook.tapPromise('node', name => {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            console.log('node', name);
            resolve();
        }, 1000);
    });
});
hook.promise('tom').then(() => {
    console.log('end');
});
/**
æ‰§è¡Œç»“æœ
react tom
node tom
webpack tom
end
*/
```
### AsyncParallelBailHook
`AsyncParallelBailHook`æ˜¯ä¸€ä¸ªå¸¦ä¿é™©çš„å¼‚æ­¥å›è°ƒé’©å­ï¼Œåªè¦ç›‘å¬å‡½æ•°çš„è¿”å›å€¼ä¸ä¸º`undefined`ï¼Œå°±ä¼šå¿½ç•¥åé¢çš„ç›‘å¬å‡½æ•°æ‰§è¡Œï¼Œç›´æ¥è·³åˆ°`callAsync`ç­‰è§¦å‘å‡½æ•°ç»‘å®šçš„å›è°ƒå‡½æ•°ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªè¢«ç»‘å®šçš„å›è°ƒå‡½æ•°ã€‚ä½¿ç”¨å’ŒåŸç†ä¸`SyncBailHook`ç›¸ä¼¼ã€‚

æ¥çœ‹ä¸ªğŸŒ°ï¼štapAsyncå¼‚æ­¥è®¢é˜…ã€‚
```js
const {AsyncParallelBailHook} = require('tapable'); // è§£æ„å¼‚æ­¥é’©å­
// å¼‚æ­¥tapAsyncæ³¨å†Œ
class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncParallelBailHook(['name'])
        }
    }
    start() {
        this.hooks.arch.callAsync('tom', () => {
            console.log('end');
        });
    }
    tap() {
        // tapAsyncå¼‚æ­¥è®¢é˜…
        this.hooks.arch.tapAsync('webpack', (name, callback) => {
            setTimeout(() => {
                console.log('webpack', name);
                // return 'åœæ­¢å‘ä¸‹æ‰§è¡Œ';// åé¢çš„å›è°ƒå°±ä¸ä¼šè°ƒç”¨äº†
                callback();
            }, 1000);
        });
        this.hooks.arch.tapAsync('node', (name, callback) => {
            setTimeout(() => {
                console.log('node', name);
                callback();
            }, 1000);
        });
    }
}

let l = new Lesson();
l.tap(); // æ³¨å†Œä¸¤ä¸ªç›‘å¬å‡½æ•°
l.start(); // å¯åŠ¨é’©å­
/**
æ‰§è¡Œç»“æœï¼š
webpack tom
node tom
end
*/
```
æ¥çœ‹ä¸ªğŸŒ°ï¼štapPromiseå¼‚æ­¥è®¢é˜…ã€‚
```js
const {AsyncParallelBailHook} = require('tapable'); // è§£æ„å¼‚æ­¥é’©å­
// å¼‚æ­¥tapPromiseæ³¨å†Œ
class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncParallelBailHook(['name'])
        }
    }
    start() {
        this.hooks.arch.promise('tom').then(() => {
            console.log('end');
        });
    }
    tap() {
        // tapPromiseå¼‚æ­¥è®¢é˜…
        this.hooks.arch.tapPromise('webpack', name => {
            return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log('webpack', name);
                        reject('wrong');// reject()çš„å‚æ•°æ˜¯ä¸€ä¸ªä¸ä¸ºnullçš„å‚æ•°æ—¶ï¼Œåé¢çš„å›è°ƒå°±ä¸ä¼šå†è°ƒç”¨äº†
                        // resolve();
                    }, 1000);
                });
        });
        this.hooks.arch.tapPromise('node', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('node', name);
                    resolve();
                }, 1000);
            });
        });
    }
}

let l = new Lesson();

l.tap(); // æ³¨å†Œä¸¤ä¸ªç›‘å¬å‡½æ•°
l.start(); // å¯åŠ¨é’©å­
/**
æ‰§è¡Œç»“æœï¼š
webpack tom
node tom
end
*/
```
### AsyncSeriesHook(å¼‚æ­¥ä¸²è¡Œ)
`AsyncSeriesHook`é’©å­æ˜¯`å¼‚æ­¥ä¸²è¡Œ(`one by one)ã€‚

æ¥çœ‹ä¸ªğŸŒ°ï¼š
```js
const {AsyncSeriesHook} = require('tapable'); // è§£æ„å¼‚æ­¥é’©å­
class Lesson {
    constructor() {
        this.index = 0;
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncSeriesHook(['name'])
        }
    }
    start() {
        // å‘å¸ƒ
        // this.hooks.arch.callAsync('tom', () => {
        //     console.log('end');
        // })
        // å¦ä¸€ç§å‘å¸ƒ
        this.hooks.arch.promise('tom').then(() => {
                console.log('end');
            }
        )
    }

    tap() { // æ³¨å†Œç›‘å¬å‡½æ•°ï¼Œè®¢é˜…
        // this.hooks.arch.tapAsync('node', (name, callback) => {
        //     setTimeout(() => {
        //         console.log('node', name)
        //         callback()
        //     }, 1000)
        // })
        // this.hooks.arch.tapAsync('react',  (name, callback) => {
        //     setTimeout(() => {
        //         console.log('react', name)
        //         callback()
        //     }, 1000)
        // })
        // å¦ä¸€ç§è®¢é˜…
        this.hooks.arch.tapPromise('node', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('node', name);
                    resolve();
                }, 1000);
            })
        })
        this.hooks.arch.tapPromise('react', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('react', name);
                    resolve();
                }, 1000);
            })
        })
    }
}

let l = new Lesson();
l.tap();  // æ³¨å†Œä¸¤ä¸ªå‡½æ•°
l.start(); // å¯åŠ¨é’©å­
```
#### `AsyncSeriesHook`é’©å­å®ç°ï¼š
```js
class AsyncSeriesHook {
    constructor() {
        this.tasks = [];
    }
    // tapAsync(name, task) {
    //     this.tasks.push(task);
    // }
    // callAsync(...args) {
    //     const finalCallback = args.pop();
    //     let index = 0;
    //     const next = () => {
    //         if (this.tasks.length === index) return finalCallback();
    //         const task = this.tasks[index++];
    //         task(...args, next);
    //     }
    //     next();
    // }
    tapPromise(name, task) {
        this.tasks.push(task);
    }
    promise(...args) {
        // å°†promiseä¸²è”èµ·æ¥
        const [first, ...other] = this.tasks;
        return other.reduce((p, n) => { // ç±»ä¼¼reduxæºç 
             return p.then(() => n(...args));
        }, first(...args));
    }
}
const hook = new AsyncSeriesHook(['name']);
// hook.tapAsync('react', (name, callback) => {
//     setTimeout(() => {
//         console.log('react', name);
//         callback();
//     }, 1000);
// });

// hook.tapAsync('node', (name, callback) => {
//     setTimeout(() => {
//         console.log('node', name);
//         callback();
//     }, 1000);
// });

// hook.tapAsync('webpack', (name, callback) => {
//     setTimeout(() => {
//         console.log('webpack', name);
//         callback();
//     }, 1000);
// });
hook.tapPromise('react', name => {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            console.log('react', name);
            resolve();
        }, 1000);
    })
});

hook.tapPromise('node', name => {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            console.log('node', name);
            resolve();
        }, 1000);
    })
});

// hook.callAsync('tom', () => {
//     console.log('end');
// });
hook.promise('tom').then(() => {
    console.log('end');
});
```
### AsyncSeriesBailHook
æ¥çœ‹ä¸ªğŸŒ°ï¼štapAsyncå¼‚æ­¥è®¢é˜…
```js
const {AsyncSeriesBailHook} = require('tapable');

class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncSeriesBailHook(['name'])
        }
    }
    start() {
        this.hooks.arch.callAsync('tom', data => {
            console.log(data);
        });
    }
    tap() {
        // tapAsyncå¼‚æ­¥è®¢é˜…
        this.hooks.arch.tapAsync('webpack', (name, callback) => {
            setTimeout(() => {
                console.log('webpack', name);
                callback();
            }, 1000);
        });
        this.hooks.arch.tapAsync('node', (name, callback) => {
            setTimeout(() => {
                console.log('node', name);
                callback('åœæ­¢å­¦ä¹ '); // åé¢çš„å›è°ƒå°†ä¸ä¼šæ‰§è¡Œ
            }, 1000);
        });
        this.hooks.arch.tapAsync('vue', (name, callback) => {
            setTimeout(() => {
                console.log('vue', name);
                callback();
            }, 1000);
        });
    }
}

let l = new Lesson();
l.tap(); // æ³¨å†Œä¸¤ä¸ªç›‘å¬å‡½æ•°
l.start(); // å¯åŠ¨é’©å­
/**
webpack tom
node tom
åœæ­¢å­¦ä¹ 
*/
```
æ¥çœ‹ä¸ªğŸŒ°ï¼štapPromiseå¼‚æ­¥è®¢é˜…
```js
const {AsyncSeriesBailHook} = require('tapable');

class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncSeriesBailHook(['name'])
        }
    }
    start() {
        this.hooks.arch.promise('tom').then(data => {
            console.log(data);
        }, error => {
            console.log('errorï¼š', error); // åœæ­¢å­¦ä¹ äº†
        });
    }
    tap() {
        // tapPromiseå¼‚æ­¥è®¢é˜…
        this.hooks.arch.tapPromise('webpack', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('webpack', name);
                    resolve();
                }, 1000);
            })
        });
        this.hooks.arch.tapPromise('node', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('node', name);
                    reject('åœæ­¢å­¦ä¹ äº†');
                }, 1000);
            })
        });
        this.hooks.arch.tapPromise('vue', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('vue', name);
                    resolve();
                }, 1000);
            })
        });
    }
}

let l = new Lesson();
l.tap(); // æ³¨å†Œä¸¤ä¸ªç›‘å¬å‡½æ•°
l.start(); // å¯åŠ¨é’©å­
/**
webpack tom
node tom
errorï¼š åœæ­¢å­¦ä¹ äº†
*/
```
### AsyncSeriesWaterfallHook
ä¸Šä¸€ä¸ªç›‘å¬å‡½æ•°çš„ä¸­çš„`callback(err, data)`çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥ä½œä¸ºä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°çš„å‚æ•°ã€‚

æ¥çœ‹ä¸ªğŸŒ°ï¼š
```js
const {AsyncSeriesWaterfallHook} = require('tapable'); // è§£æ„å¼‚æ­¥é’©å­
class Lesson {
    constructor() {
        this.hooks = {
            // è®¢é˜…é’©å­
            arch: new AsyncSeriesWaterfallHook(['name'])
        };
    }
    start() {
        // this.hooks.arch.callAsync('tom', () => {
        //     console.log('end');
        // });
        this.hooks.arch.promise('tom').then(() => {
            console.log('end');
        });
    }
    tap() { // æ³¨å†Œç›‘å¬å‡½æ•°ï¼Œè®¢é˜…
        // this.hooks.arch.tapAsync('node', (name, callback) => {
        //     setTimeout(() => {
        //         console.log('node', name);
        //         // callback(null, 'nodeå­¦çš„ä¸é”™å–”');
        //         callback('aaa', 'result'); // å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯nullï¼Œä¼šç›´æ¥è·³è¿‡åé¢çš„é’©å­ï¼Œç›´æ¥èµ°åˆ°æœ€ç»ˆçš„
        //     }, 1000);
        // });
        // this.hooks.arch.tapAsync('react', (data, callback) => {
        //     setTimeout(() => {
        //         console.log('react', data);
        //         callback();
        //     }, 1000);
        // });
        // å¦ä¸€ç§è®¢é˜…æ–¹å¼
        this.hooks.arch.tapPromise('node', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('node', name);
                    resolve();
                }, 1000);
            });
        });
        this.hooks.arch.tapPromise('react', name => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    console.log('react', name);
                    resolve();
                }, 1000);
            });
        });
    }
}
const l = new Lesson();
l.tap();
l.start();
```
#### `AsyncSeriesWaterfallHook`é’©å­å®ç°
```js
class AsyncSeriesWaterfallHook {
    constructor(args) {  // args => ['name']
        this.tasks = [];
    }

    tapAsync(name, task) {
        this.tasks.push(task);
    }
    callAsync(...args) {
        const finalCallback = args.pop();
        let index = 0;
        const next = (err, data) => {
            let task = this.tasks[index];
            // å¦‚æœtaskæ²¡æœ‰å–åˆ°ï¼Œåˆ™æ‰§è¡Œæœ€åä¸€ä¸ª
            if(!task) return finalCallback();
            if (index === 0) {
                // æ‰§è¡Œç¬¬ä¸€ä¸ª
                task(...args, next);
            } else {
                task(data, next);
            }
            index++;
        }
        next(); // å…ˆè°ƒä¸€æ¬¡
    }
    // tapPromise(name, task) {
    //     this.tasks.push(task);
    // }
    // promise(...args) {
    //     // å°†promiseä¸²è”èµ·æ¥
    //     const [first, ...other] = this.tasks;
    //     return other.reduce((p, n) => {
    //          return p.then(data => n(data));
    //     }, first(...args));
    // }
}

const hook = new AsyncSeriesWaterfallHook(['name']);
hook.tapAsync('react', (name, callback) => {
    setTimeout(() => {
        console.log('react', name);
        callback(null, 'reactå­¦çš„ä¸é”™å–”');
    }, 1000)
});

hook.tapAsync('node', (data, callback) => {
    setTimeout(() => {
        console.log('node', data);
        callback(null, 'nodeå­¦çš„ä¸é”™å–”');
    }, 1000)
});

hook.tapAsync('webpack', (data, callback) => {
    setTimeout(() => {
        console.log('webpack', data);
        callback();
    }, 1000)
});

// hook.tapPromise('react', name => {
//     return new Promise((resolve, reject) => {
//         setTimeout(() => {
//             console.log('react', name);
//             resolve('reactå­¦çš„ä¸é”™å–”');
//         }, 1000);
//     });
// })

// hook.tapPromise('node', data => {
//     return new Promise((resolve, reject) => {
//         setTimeout(() => {
//             console.log('node', data);
//             resolve();
//         }, 1000);
//     });
// });
hook.callAsync('tom', () => {
    console.log('end');
});
// hook.promise('tom').then(() => {
//     console.log('end');
// });
```
## å‚è€ƒæ–‡æ¡£
1. [webpack4.0æºç åˆ†æä¹‹Tapable](https://juejin.im/post/5abf33f16fb9a028e46ec352)
2. [webpackæ’ä»¶æœºåˆ¶ä¹‹Tapable](https://juejin.im/post/5c5d96a1e51d457fc0574181#heading-6)
3. [webpackç³»åˆ—ä¹‹äºŒTapable](https://juejin.im/post/5c25f920e51d45593b4bc719)
4. [Webpack4.0 source code analysis of Tapable](http://www.programmersought.com/article/1459649892/)
5. [Webpackæ’ä»¶æœºåˆ¶ä¹‹Tapable-æºç è§£æ](https://juejin.im/post/5dc169b0f265da4d542092c6)

<Valine></Valine>