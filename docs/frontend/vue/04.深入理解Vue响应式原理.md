---
title: 4. æ·±å…¥ç†è§£Vueå“åº”å¼åŸç†
---
[TOC]
::: tip
å†™ä½œä¸æ˜“ï¼ŒStaræ˜¯æœ€å¤§é¼“åŠ±ï¼Œæ„Ÿè§‰å†™çš„ä¸é”™çš„å¯ä»¥ç»™ä¸ªStarâ­ï¼Œè¯·å¤šå¤šæŒ‡æ•™ã€‚[æœ¬åšå®¢çš„Githubåœ°å€](https://github.com/liujie2019/VuePress-Blog)ã€‚
:::

## å“åº”å¼ç†è§£
å½“jså¯¹è±¡ä¸­çš„æ•°æ®å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¸jså¯¹è±¡ä¸­æ•°æ®ç›¸å…³è”çš„DOMè§†å›¾ä¹Ÿä¼šè¿›è¡Œæ›´æ–°(å³æ‰€è°“çš„æ•°æ®é©±åŠ¨è§†å›¾)ã€‚
## å“åº”å¼å®ç°æ€è·¯
æƒ³è¦å®ç°å“åº”å¼ï¼Œéœ€è¦åšå¦‚ä¸‹äº‹æƒ…ï¼š
1. ç›‘å¬å¯¹è±¡æ•°æ®çš„å˜åŒ–ã€‚
2. æ”¶é›†è§†å›¾ä¾èµ–äº†å“ªäº›æ•°æ®(ä¾èµ–æ”¶é›†)ã€‚
3. æ•°æ®å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨é€šçŸ¥å’Œæ•°æ®ç›¸å…³è”çš„è§†å›¾é¡µé¢ï¼Œå¹¶å¯¹è§†å›¾è¿›è¡Œæ›´æ–°ã€‚

1. åˆ©ç”¨Proxyæˆ–Object.definePropertyç”Ÿæˆçš„Observeré’ˆå¯¹å¯¹è±¡/å¯¹è±¡çš„å±æ€§è¿›è¡Œ"åŠ«æŒ"ï¼Œåœ¨å±æ€§å‘ç”Ÿå˜åŒ–åé€šçŸ¥è®¢é˜…è€…ï¼›
2. è§£æå™¨Compilerè§£ææ¨¡æ¿ä¸­çš„Directive(æŒ‡ä»¤)ï¼Œæ”¶é›†æŒ‡ä»¤æ‰€ä¾èµ–çš„æ–¹æ³•å’Œæ•°æ®ï¼Œç­‰å¾…æ•°æ®å˜åŒ–ç„¶åè¿›è¡Œæ¸²æŸ“ï¼›
3. Watcherå±äºObserverå’ŒCompileæ¡¥æ¢ï¼Œå®ƒå°†æ¥æ”¶åˆ°çš„Observeräº§ç”Ÿçš„æ•°æ®å˜åŒ–ï¼Œå¹¶æ ¹æ®Compileræä¾›çš„æŒ‡ä»¤è¿›è¡Œè§†å›¾æ¸²æŸ“ï¼Œä½¿å¾—æ•°æ®å˜åŒ–ä¿ƒä½¿è§†å›¾å˜åŒ–ã€‚
### å¦‚ä½•ç›‘å¬å¯¹è±¡æ•°æ®çš„å˜åŒ–ï¼Ÿ
å¯¹è±¡æ•°æ®ç›‘å¬ä¹Ÿå«åš**æ•°æ®åŠ«æŒ**ï¼ŒVueé‡‡ç”¨**æ•°æ®åŠ«æŒåŠå‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼**ï¼Œé€šè¿‡Object.definePropertyæ¥åŠ«æŒå„ä¸ªå±æ€§çš„setterï¼Œgetterã€‚åœ¨æ•°æ®å˜åŒ–æ—¶å‘é€æ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ES6ä¸­çš„Proxyæ¥å¯¹å„ä¸ªå±æ€§è¿›è¡Œä»£ç†(æ¨è)ã€‚
## å“åº”å¼ä»£ç å®ç°
åœ¨ES5ä¸­ï¼Œæ–°å¢äº†Object.definePropertyè¿™ä¸ªAPIï¼Œå…è®¸æˆ‘ä»¬ä¸ºå¯¹è±¡çš„å±æ€§è®¾å®šgetterå’Œsetterã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥APIå¯¹è¯¥å¯¹è±¡çš„å±æ€§å€¼è·å–æˆ–è®¾ç½®è¿›è¡ŒåŠ«æŒã€‚
```js
// Vue2.0å¦‚ä½•å®ç°å“åº”å¼åŸç†
// æ•°æ®å˜åŒ–äº†ï¼Œå¯ä»¥æ›´æ–°è§†å›¾
function observer(target) {
    // åˆ¤æ–­targetæ˜¯å¦ä¸ºå¯¹è±¡
    if (typeof target !== 'object' || target == null) {
        return target;
    }
    for (const key in target) {
        if (target.hasOwnProperty(key)) {
            // å®šä¹‰å“åº”å¼
            defineReactive(target, key, target[key]);
        }
    }
}

function defineReactive(target, key, value) {
    Object.defineProperty(target, key, {
        get() {
            return value;
        },
        set(newValue) {
            if (newValue !== value) {
                updateView();
                value = newValue;
            }
        }
    });
}

function updateView() {
    console.log('æ•°æ®æ›´æ–°äº†');
}

// åªæ˜¯ä¸€å±‚
const person = {name: 'kobe'};
observer(person);
person.name = 'james';
console.log(person.name);
```
æ³¨æ„ç‚¹1ï¼šé’ˆå¯¹keyçš„valueä¹Ÿæ˜¯å¯¹è±¡çš„æƒ…å†µ(éœ€è¦é€’å½’è¿›è¡Œç»‘å®š)ã€‚
```js
// Vue2.0å¦‚ä½•å®ç°å“åº”å¼åŸç†
// æ•°æ®å˜åŒ–äº†ï¼Œå¯ä»¥æ›´æ–°è§†å›¾
function observer(target) {
    if (typeof target !== 'object' || target == null) {
        return target;
    }
    for (const key in target) {
        if (target.hasOwnProperty(key)) {
            defineReactive(target, key, target[key]);
        }
    }
}

function defineReactive(target, key, value) {
    // æ³¨æ„ç‚¹1ï¼šé’ˆå¯¹keyçš„valueæ˜¯å¯¹è±¡çš„æƒ…å†µï¼Œé€’å½’éå†å­å¯¹è±¡
    observer(value);
    Object.defineProperty(target, key, {
        get() {
            return value;
        },
        set(newValue) {
            if (newValue !== value) {
                updateView();
                value = newValue;
            }
        }
    });
}

function updateView() {
    console.log('æ•°æ®æ›´æ–°äº†');
}

const person = {name: 'kobe', age: {value: 12}};
observer(person);
// person.name = 'james';
person.age.value = 14;
console.log(person.age.value);
```
æ³¨æ„ç‚¹2ï¼šé’ˆå¯¹ç»™key**é‡æ–°èµ‹å€¼**çš„valueæ˜¯å¯¹è±¡çš„æƒ…å†µã€‚
```js
// Vue2.0å¦‚ä½•å®ç°å“åº”å¼åŸç†
// æ•°æ®å˜åŒ–äº†ï¼Œå¯ä»¥æ›´æ–°è§†å›¾
function observer(target) {
    if (typeof target !== 'object' || target == null) {
        return target;
    }
    for (const key in target) {
        if (target.hasOwnProperty(key)) {
            defineReactive(target, key, target[key]);
        }
    }
}

function defineReactive(target, key, value) {
    // æ³¨æ„ç‚¹1ï¼šé’ˆå¯¹keyçš„valueæ˜¯å¯¹è±¡çš„æƒ…å†µï¼Œé€’å½’
    observer(value);
    Object.defineProperty(target, key, {
        get() {
            return value;
        },
        set(newValue) {
            // æ³¨æ„ç‚¹2ï¼šé’ˆå¯¹ç»™keyé‡æ–°èµ‹å€¼çš„valueæ˜¯å¯¹è±¡çš„æƒ…å†µï¼Œå¦‚æœæ–°å€¼æ˜¯å¯¹è±¡çš„è¯ï¼Œé€’å½’è¯¥å¯¹è±¡è¿›è¡Œç›‘å¬
            observer(newValue);
            if (newValue !== value) {
                updateView();
                value = newValue;
            }
        }
    });
}

function updateView() {
    console.log('æ•°æ®æ›´æ–°äº†');
}

const person = {name: 'kobe', age: {value: 12}};
observer(person);
person.age = {value: 13};
person.age.value = 16;
// åº”è¯¥è¾“å‡ºä¸¤æ¬¡'æ•°æ®æ›´æ–°äº†'ï¼Œå› ä¸ºageå’Œvalueéƒ½æ˜¯å“åº”å¼çš„
console.log(person.age.value);
```
![](https://github.com/liujie2019/static_data/blob/master/img/20200105120128.png?raw=true)

## Object.definePropertyçš„ç¼ºé™·
é—®é¢˜ï¼š
1. å¯¹äºå¯¹è±¡æ–°å¢çš„å±æ€§å°†ä¸ä¼šæ˜¯å“åº”å¼çš„
2. ä¸æ”¯æŒå±æ€§å€¼æ˜¯æ•°ç»„çš„æƒ…å†µ
## å®ç°æ•°ç»„åŠ«æŒ
```js
// Vue2.0å¦‚ä½•å®ç°å“åº”å¼åŸç†
// æ•°æ®å˜åŒ–äº†ï¼Œå¯ä»¥æ›´æ–°è§†å›¾
const oldArrayPrototype = Array.prototype;
const proto = Object.create(oldArrayPrototype); // ç»§æ‰¿æ•°ç»„åŸå‹çš„æ–¹æ³•
['push', 'shift', 'unshift'].forEach(method => {
    // å‡½æ•°åŠ«æŒï¼ŒæŠŠå‡½æ•°è¿›è¡Œé‡å†™ï¼Œå†…éƒ¨ç»§ç»­è°ƒç”¨è€çš„æ•°ç»„æ–¹æ³•
    proto[method] = function() {
        updateView(); // é¢å‘åˆ‡ç‰‡ç¼–ç¨‹
        oldArrayPrototype[method].call(this, ...arguments);
    }
});
function observer(target) {
    if (typeof target !== 'object' || target == null) {
        return target;
    }
    if (Array.isArray(target)) { // æ‹¦æˆªæ•°ç»„ï¼Œå°†æ•°ç»„çš„æ–¹æ³•è¿›è¡Œé‡å†™
        Object.setPrototypeOf(target, proto);
        // target.__proto__ = proto;
    }
    for (const key in target) {
        if (target.hasOwnProperty(key)) {
            defineReactive(target, key, target[key]);
        }
    }
}

function defineReactive(target, key, value) {
    // æ³¨æ„ç‚¹1ï¼šé’ˆå¯¹keyçš„valueæ˜¯å¯¹è±¡çš„æƒ…å†µï¼Œé€’å½’
    observer(value);
    Object.defineProperty(target, key, {
        get() { // getä¸­è¿›è¡Œä¾èµ–æ”¶é›†
            return value;
        },
        set(newValue) {
            // æ³¨æ„ç‚¹2ï¼šé’ˆå¯¹ç»™keyé‡æ–°èµ‹å€¼çš„valueæ˜¯å¯¹è±¡çš„æƒ…å†µ
            observer(newValue);
            if (newValue !== value) {
                updateView();
                value = newValue;
            }
        }
    });
}

function updateView() {
    console.log('æ•°æ®æ›´æ–°äº†');
}

const person = {name: 'kobe', hobbies: ['ğŸ€', 'âš½ï¸']};
observer(person);
person.hobbies.push('ğŸ‰'); // éœ€è¦å¯¹æ•°ç»„çš„æ–¹æ³•è¿›è¡Œé‡å†™
```
## ä½¿ç”¨Proxyæ¥å®ç°æ•°æ®åŠ«æŒ
Object.definePropertyæ–¹æ³•å­˜åœ¨å¦‚ä¸‹ç¼ºç‚¹ï¼š
1. ç›‘å¬æ•°ç»„çš„æ–¹æ³•ä¸èƒ½è§¦å‘Object.definePropertyæ–¹æ³•ä¸­setæ“ä½œ(å¦‚æœæˆ‘ä»¬éœ€è¦ç›‘å¬çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™æ•°ç»„çš„æ–¹æ³•)ã€‚
2. å¿…é¡»éå†æ¯ä¸ªå¯¹è±¡çš„æ¯ä¸ªå±æ€§ï¼Œå¦‚æœå¯¹è±¡åµŒå¥—æ¯”è¾ƒæ·±çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦é€’å½’è°ƒç”¨ã€‚
3.
## å‚è€ƒæ–‡æ¡£
1. [æ·±å…¥ç†è§£Vueå“åº”å¼åŸç†](https://funteas.com/topic/5a809f5847dc830a0e4690c2)
2. [vueç³»åˆ—---å“åº”å¼åŸç†å®ç°åŠObserveræºç è§£æ(ä¸ƒ)](https://www.cnblogs.com/tugenhua0707/p/11754291.html)
3. [æ·±å…¥ç†è§£ Object.defineProperty åŠå®ç°æ•°æ®åŒå‘ç»‘å®š](https://www.cnblogs.com/tugenhua0707/p/10261170.html)